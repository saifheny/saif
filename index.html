<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VoiceConnect Elite V3</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --bg-glass: rgba(30, 30, 30, 0.85);
            --primary: #7c4dff; 
            --accent: #00e5ff;
            --danger: #ff4081;
            --success: #00e676;
            --text: #ffffff;
            --text-sub: #b0b0b0;
            --border: rgba(255, 255, 255, 0.08);
            --radius: 24px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            background: var(--bg-dark);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .bg-fx { position: absolute; width: 100%; height: 100%; z-index: -1; overflow: hidden; background: radial-gradient(circle at 50% 120%, #1a103c, #000); }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; animation: move 20s infinite alternate; }
        .b1 { width: 400px; height: 400px; background: var(--primary); top: -10%; left: -10%; }
        .b2 { width: 300px; height: 300px; background: var(--danger); bottom: -10%; right: -10%; animation-delay: -5s; }
        @keyframes move { 0% { transform: translate(0,0); } 100% { transform: translate(30px, 50px); } }

        .app-container {
            width: 100%; height: 100%;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            transition: 0.4s ease;
        }

        @media (min-width: 768px) {
            .app-container {
                width: 420px; height: 85vh;
                border-radius: var(--radius);
                border: 1px solid var(--border);
            }
            .app-container.expanded { width: 900px; }
        }

        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 25px;
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none;
            transform: translateY(20px) scale(0.95);
            transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .view.active { opacity: 1; pointer-events: all; transform: translateY(0) scale(1); z-index: 10; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .title { font-size: 1.5rem; font-weight: 900; background: linear-gradient(to right, #fff, var(--text-sub)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .user-chip { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 5px 15px 5px 5px; border-radius: 50px; border: 1px solid var(--border); }
        .user-chip img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }

        /* Inputs & Forms */
        .inp-group { margin-bottom: 15px; }
        .inp {
            width: 100%; background: rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            padding: 15px; border-radius: 16px;
            color: white; font-size: 1rem; transition: 0.3s;
        }
        .inp:focus { border-color: var(--primary); background: rgba(124, 77, 255, 0.05); }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 18px;
            background: linear-gradient(135deg, var(--primary), #5e35b1);
            color: white; font-weight: bold; font-size: 1rem; cursor: pointer;
            box-shadow: 0 8px 20px rgba(124, 77, 255, 0.3);
            transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn:active { transform: scale(0.96); }
        .btn.sec { background: transparent; border: 1px solid var(--border); box-shadow: none; margin-top: 10px; }

        /* Step 2 Specifics */
        .photo-upload {
            width: 120px; height: 120px; margin: 0 auto 20px;
            border-radius: 50%; background: rgba(255,255,255,0.05);
            border: 2px dashed rgba(255,255,255,0.2);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; overflow: hidden; position: relative;
        }
        .photo-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .policy-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 16px; margin-bottom: 20px; font-size: 0.8rem; color: var(--text-sub); line-height: 1.5; }
        .chk-wrap { display: flex; gap: 10px; align-items: center; margin-top: 10px; cursor: pointer; }
        .chk-box { width: 20px; height: 20px; border: 2px solid var(--text-sub); border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .chk-wrap input:checked + .chk-box { background: var(--primary); border-color: var(--primary); }

        /* Dashboard */
        .dash-tabs { display: flex; gap: 10px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 16px; }
        .tab { flex: 1; text-align: center; padding: 10px; border-radius: 12px; cursor: pointer; font-size: 0.9rem; color: var(--text-sub); transition: 0.3s; }
        .tab.active { background: rgba(255,255,255,0.1); color: white; font-weight: bold; }
        
        .action-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            padding: 20px; border-radius: 20px; margin-bottom: 15px;
            display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.3s;
        }
        .action-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .ac-icon { width: 50px; height: 50px; border-radius: 14px; background: rgba(124, 77, 255, 0.15); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--primary); }

        /* Friends List */
        .friend-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .friend-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); padding: 10px 15px; border-radius: 14px; }
        .f-info { display: flex; align-items: center; gap: 10px; }
        .f-info img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .f-btn { width: 35px; height: 35px; border-radius: 10px; border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .f-btn.call { background: var(--success); }
        .f-btn:hover { transform: scale(1.1); }

        /* Call Room Grid */
        .room-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 Per Row */
            gap: 10px;
            overflow-y: auto;
            padding-bottom: 120px; /* Space for controls */
            align-content: start;
            flex: 1;
        }

        .user-card {
            position: relative; aspect-ratio: 1;
            background: rgba(0,0,0,0.3); border-radius: 18px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden; border: 1px solid transparent; transition: 0.3s;
        }
        .user-card img { width: 60%; aspect-ratio: 1; border-radius: 50%; object-fit: cover; margin-bottom: 5px; border: 2px solid transparent; }
        .user-card span { font-size: 0.8rem; font-weight: bold; text-align: center; max-width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-card.speaking { border-color: var(--success); box-shadow: inset 0 0 20px rgba(0, 230, 118, 0.2); }
        .user-card.speaking img { border-color: var(--success); transform: scale(1.1); }
        .user-card.muted img { filter: grayscale(1); opacity: 0.6; }

        /* Overlays on User Card */
        .card-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(3px);
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 8px;
            opacity: 0; transition: 0.2s;
        }
        .user-card:hover .card-overlay { opacity: 1; }
        .ov-btn { width: 30px; height: 30px; border-radius: 8px; border: none; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        .ov-add { background: var(--primary); }
        .ov-kick { background: var(--danger); }
        .ov-mute { background: #fbc02d; }

        /* Bottom Controls */
        .controls-area {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: 100px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            display: flex; justify-content: center; align-items: center; gap: 15px;
            padding-bottom: 20px; z-index: 20;
        }
        .ctrl-btn { width: 55px; height: 55px; border-radius: 20px; border: none; font-size: 1.3rem; color: white; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
        .ctrl-btn:hover { transform: translateY(-5px); background: rgba(255,255,255,0.2); }
        .ctrl-btn.end { background: rgba(255, 64, 129, 0.2); color: var(--danger); }
        .ctrl-btn.end:hover { background: var(--danger); color: white; }
        .ctrl-btn.active { background: white; color: black; }
        .ctrl-btn.locked { background: #333; color: #777; cursor: not-allowed; }

        /* React Bar (Creative Point) */
        .react-bar {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 30px;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .react-bar.show { opacity: 1; pointer-events: all; bottom: 110px; }
        .r-emoji { font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
        .r-emoji:hover { transform: scale(1.5); }
        .flying-emoji { position: absolute; font-size: 3rem; pointer-events: none; animation: flyUp 1.5s forwards; z-index: 50; }
        @keyframes flyUp { 0% { transform: translateY(0) scale(0.5); opacity: 1; } 100% { transform: translateY(-200px) scale(1.5); opacity: 0; } }

        /* Modals & Toasts */
        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px); }
        .modal-wrap.show { opacity: 1; pointer-events: all; }
        .modal-box { width: 85%; max-width: 320px; background: #151515; border: 1px solid var(--border); border-radius: 24px; padding: 25px; text-align: center; transform: scale(0.8); transition: 0.3s; }
        .modal-wrap.show .modal-box { transform: scale(1); }
        .modal-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 3px solid var(--primary); }

        .toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #222; border: 1px solid var(--border); padding: 12px 25px; border-radius: 50px; display: flex; align-items: center; gap: 10px; z-index: 200; transition: 0.5s; width: max-content; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* Status Indicators */
        .mic-badge { position: absolute; bottom: 5px; right: 5px; width: 20px; height: 20px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: white; }
        .mic-badge.off { color: var(--danger); }
        .notif-badge { width: 20px; height: 20px; background: var(--danger); color: white; border-radius: 50%; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; position: absolute; top: -5px; right: -5px; }

        canvas { display: none; }
    </style>
</head>
<body>

    <div class="bg-fx">
        <div class="blob b1"></div>
        <div class="blob b2"></div>
    </div>

    <div class="app-container" id="app">
        
        <!-- STEP 1: Name -->
        <div class="view active" id="v-name">
            <h2 class="title" style="margin-top: 50px;">VoiceConnect</h2>
            <p style="color:var(--text-sub); margin-bottom: 40px;">Ø§Ù„Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„ØµÙˆØªÙŠ</p>
            
            <div class="inp-group">
                <input type="text" id="fname" class="inp" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„">
            </div>
            <div class="inp-group">
                <input type="text" id="lname" class="inp" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©">
            </div>
            <button class="btn" onclick="toStep2()">Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i></button>
        </div>

        <!-- STEP 2: Photo & Policy -->
        <div class="view" id="v-photo">
            <h2 class="title">Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</h2>
            <div class="photo-upload">
                <i class="fas fa-camera" id="cam-icon" style="font-size:2rem; opacity:0.5"></i>
                <img id="preview-img" src="">
                <input type="file" id="f-upl" hidden accept="image/*">
            </div>
            <canvas id="compressor"></canvas>

            <div class="policy-box">
                Ù†Ø­Ù† Ù†Ù‡ØªÙ… Ø¨Ø®ØµÙˆØµÙŠØªÙƒ. Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ Ø£Ù†Øª ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ø­ØªØ±Ø§Ù… Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† ÙˆØ¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ù„ÙØ§Ø¸ Ù…Ø³ÙŠØ¦Ø©. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠØªÙ… Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§.
                <label class="chk-wrap">
                    <input type="checkbox" id="policy-chk" hidden>
                    <div class="chk-box"><i class="fas fa-check" style="font-size:0.7rem; color:white"></i></div>
                    <span>Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ·</span>
                </label>
            </div>

            <button class="btn" onclick="finishReg()">Ø¯Ø®ÙˆÙ„ <i class="fas fa-sign-in-alt"></i></button>
            <button class="btn sec" onclick="showView('v-name')">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <!-- DASHBOARD -->
        <div class="view" id="v-dash">
            <div class="header">
                <div>
                    <h2 class="title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
                    <span style="font-size:0.8rem; color:var(--success)">â— Ù…ØªØµÙ„</span>
                </div>
                <div class="user-chip">
                    <img id="d-img" src="">
                    <span id="d-name" style="font-size:0.85rem; font-weight:bold"></span>
                </div>
            </div>

            <div class="dash-tabs">
                <div class="tab active" onclick="switchTab('home')" id="tab-home">Ù…ÙƒØ§Ù„Ù…Ø©</div>
                <div class="tab" onclick="switchTab('friends')" id="tab-friends" style="position:relative">
                    Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
                    <div id="friend-badge" class="notif-badge" style="display:none">0</div>
                </div>
            </div>

            <!-- Home Tab -->
            <div id="content-home">
                <div class="action-card" onclick="startCall('group')">
                    <div class="ac-icon"><i class="fas fa-microphone-alt"></i></div>
                    <div>
                        <h3>Ø¨Ø¯Ø¡ Ù…ÙƒØ§Ù„Ù…Ø©</h3>
                        <span style="font-size:0.8rem; color:var(--text-sub)">Ø£Ù†Ø´Ø¦ ØºØ±ÙØ© ÙˆØ§Ø¯Ø¹Ù Ø§Ù„Ø¬Ù…ÙŠØ¹</span>
                    </div>
                </div>
                <div id="active-sess" style="display:none; padding:15px; background:rgba(124,77,255,0.1); border:1px solid var(--primary); border-radius:18px; text-align:center; cursor:pointer; margin-top:20px;" onclick="rejoin()">
                    <span style="color:var(--primary); font-weight:bold;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ø¬Ø§Ø±ÙŠØ© <i class="fas fa-undo"></i></span>
                </div>
            </div>

            <!-- Friends Tab -->
            <div id="content-friends" style="display:none; height: 100%; display: flex; flex-direction: column;">
                <div style="margin-bottom:10px; font-size:0.9rem; color:var(--text-sub)" id="req-header">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</div>
                <div id="req-list" style="margin-bottom:20px; display:flex; flex-direction:column; gap:8px;"></div>
                
                <div style="margin-bottom:10px; font-size:0.9rem; color:var(--text-sub)">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</div>
                <div class="friend-list" id="friend-list">
                    <!-- Friends inserted here -->
                </div>
            </div>
        </div>

        <!-- WAITING -->
        <div class="view" id="v-wait">
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
                <img id="w-host-img" src="" style="width:100px; height:100px; border-radius:50%; margin-bottom:20px; border:3px solid var(--border);">
                <h3 id="w-host-name"></h3>
                <p style="color:var(--text-sub); margin-bottom:30px;">ÙŠØ¯Ø¹ÙˆÙƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…...</p>
                <div style="width:40px; height:40px; border:4px solid rgba(255,255,255,0.1); border-top-color:var(--primary); border-radius:50%; animation:spin 1s infinite linear;"></div>
            </div>
            <button class="btn sec" onclick="leaveRoom(false)">Ø¥Ù„ØºØ§Ø¡</button>
        </div>

        <!-- ROOM -->
        <div class="view" id="v-room">
            <div class="header">
                <div style="background:rgba(255,255,255,0.1); padding:5px 12px; border-radius:20px; font-family:monospace; font-weight:bold" id="timer">00:00</div>
                <div style="display:flex; gap:10px;">
                    <button class="ctrl-btn" style="width:40px; height:40px; font-size:1rem;" onclick="copyLnk()"><i class="fas fa-link"></i></button>
                    <button class="ctrl-btn" style="width:40px; height:40px; font-size:1rem; position:relative;" onclick="toggleReqList()" id="btn-host-req" style="display:none">
                        <i class="fas fa-user-clock"></i>
                        <div id="room-req-badge" class="notif-badge" style="display:none"></div>
                    </button>
                </div>
            </div>

            <div class="room-grid" id="grid">
                <!-- Users -->
            </div>
            
            <!-- React Bar -->
            <div class="react-bar" id="react-bar">
                <span class="r-emoji" onclick="sendReact('â¤ï¸')">â¤ï¸</span>
                <span class="r-emoji" onclick="sendReact('ğŸ˜‚')">ğŸ˜‚</span>
                <span class="r-emoji" onclick="sendReact('ğŸ˜®')">ğŸ˜®</span>
                <span class="r-emoji" onclick="sendReact('ğŸ‘')">ğŸ‘</span>
            </div>

            <div class="controls-area">
                <button class="ctrl-btn" onclick="toggleReacts()"><i class="fas fa-smile"></i></button>
                <button class="ctrl-btn" id="mic-btn" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
                <button class="ctrl-btn end" onclick="endSession()"><i class="fas fa-phone-slash"></i></button>
            </div>
        </div>

    </div>

    <!-- GLOBAL MODAL -->
    <div class="modal-wrap" id="modal">
        <div class="modal-box">
            <img id="m-img" class="modal-img" src="" style="display:none">
            <div id="m-icon" style="font-size:3rem; margin-bottom:15px; color:var(--primary)"></div>
            <h3 id="m-title" style="margin-bottom:10px;"></h3>
            <p id="m-text" style="color:var(--text-sub); font-size:0.9rem; margin-bottom:20px;"></p>
            <div id="m-btns" style="display:flex; gap:10px; justify-content:center;"></div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast">
        <i id="t-icon" class="fas fa-info-circle" style="color:var(--primary)"></i>
        <span id="t-msg" style="font-weight:bold; font-size:0.9rem;"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, push, get, child, onDisconnect } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
            authDomain: "story-97cf7.firebaseapp.com",
            databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
            projectId: "story-97cf7",
            storageBucket: "story-97cf7.firebasestorage.app",
            messagingSenderId: "742801388214",
            appId: "1:742801388214:web:32a305a8057b0582c5ec17",
            measurementId: "G-9DPPWX7CF0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- STATE ---
        let user = JSON.parse(localStorage.getItem('vc3_user')) || { fname:'', lname:'', img:'' };
        let activeCall = localStorage.getItem('vc3_call');
        let localStream = null;
        let peers = {};
        let isHost = false;
        let pendingRequests = []; // For Host
        let timerInt;
        let audioCtx;
        let myMuteStatus = false;

        // --- UTILS ---
        const $ = id => document.getElementById(id);
        const showView = id => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            $(id).classList.add('active');
            if(id === 'v-room') $('app').classList.add('expanded');
            else $('app').classList.remove('expanded');
        };
        const toast = (msg, icon='info-circle', col='var(--primary)') => {
            $('t-msg').innerText = msg;
            $('t-icon').className = `fas fa-${icon}`;
            $('t-icon').style.color = col;
            $('toast').classList.add('show');
            setTimeout(() => $('toast').classList.remove('show'), 3000);
        };
        const modal = (title, text, btns, icon=null, img=null) => {
            $('m-title').innerText = title;
            $('m-text').innerText = text;
            $('m-btns').innerHTML = btns;
            $('m-icon').style.display = icon ? 'block' : 'none';
            if(icon) $('m-icon').innerHTML = icon;
            $('m-img').style.display = img ? 'block' : 'none';
            if(img) $('m-img').src = img;
            $('modal').classList.add('show');
        };
        window.closeModal = () => $('modal').classList.remove('show');

        // --- SOUNDS ---
        function playSfx(type) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            if(type==='pop') { o.frequency.value=600; g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1); o.start(); o.stop(audioCtx.currentTime+0.1); }
            if(type==='ring') { o.frequency.value=400; g.gain.value=0.1; o.start(); o.frequency.linearRampToValueAtTime(800, audioCtx.currentTime+0.5); o.stop(audioCtx.currentTime+0.5); }
        }

        // --- AUTH ---
        window.toStep2 = () => {
            if(!$('fname').value || !$('lname').value) return toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'exclamation-triangle', 'var(--danger)');
            user.fname = $('fname').value; user.lname = $('lname').value;
            showView('v-photo');
        };
        
        $('photo-upload').onclick = () => $('f-upl').click();
        $('f-upl').onchange = e => {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = ev => {
                    const i = new Image();
                    i.onload = () => {
                        const c = $('compressor'); const x = c.getContext('2d');
                        c.width=100; c.height=100; x.drawImage(i,0,0,100,100);
                        user.img = c.toDataURL('image/jpeg', 0.6);
                        $('preview-img').src = user.img; $('preview-img').style.display='block'; $('cam-icon').style.display='none';
                    };
                    i.src = ev.target.result;
                };
                r.readAsDataURL(f);
            }
        };

        window.finishReg = () => {
            if(!user.img || !$('policy-chk').checked) return toast('Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø·Ù„ÙˆØ¨Ø©', 'ban', 'var(--danger)');
            if(!user.id) user.id = 'u_' + Date.now().toString(36);
            localStorage.setItem('vc3_user', JSON.stringify(user));
            set(ref(db, `users/${user.id}`), user);
            
            const params = new URLSearchParams(location.search);
            if(params.get('call')) checkJoin(params.get('call'));
            else initDash();
        };

        // --- DASHBOARD & FRIENDS ---
        function initDash() {
            $('d-name').innerText = user.fname; $('d-img').src = user.img;
            showView('v-dash');
            switchTab('home'); // Default
            if(activeCall) {
                get(ref(db, `calls/${activeCall}`)).then(s => {
                    if(s.exists()) $('active-sess').style.display='block';
                    else localStorage.removeItem('vc3_call');
                });
            }
            listenForFriends();
            listenForIncomingCalls();
        }

        window.switchTab = (t) => {
            if(t==='home') {
                $('content-home').style.display = 'block';
                $('content-friends').style.display = 'none';
                $('tab-home').classList.add('active'); $('tab-friends').classList.remove('active');
            } else {
                $('content-home').style.display = 'none';
                $('content-friends').style.display = 'flex';
                $('tab-home').classList.remove('active'); $('tab-friends').classList.add('active');
            }
        };

        function listenForFriends() {
            // Pending Requests
            onValue(ref(db, `users/${user.id}/requests`), s => {
                const reqs = s.val() || {};
                const list = $('req-list'); list.innerHTML = '';
                const keys = Object.keys(reqs);
                $('friend-badge').style.display = keys.length ? 'flex' : 'none';
                $('friend-badge').innerText = keys.length;
                $('req-header').style.display = keys.length ? 'block' : 'none';

                keys.forEach(uid => {
                    get(ref(db, `users/${uid}`)).then(uSnap => {
                        const u = uSnap.val();
                        list.innerHTML += `
                        <div class="friend-item">
                            <div class="f-info"><img src="${u.img}"><span>${u.fname}</span></div>
                            <div style="display:flex; gap:5px">
                                <button class="f-btn call" onclick="ansFriend('${uid}', true)"><i class="fas fa-check"></i></button>
                                <button class="f-btn" style="background:var(--danger)" onclick="ansFriend('${uid}', false)"><i class="fas fa-times"></i></button>
                            </div>
                        </div>`;
                    });
                });
            });

            // Friends List
            onValue(ref(db, `users/${user.id}/friends`), s => {
                const fr = s.val() || {};
                const list = $('friend-list'); list.innerHTML = '';
                Object.keys(fr).forEach(uid => {
                    get(ref(db, `users/${uid}`)).then(uSnap => {
                        const u = uSnap.val();
                        list.innerHTML += `
                        <div class="friend-item">
                            <div class="f-info"><img src="${u.img}"><span>${u.fname}</span></div>
                            <button class="f-btn call" onclick="callFriend('${uid}')"><i class="fas fa-phone"></i></button>
                        </div>`;
                    });
                });
            });
        }

        window.sendFriendReq = (targetId) => {
            set(ref(db, `users/${targetId}/requests/${user.id}`), true);
            toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø©', 'check');
        };

        window.ansFriend = (uid, acc) => {
            remove(ref(db, `users/${user.id}/requests/${uid}`));
            if(acc) {
                set(ref(db, `users/${user.id}/friends/${uid}`), true);
                set(ref(db, `users/${uid}/friends/${user.id}`), true);
                toast('Ø£ØµØ¨Ø­ØªÙ…Ø§ Ø£ØµØ¯Ù‚Ø§Ø¡!', 'user-friends', 'var(--success)');
            }
        };

        window.callFriend = (uid) => {
            // Create a call and invite friend
            const cid = Date.now().toString(36);
            startCall(null, cid); // Start host logic
            // Send invite signal
            set(ref(db, `users/${uid}/incoming_call`), {
                from: user.id, callId: cid, name: user.fname, img: user.img
            });
            toast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...', 'phone-alt');
        };

        function listenForIncomingCalls() {
            onValue(ref(db, `users/${user.id}/incoming_call`), s => {
                const d = s.val();
                if(d) {
                    playSfx('ring');
                    modal('Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ§Ø±Ø¯Ø©', `${d.name} ÙŠØªØµÙ„ Ø¨Ùƒ...`,
                    `<button class="btn sec" style="width:auto" onclick="rejectCall()">Ø±ÙØ¶</button>
                     <button class="btn" style="width:auto; background:var(--success)" onclick="acceptCall('${d.callId}')">Ø±Ø¯</button>`,
                     null, d.img);
                } else closeModal();
            });
        }

        window.rejectCall = () => {
            remove(ref(db, `users/${user.id}/incoming_call`));
            closeModal();
        };
        window.acceptCall = (cid) => {
            remove(ref(db, `users/${user.id}/incoming_call`));
            closeModal();
            checkJoin(cid);
        };

        // --- CALL LOGIC ---
        window.rejoin = () => checkJoin(activeCall, true);

        window.startCall = (type, forcedId=null) => {
            const cid = forcedId || Date.now().toString(36);
            activeCall = cid;
            isHost = true;
            localStorage.setItem('vc3_call', cid);
            
            set(ref(db, `calls/${cid}`), { host: user.id, status: 'active' });
            // Host auto join
            set(ref(db, `calls/${cid}/participants/${user.id}`), {
                info: user, status: 'joined', mutedByHost: false
            }).then(() => enterRoom());
        };

        function checkJoin(cid, isRejoin=false) {
            activeCall = cid;
            localStorage.setItem('vc3_call', cid);
            get(ref(db, `calls/${cid}`)).then(s => {
                if(!s.exists()) { localStorage.removeItem('vc3_call'); return toast('Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù†ØªÙ‡Øª', 'phone-slash'); }
                const d = s.val();
                isHost = (d.host === user.id);
                
                if(isHost || isRejoin) {
                     // Check if kicked
                     get(ref(db, `calls/${cid}/participants/${user.id}/status`)).then(st => {
                         if(st.val() === 'kicked') kickScreen();
                         else enterRoom();
                     });
                } else {
                    // Waiting Room
                    get(ref(db, `users/${d.host}`)).then(h => {
                        $('w-host-name').innerText = h.val().fname; $('w-host-img').src = h.val().img;
                        showView('v-wait');
                    });
                    set(ref(db, `calls/${cid}/participants/${user.id}`), { info: user, status: 'waiting' });
                    
                    onValue(ref(db, `calls/${cid}/participants/${user.id}/status`), sn => {
                        const val = sn.val();
                        if(val === 'joined') enterRoom();
                        if(val === 'kicked') kickScreen();
                    });
                }
            });
        }

        async function enterRoom() {
            showView('v-room');
            startTimer();
            if(isHost) $('btn-host-req').style.display='block';

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                detectSound(user.id, localStream);
            } catch(e) { toast('Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ† ØºÙŠØ± Ù…ØªØ§Ø­', 'microphone-slash', 'var(--danger)'); }

            addCard(user.id, user, true);

            // Listen to room events
            onValue(ref(db, `calls/${activeCall}`), callSnap => {
                if(!callSnap.exists()) { leaveRoom(true); return; } // Host ended call
            });

            onValue(ref(db, `calls/${activeCall}/participants`), s => {
                const parts = s.val() || {};
                // Clear left users
                document.querySelectorAll('.user-card').forEach(c => {
                    const uid = c.id.replace('c-', '');
                    if(!parts[uid] || parts[uid].status !== 'joined') {
                        c.remove();
                        if(peers[uid]) { peers[uid].close(); delete peers[uid]; }
                    }
                });

                // Pending requests logic
                pendingRequests = [];
                Object.keys(parts).forEach(uid => {
                    const p = parts[uid];
                    if(isHost && p.status === 'waiting') pendingRequests.push({id: uid, ...p.info});
                    
                    if(p.status === 'joined') {
                        if(!document.getElementById(`c-${uid}`)) {
                            addCard(uid, p.info, uid === user.id);
                            if(uid !== user.id) connectPeer(uid);
                        }
                        // Handle Remote Mute Status (Visual)
                        const card = $(`c-${uid}`);
                        if(p.mutedByHost) card.classList.add('muted');
                        else card.classList.remove('muted');

                        // Handle MY Mute Status (Logic)
                        if(uid === user.id && p.mutedByHost && !myMuteStatus) {
                            // I was just muted by host
                            forceMuteLocally(true);
                            toast('Ù‚Ø§Ù… Ø§Ù„Ù…Ø¶ÙŠÙ Ø¨ÙƒØªÙ… ØµÙˆØªÙƒ', 'microphone-slash', 'var(--danger)');
                        }
                    }
                    if(uid === user.id && p.status === 'kicked') kickScreen();
                });
                
                updateHostBadge();
            });

            // Listen for Reactions
            onDisconnect(ref(db, `calls/${activeCall}/participants/${user.id}`)).remove();
            
            child(ref(db, `calls/${activeCall}`), 'reacts').on('child_added', s => {
                const r = s.val();
                if(Date.now() - r.ts < 3000) showFlyingEmoji(r.emoji);
            });
        }

        function addCard(uid, info, isMe) {
            if($(`c-${uid}`)) return;
            const d = document.createElement('div');
            d.className = 'user-card'; d.id = `c-${uid}`;
            
            let overlay = '';
            if(isHost && !isMe) {
                overlay = `
                <div class="card-overlay">
                    <button class="ov-btn ov-mute" onclick="hostMute('${uid}')"><i class="fas fa-microphone-slash"></i></button>
                    <button class="ov-btn ov-kick" onclick="hostKick('${uid}')"><i class="fas fa-ban"></i></button>
                    <button class="ov-btn ov-add" onclick="sendFriendReq('${uid}')"><i class="fas fa-user-plus"></i></button>
                </div>`;
            } else if (!isMe) {
                overlay = `<div class="card-overlay"><button class="ov-btn ov-add" onclick="sendFriendReq('${uid}')"><i class="fas fa-user-plus"></i></button></div>`;
            }

            d.innerHTML = `
                ${overlay}
                <img src="${info.img}">
                <span>${isMe ? 'Ø£Ù†Øª' : info.fname}</span>
                <div class="mic-badge" id="m-bdg-${uid}"><i class="fas fa-microphone"></i></div>
            `;
            $('grid').appendChild(d);
            playSfx('pop');
        }

        // --- HOST ACTIONS ---
        window.hostMute = (uid) => {
            update(ref(db, `calls/${activeCall}/participants/${uid}`), { mutedByHost: true });
        };
        window.hostKick = (uid) => {
            update(ref(db, `calls/${activeCall}/participants/${uid}`), { status: 'kicked' });
        };
        
        function updateHostBadge() {
            if(pendingRequests.length > 0) {
                $('room-req-badge').innerText = pendingRequests.length;
                $('room-req-badge').style.display = 'flex';
            } else $('room-req-badge').style.display = 'none';
        }

        window.toggleReqList = () => {
            if(!pendingRequests.length) return toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ù†ØªØ¸Ø§Ø±');
            const r = pendingRequests[0]; // Just show first for simplicity
            modal('Ø·Ù„Ø¨ Ø§Ù†Ø¶Ù…Ø§Ù…', `${r.fname} ÙŠØ±ÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„`, 
                `<button class="btn sec" style="width:auto" onclick="replyReq('${r.id}', false)">Ø±ÙØ¶</button>
                 <button class="btn" style="width:auto; background:var(--success)" onclick="replyReq('${r.id}', true)">Ù‚Ø¨ÙˆÙ„</button>`,
                null, r.img);
        };
        window.replyReq = (uid, ok) => {
            update(ref(db, `calls/${activeCall}/participants/${uid}`), { status: ok ? 'joined':'kicked' });
            closeModal();
        };

        // --- USER ACTIONS ---
        window.forceMuteLocally = (mute) => {
            myMuteStatus = mute; // Lock
            const tracks = localStream.getAudioTracks();
            if(tracks.length > 0) tracks[0].enabled = !mute;
            
            const btn = $('mic-btn');
            if(mute) {
                btn.classList.add('locked');
                btn.innerHTML = '<i class="fas fa-lock"></i>';
                // Update Badge
                $(`m-bdg-${user.id}`).classList.add('off');
                $(`m-bdg-${user.id}`).innerHTML = '<i class="fas fa-microphone-slash"></i>';
            }
        };

        window.toggleMic = () => {
            // Check if muted by host
            if(myMuteStatus) {
                // Check DB again to see if host unmuted
                get(ref(db, `calls/${activeCall}/participants/${user.id}/mutedByHost`)).then(s => {
                    if(s.val()) toast('Ø§Ù„Ù…Ø¶ÙŠÙ Ù‚Ø§Ù… Ø¨ÙƒØªÙ… ØµÙˆØªÙƒ', 'lock');
                    else {
                        // Host unlocked me
                        myMuteStatus = false;
                        $('mic-btn').classList.remove('locked');
                        actualToggle();
                    }
                });
            } else actualToggle();
        };

        function actualToggle() {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            const btn = $('mic-btn');
            const bdg = $(`m-bdg-${user.id}`);
            if(track.enabled) {
                btn.classList.add('active'); btn.innerHTML = '<i class="fas fa-microphone"></i>';
                bdg.classList.remove('off'); bdg.innerHTML = '<i class="fas fa-microphone"></i>';
            } else {
                btn.classList.remove('active'); btn.innerHTML = '<i class="fas fa-microphone-slash" style="color:#aaa"></i>';
                bdg.classList.add('off'); bdg.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            }
        }

        window.endSession = () => {
            if(isHost) {
                modal('Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©', 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ØŸ',
                `<button class="btn sec" style="width:auto" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
                 <button class="btn" style="width:auto; background:var(--danger)" onclick="destroyRoom()">Ø¥Ù†Ù‡Ø§Ø¡</button>`,
                '<i class="fas fa-exclamation-circle" style="color:var(--danger)"></i>');
            } else {
                leaveRoom(false);
            }
        };

        window.destroyRoom = () => {
            remove(ref(db, `calls/${activeCall}`));
            leaveRoom(false);
        };

        function leaveRoom(forced) {
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            if(!isHost && !forced && activeCall) remove(ref(db, `calls/${activeCall}/participants/${user.id}`));
            localStorage.removeItem('vc3_call');
            if(forced) {
                modal('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©', 'Ù‚Ø§Ù… Ø§Ù„Ù…Ø¶ÙŠÙ Ø¨Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©.', `<button class="btn" onclick="location.reload()">Ø­Ø³Ù†Ø§Ù‹</button>`, '<i class="fas fa-phone-slash"></i>');
            } else {
                location.reload();
            }
        }

        function kickScreen() {
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            localStorage.removeItem('vc3_call');
            $('app').innerHTML = `
            <div style="height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; text-align:center;">
                <i class="fas fa-ban" style="font-size:4rem; color:var(--danger); margin-bottom:20px;"></i>
                <h2>ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ùƒ</h2>
                <p style="color:var(--text-sub)">Ù‚Ø§Ù… Ø§Ù„Ù…Ø¶ÙŠÙ Ø¨Ø·Ø±Ø¯Ùƒ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©.</p>
                <button class="btn sec" style="width:200px; margin-top:30px;" onclick="location.reload()">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
            </div>`;
        }

        window.copyLnk = () => {
            const l = `${location.origin}${location.pathname}?call=${activeCall}`;
            navigator.clipboard.writeText(l); toast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·', 'link');
        };

        // --- CREATIVE: REACTIONS ---
        window.toggleReacts = () => $('react-bar').classList.toggle('show');
        window.sendReact = (emoji) => {
            push(ref(db, `calls/${activeCall}/reacts`), { emoji: emoji, ts: Date.now() });
            $('react-bar').classList.remove('show');
        };
        function showFlyingEmoji(emoji) {
            playSfx('pop');
            const el = document.createElement('div');
            el.className = 'flying-emoji';
            el.innerText = emoji;
            el.style.left = Math.random() * 80 + 10 + '%';
            el.style.bottom = '100px';
            $('v-room').appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }

        // --- CORE: WEBRTC & AUDIO ---
        function detectSound(uid, stream) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const src = audioCtx.createMediaStreamSource(stream);
            const anlz = audioCtx.createAnalyser();
            src.connect(anlz); anlz.fftSize = 64;
            const buf = new Uint8Array(anlz.frequencyBinCount);
            const loop = () => {
                const el = $(`c-${uid}`);
                if(!el) return;
                anlz.getByteFrequencyData(buf);
                const vol = buf.reduce((a,b)=>a+b)/buf.length;
                if(vol > 20) el.classList.add('speaking');
                else el.classList.remove('speaking');
                requestAnimationFrame(loop);
            }; loop();
        }

        function connectPeer(rid) {
            if(peers[rid]) return;
            const pc = new RTCPeerConnection({ iceServers: [{urls:'stun:stun.l.google.com:19302'}] });
            peers[rid] = pc;
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            
            pc.onicecandidate = e => {
                if(e.candidate) push(ref(db, `calls/${activeCall}/signals/${rid}`), { from: user.id, type: 'ice', data: JSON.stringify(e.candidate) });
            };
            pc.ontrack = e => {
                const a = new Audio(); a.srcObject = e.streams[0]; a.play();
                detectSound(rid, e.streams[0]);
            };

            // Negotiation
            if(user.id < rid) {
                pc.createOffer().then(o=>pc.setLocalDescription(o)).then(() => {
                    push(ref(db, `calls/${activeCall}/signals/${rid}`), { from: user.id, type: 'offer', data: JSON.stringify(pc.localDescription) });
                });
            }

            // Signal Listener
            onValue(ref(db, `calls/${activeCall}/signals/${user.id}`), s => {
                const msgs = s.val();
                if(!msgs) return;
                Object.entries(msgs).forEach(([k,m]) => {
                    if(m.from === rid) {
                        if(m.type === 'offer') {
                            pc.setRemoteDescription(JSON.parse(m.data))
                            .then(() => pc.createAnswer())
                            .then(a => pc.setLocalDescription(a))
                            .then(() => {
                                push(ref(db, `calls/${activeCall}/signals/${rid}`), { from: user.id, type: 'answer', data: JSON.stringify(pc.localDescription) });
                                remove(child(ref(db, `calls/${activeCall}/signals/${user.id}`), k));
                            });
                        } else if(m.type === 'answer') {
                            pc.setRemoteDescription(JSON.parse(m.data));
                            remove(child(ref(db, `calls/${activeCall}/signals/${user.id}`), k));
                        } else if(m.type === 'ice') {
                            pc.addIceCandidate(JSON.parse(m.data));
                            remove(child(ref(db, `calls/${activeCall}/signals/${user.id}`), k));
                        }
                    }
                });
            });
        }

        function startTimer() {
            let s=0; clearInterval(timerInt);
            timerInt = setInterval(() => { s++; $('timer').innerText = new Date(s*1000).toISOString().substr(14,5); }, 1000);
        }

        window.onload = () => {
            if(user.id && user.img) {
                const p = new URLSearchParams(location.search);
                if(p.get('call')) checkJoin(p.get('call'));
                else initDash();
            }
        };
    </script>
</body>
</html>
