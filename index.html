<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VoiceConnect Elite V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Alexandria:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: rgba(20, 20, 20, 0.75);
            --primary: #8b5cf6; /* بنفسجي عصري */
            --primary-glow: rgba(139, 92, 246, 0.5);
            --accent: #f472b6;
            --text-main: #ffffff;
            --text-muted: #9ca3af;
            --success: #10b981;
            --danger: #ef4444;
            --glass-border: rgba(255, 255, 255, 0.1);
            --blur: 25px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Alexandria', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            outline: none;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* خلفية متحركة */
        .ambient-light {
            position: absolute; width: 100%; height: 100%; z-index: -1; overflow: hidden;
        }
        .orb {
            position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.5;
            animation: float 12s ease-in-out infinite;
        }
        .orb-1 { width: 400px; height: 400px; background: var(--primary); top: -100px; left: -100px; }
        .orb-2 { width: 300px; height: 300px; background: var(--accent); bottom: -50px; right: -50px; animation-delay: -6s; }
        @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(40px, 60px); } }

        /* حاوية التطبيق */
        .app-shell {
            width: 100%; height: 100%; max-width: 480px;
            background: var(--bg-panel);
            backdrop-filter: blur(var(--blur));
            -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--glass-border);
            position: relative; overflow: hidden;
            transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 40px 80px rgba(0,0,0,0.6);
        }

        @media (min-width: 768px) {
            .app-shell { height: 90vh; border-radius: 40px; }
            .app-shell.wide-mode { max-width: 1000px; }
        }

        /* الشاشات */
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 30px;
            opacity: 0; pointer-events: none;
            transform: scale(0.9) translateY(20px);
            transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
            z-index: 1;
        }
        .view.active {
            opacity: 1; pointer-events: all;
            transform: scale(1) translateY(0);
            z-index: 10;
        }

        h1, h2 { font-weight: 800; background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        .subtitle { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 30px; line-height: 1.5; }

        /* المدخلات */
        .input-group { margin-bottom: 20px; }
        .modern-input {
            width: 100%; padding: 18px 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            color: white; font-size: 1rem;
            transition: 0.3s;
        }
        .modern-input:focus { border-color: var(--primary); background: rgba(139, 92, 246, 0.05); box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1); }

        /* الأزرار */
        .btn-primary {
            width: 100%; padding: 18px;
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            border: none; border-radius: 20px;
            color: white; font-weight: 700; font-size: 1rem;
            cursor: pointer; margin-top: auto;
            box-shadow: 0 10px 30px -10px var(--primary-glow);
            transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-primary:active { transform: scale(0.97); }

        /* تحميل الصورة */
        .avatar-container {
            width: 130px; height: 130px; margin: 0 auto 20px;
            border-radius: 50%;
            background: rgba(255,255,255,0.03);
            border: 2px dashed rgba(255,255,255,0.2);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; overflow: hidden; position: relative;
            transition: 0.3s;
        }
        .avatar-container:hover { border-color: var(--primary); background: rgba(255,255,255,0.05); }
        .avatar-container img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-container i { font-size: 2rem; color: rgba(255,255,255,0.4); }

        /* السياسة والشروط */
        .policy-box {
            background: rgba(255,255,255,0.03);
            border-radius: 16px; padding: 15px;
            margin-bottom: 20px; border: 1px solid var(--glass-border);
        }
        .policy-text { font-size: 0.75rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 15px; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .custom-checkbox {
            width: 24px; height: 24px; border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.3);
            display: flex; justify-content: center; align-items: center;
            transition: 0.3s; background: transparent;
        }
        .checkbox-wrapper input:checked + .custom-checkbox {
            background: var(--primary); border-color: var(--primary);
        }
        .checkbox-wrapper span { font-size: 0.85rem; font-weight: 600; }

        /* الشبكة والمشاركين */
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .user-badge { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 5px 15px 5px 5px; border-radius: 30px; border: 1px solid var(--glass-border); }
        .user-badge img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }

        .card-btn {
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
            padding: 25px; border-radius: 24px; margin-bottom: 15px;
            border: 1px solid var(--glass-border); cursor: pointer;
            display: flex; align-items: center; gap: 20px; transition: 0.3s;
        }
        .card-btn:hover { border-color: var(--primary); transform: translateY(-3px); }
        .icon-sq { width: 50px; height: 50px; background: rgba(139, 92, 246, 0.15); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.4rem; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; flex: 1; overflow-y: auto; padding: 5px; align-content: start; }
        
        .p-card {
            background: rgba(0,0,0,0.3); border-radius: 24px;
            aspect-ratio: 1; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden; border: 1px solid transparent; transition: 0.3s;
        }
        .p-card img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; z-index: 2; border: 3px solid transparent; transition: 0.2s; }
        .p-card .name { z-index: 2; margin-top: 10px; font-size: 0.85rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .p-card.speaking { border-color: var(--success); box-shadow: 0 0 25px rgba(16, 185, 129, 0.2); }
        .p-card.speaking img { border-color: var(--success); transform: scale(1.1); }

        /* أزرار التحكم بالشخص */
        .participant-controls {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 10; display: flex; gap: 10px; justify-content: center; align-items: center;
            opacity: 0; transition: 0.3s; pointer-events: none;
        }
        .p-card:active .participant-controls, .p-card:hover .participant-controls { opacity: 1; pointer-events: all; }
        
        .mini-btn { width: 40px; height: 40px; border-radius: 12px; border: none; font-size: 1.1rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .mb-kick { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .mb-kick:hover { background: var(--danger); color: white; }
        .mb-mute { background: rgba(255,255,255,0.1); color: white; }
        .mb-mute:hover { background: white; color: black; }

        /* شريط التحكم السفلي */
        .controls-bar { display: flex; justify-content: center; gap: 20px; padding-top: 20px; }
        .c-btn { width: 65px; height: 65px; border-radius: 24px; border: none; font-size: 1.4rem; cursor: pointer; transition: 0.3s; background: rgba(255,255,255,0.08); color: white; display: flex; align-items: center; justify-content: center; }
        .c-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-5px); }
        .c-btn.active { background: white; color: var(--bg-dark); box-shadow: 0 0 20px rgba(255,255,255,0.3); }
        .c-btn.hangup { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .c-btn.hangup:hover { background: var(--danger); color: white; box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }

        /* التنبيهات المخصصة (Custom Alerts/Modals) */
        .custom-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            z-index: 1000; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.4s;
        }
        .custom-overlay.show { opacity: 1; pointer-events: all; }
        
        .alert-box {
            background: #1a1a1a; border: 1px solid var(--glass-border);
            width: 90%; max-width: 350px; padding: 25px; border-radius: 24px;
            text-align: center; transform: scale(0.9); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .custom-overlay.show .alert-box { transform: scale(1); }
        
        .alert-icon { font-size: 3rem; margin-bottom: 15px; display: inline-block; }
        .alert-btns { display: flex; gap: 10px; margin-top: 20px; }
        .a-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 0.95rem; }
        .ab-primary { background: var(--primary); color: white; }
        .ab-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .ab-cancel { background: rgba(255,255,255,0.05); color: white; }

        /* التوست (الإشعارات الصغيرة) */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: rgba(20,20,20,0.95); border: 1px solid var(--glass-border);
            padding: 12px 20px; border-radius: 50px;
            display: flex; align-items: center; gap: 12px;
            z-index: 2000; transition: 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: max-content; max-width: 90%;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        canvas { display: none; }
        .req-list-badge { position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background: var(--accent); border-radius: 50%; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="ambient-light">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <!-- الأصوات -->
    <audio id="sound-pop" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU..."></audio> <!-- سيتم توليده بالكود -->

    <div class="app-shell" id="appShell">
        
        <!-- الخطوة 1: الاسم -->
        <div class="view active" id="view-step-1">
            <h2 style="margin-top: 40px;">مرحباً بك</h2>
            <p class="subtitle">لنبدأ بتعريف هويتك للعالم</p>
            
            <div class="input-group">
                <input type="text" id="reg-fname" class="modern-input" placeholder="الاسم الأول">
            </div>
            <div class="input-group">
                <input type="text" id="reg-lname" class="modern-input" placeholder="اسم العائلة">
            </div>

            <button class="btn-primary" onclick="goToStep2()">
                التالي <i class="fas fa-arrow-left"></i>
            </button>
        </div>

        <!-- الخطوة 2: الصورة والسياسة -->
        <div class="view" id="view-step-2">
            <h2>اللمسات الأخيرة</h2>
            <p class="subtitle">صورة شخصية وموافقة سريعة</p>

            <label class="avatar-container">
                <img id="avatar-preview" src="">
                <i class="fas fa-camera" id="camera-icon"></i>
                <input type="file" id="file-input" hidden accept="image/*">
            </label>
            <canvas id="compressor"></canvas>

            <div class="policy-box">
                <div class="policy-text">
                    لحماية مجتمعنا، نطلب منك استخدام اسم حقيقي وصورة لائقة. بضغطك على تسجيل الدخول، أنت توافق على شروط الاستخدام وسياسة الخصوصية الخاصة بنا. نحن لا نشارك بياناتك مع أي طرف ثالث.
                </div>
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="policy-check" hidden>
                    <div class="custom-checkbox"><i class="fas fa-check" style="font-size: 0.7rem; color: white;"></i></div>
                    <span>قرأت ووافقت على الشروط</span>
                </label>
            </div>

            <button class="btn-primary" onclick="finishRegistration()">
                إنهاء ودخول <i class="fas fa-check-circle"></i>
            </button>
            <button class="btn-primary" onclick="backToStep1()" style="margin-top: 10px; background: transparent; border: 1px solid var(--glass-border); box-shadow: none;">
                رجوع
            </button>
        </div>

        <!-- لوحة التحكم -->
        <div class="view" id="view-dash">
            <div class="dashboard-header">
                <div>
                    <h1>الرئيسية</h1>
                    <p style="color:var(--text-muted); font-size:0.85rem">متصل الآن</p>
                </div>
                <div class="user-badge">
                    <img id="dash-img" src="">
                    <span id="dash-name" style="font-weight:600; font-size:0.9rem"></span>
                </div>
            </div>

            <div class="card-btn" onclick="createCall('single')">
                <div class="icon-sq"><i class="fas fa-user"></i></div>
                <div>
                    <h3>مكالمة فردية</h3>
                    <span style="font-size:0.8rem; color:var(--text-muted)">غرفة خاصة لشخصين</span>
                </div>
            </div>

            <div class="card-btn" onclick="createCall('group')">
                <div class="icon-sq"><i class="fas fa-users"></i></div>
                <div>
                    <h3>مجموعة صوتية</h3>
                    <span style="font-size:0.8rem; color:var(--text-muted)">مساحة للأصدقاء</span>
                </div>
            </div>

            <!-- زر العودة لمكالمة -->
            <div id="rejoin-banner" style="display:none; background: rgba(16,185,129,0.1); border:1px solid var(--success); padding:15px; border-radius:16px; margin-top:20px; cursor:pointer; text-align:center;" onclick="rejoinSession()">
                <span style="color:var(--success); font-weight:bold;"><i class="fas fa-sync-alt fa-spin"></i> لديك جلسة نشطة، اضغط للعودة</span>
            </div>
        </div>

        <!-- الانتظار -->
        <div class="view" id="view-wait">
            <div style="text-align: center; margin-top: 40%;">
                <div class="avatar-container" style="width:100px; height:100px; border:none; margin-bottom:15px; cursor:default;">
                    <img id="host-img" src="" style="display:block">
                </div>
                <h3 id="host-name"></h3>
                <p class="subtitle">يدعوك للانضمام...</p>
                <div style="color:var(--primary); margin-top:20px;"><i class="fas fa-circle-notch fa-spin fa-2x"></i></div>
                <p style="font-size:0.8rem; margin-top:10px; color:var(--text-muted)">في انتظار موافقة المضيف</p>
            </div>
        </div>

        <!-- الغرفة -->
        <div class="view" id="view-room">
            <div class="dashboard-header" style="margin-bottom:15px;">
                <div style="background: rgba(255,255,255,0.08); padding:5px 12px; border-radius:20px; font-family:monospace; font-weight:bold;" id="timer">00:00</div>
                <button id="btn-requests" onclick="showRequestsModal()" style="display:none; position:relative; background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;">
                    <i class="fas fa-user-clock"></i>
                    <div class="req-list-badge" id="req-count" style="display:none">0</div>
                </button>
            </div>

            <div class="grid-container" id="grid"></div>

            <div class="controls-bar">
                <button class="c-btn" id="btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
                <button class="c-btn hangup" onclick="confirmLeave()"><i class="fas fa-phone-slash"></i></button>
                <button class="c-btn" onclick="copyLink()" style="font-size:1.1rem;"><i class="fas fa-link"></i></button>
            </div>
        </div>
    </div>

    <!-- نظام التنبيهات المخصص (Custom Modal) -->
    <div class="custom-overlay" id="custom-modal">
        <div class="alert-box">
            <div class="alert-icon" id="m-icon"></div>
            <h3 id="m-title" style="margin-bottom:10px"></h3>
            <p id="m-text" style="color:var(--text-muted); font-size:0.9rem;"></p>
            <div class="alert-btns" id="m-btns"></div>
        </div>
    </div>

    <!-- التوست (Toast) -->
    <div class="toast" id="toast">
        <div id="t-icon"></div>
        <span id="t-msg" style="font-size:0.9rem; font-weight:600;"></span>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, push, get, child, onDisconnect } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
            authDomain: "story-97cf7.firebaseapp.com",
            databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
            projectId: "story-97cf7",
            storageBucket: "story-97cf7.firebasestorage.app",
            messagingSenderId: "742801388214",
            appId: "1:742801388214:web:32a305a8057b0582c5ec17",
            measurementId: "G-9DPPWX7CF0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- المتغيرات العامة ---
        let currentUser = JSON.parse(localStorage.getItem('vc_user')) || { fname:'', lname:'', img:'' };
        let activeCallId = localStorage.getItem('vc_call_id');
        let localStream = null;
        let peerConnections = {};
        let isHost = false;
        let audioCtx, osc;
        let timerInt;
        let pendingReqs = [];

        // --- نظام التنبيهات المخصص (بديل الـ alert/confirm) ---
        window.showToast = (msg, type='info') => {
            const t = document.getElementById('toast');
            const icon = document.getElementById('t-icon');
            const txt = document.getElementById('t-msg');
            
            icon.innerHTML = type === 'error' ? '<i class="fas fa-exclamation-circle" style="color:var(--danger)"></i>' : 
                             type === 'success' ? '<i class="fas fa-check-circle" style="color:var(--success)"></i>' : 
                             '<i class="fas fa-info-circle" style="color:var(--primary)"></i>';
            txt.innerText = msg;
            
            t.classList.add('show');
            playSound('notify');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        window.showModal = (title, text, iconHTML, buttonsHTML) => {
            const m = document.getElementById('custom-modal');
            document.getElementById('m-title').innerText = title;
            document.getElementById('m-text').innerText = text;
            document.getElementById('m-icon').innerHTML = iconHTML;
            document.getElementById('m-btns').innerHTML = buttonsHTML;
            m.classList.add('show');
        };

        window.closeModal = () => {
            document.getElementById('custom-modal').classList.remove('show');
        };

        // --- الصوتيات ---
        function playSound(type) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);

            if(type === 'notify') {
                o.frequency.setValueAtTime(500, audioCtx.currentTime);
                o.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
                g.gain.setValueAtTime(0.1, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                o.start(); o.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- التنقل بين الشاشات ---
        function switchView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'view-room') document.querySelector('.app-shell').classList.add('wide-mode');
            else document.querySelector('.app-shell').classList.remove('wide-mode');
        }

        // --- منطق التسجيل (خطوتين) ---
        window.goToStep2 = () => {
            const f = document.getElementById('reg-fname').value.trim();
            const l = document.getElementById('reg-lname').value.trim();
            if(!f || !l) return showToast('الرجاء إدخال الاسم كاملاً', 'error');
            
            currentUser.fname = f;
            currentUser.lname = l;
            switchView('view-step-2');
        };

        window.backToStep1 = () => switchView('view-step-1');

        // معالجة الصورة
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = () => {
                        const cvs = document.getElementById('compressor');
                        const ctx = cvs.getContext('2d');
                        cvs.width = 100; cvs.height = 100;
                        ctx.drawImage(img, 0, 0, 100, 100);
                        const data = cvs.toDataURL('image/jpeg', 0.7);
                        document.getElementById('avatar-preview').src = data;
                        document.getElementById('avatar-preview').style.display = 'block';
                        document.getElementById('camera-icon').style.display = 'none';
                        currentUser.img = data;
                    };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        window.finishRegistration = () => {
            if(!currentUser.img) return showToast('الرجاء اختيار صورة شخصية', 'error');
            if(!document.getElementById('policy-check').checked) return showToast('يجب الموافقة على الشروط للمتابعة', 'error');

            if(!currentUser.id) currentUser.id = 'u_' + Date.now() + Math.random().toString(36).substr(2, 5);
            
            localStorage.setItem('vc_user', JSON.stringify(currentUser));
            set(ref(db, `users/${currentUser.id}`), currentUser);

            const params = new URLSearchParams(location.search);
            if(params.get('call')) joinCallSequence(params.get('call'));
            else initDashboard();
        };

        // --- التهيئة ---
        window.addEventListener('load', () => {
            if(currentUser.id) initDashboard();
            else switchView('view-step-1');

            const params = new URLSearchParams(location.search);
            if(params.get('call') && currentUser.id) joinCallSequence(params.get('call'));
        });

        function initDashboard() {
            document.getElementById('dash-name').innerText = currentUser.fname;
            document.getElementById('dash-img').src = currentUser.img;
            switchView('view-dash');
            
            if(activeCallId) {
                get(ref(db, `calls/${activeCallId}`)).then(s => {
                    if(s.exists()) document.getElementById('rejoin-banner').style.display = 'block';
                    else localStorage.removeItem('vc_call_id');
                });
            }
        }

        window.rejoinSession = () => joinCallSequence(activeCallId, true);

        // --- إدارة المكالمات ---
        window.createCall = (type) => {
            const cid = Date.now().toString(36);
            isHost = true;
            activeCallId = cid;
            localStorage.setItem('vc_call_id', cid);

            set(ref(db, `calls/${cid}`), {
                host: currentUser.id, type: type, status: 'active', created: Date.now()
            });
            // المضيف ينضم تلقائياً
            set(ref(db, `calls/${cid}/participants/${currentUser.id}`), {
                info: currentUser, status: 'joined', audio: true
            }).then(() => enterRoom());
        };

        function joinCallSequence(cid, isRejoin=false) {
            activeCallId = cid;
            localStorage.setItem('vc_call_id', cid);

            get(ref(db, `calls/${cid}`)).then(s => {
                if(!s.exists()) {
                    showToast('المكالمة انتهت', 'error');
                    setTimeout(() => location.href = location.pathname, 2000);
                    return;
                }
                const data = s.val();
                if(data.host === currentUser.id || isRejoin) {
                    isHost = (data.host === currentUser.id);
                    enterRoom();
                } else {
                    // شاشة الانتظار
                    get(ref(db, `users/${data.host}`)).then(u => {
                        const h = u.val();
                        document.getElementById('host-name').innerText = h.fname + ' ' + h.lname;
                        document.getElementById('host-img').src = h.img;
                        switchView('view-wait');
                    });
                    
                    set(ref(db, `calls/${cid}/participants/${currentUser.id}`), {
                        info: currentUser, status: 'waiting'
                    });

                    onValue(ref(db, `calls/${cid}/participants/${currentUser.id}/status`), sn => {
                        const st = sn.val();
                        if(st === 'joined') enterRoom();
                        else if(st === 'kicked') showKickedAlert();
                    });
                }
            });
        }

        async function enterRoom() {
            switchView('view-room');
            startTimer();
            if(isHost) document.getElementById('btn-requests').style.display = 'block';

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                detectVoice(currentUser.id, localStream);
            } catch(e) {
                showToast('المايكروفون غير متاح', 'error');
            }

            // إضافة نفسي
            addParticipantCard(currentUser.id, currentUser, true);

            // مراقبة المشاركين
            onValue(ref(db, `calls/${activeCallId}/participants`), snap => {
                const parts = snap.val() || {};
                
                // تنظيف القائمة
                document.querySelectorAll('.p-card').forEach(c => {
                    const uid = c.id.replace('p-', '');
                    if(!parts[uid] || parts[uid].status !== 'joined') {
                        c.remove();
                        if(peerConnections[uid]) { peerConnections[uid].close(); delete peerConnections[uid]; }
                    }
                });

                // إضافة الجدد ومعالجة الطلبات
                pendingReqs = [];
                Object.keys(parts).forEach(uid => {
                    const p = parts[uid];
                    if(isHost && p.status === 'waiting') pendingReqs.push({id: uid, ...p.info});
                    
                    if(p.status === 'joined') {
                        if(!document.getElementById(`p-${uid}`)) {
                            addParticipantCard(uid, p.info, uid === currentUser.id);
                            if(uid !== currentUser.id) connectP2P(uid);
                        }
                        updateAudioState(uid, p.audio);
                    }
                });

                updateRequestsBadge();

                // التحقق من الطرد
                if(parts[currentUser.id] && parts[currentUser.id].status === 'kicked') showKickedAlert();
            });

            // إشارات الحضور
            onDisconnect(ref(db, `calls/${activeCallId}/participants/${currentUser.id}`)).remove();
        }

        // --- واجهة الغرفة ---
        function addParticipantCard(uid, info, isMe) {
            if(document.getElementById(`p-${uid}`)) return;
            const grid = document.getElementById('grid');
            const div = document.createElement('div');
            div.className = 'p-card';
            div.id = `p-${uid}`;
            
            // أزرار التحكم للمضيف فوق المشارك
            let controlsHTML = '';
            if(isHost && !isMe) {
                controlsHTML = `
                    <div class="participant-controls">
                        <button class="mini-btn mb-kick" onclick="confirmKick('${uid}')"><i class="fas fa-ban"></i></button>
                        <button class="mini-btn mb-mute" onclick="forceMute('${uid}')"><i class="fas fa-microphone-slash"></i></button>
                    </div>
                `;
            }

            div.innerHTML = `
                ${controlsHTML}
                <img src="${info.img}">
                <div class="name">${isMe ? 'أنت' : info.fname}</div>
                <div id="mic-st-${uid}" style="position:absolute; bottom:10px; right:10px; font-size:0.8rem; color:white; opacity:0.8"><i class="fas fa-microphone"></i></div>
            `;
            grid.appendChild(div);
            playSound('notify');
        }

        // --- التحكم بالأعضاء (للمضيف) ---
        window.confirmKick = (uid) => {
            showModal(
                'طرد مشترك',
                'هل أنت متأكد من رغبتك في إخراج هذا الشخص من المكالمة؟',
                '<i class="fas fa-user-slash" style="color:var(--danger)"></i>',
                `<button class="a-btn ab-cancel" onclick="closeModal()">إلغاء</button>
                 <button class="a-btn ab-danger" onclick="doKick('${uid}')">نعم، طرد</button>`
            );
        };

        window.doKick = (uid) => {
            update(ref(db, `calls/${activeCallId}/participants/${uid}`), { status: 'kicked' });
            closeModal();
            showToast('تم طرد المستخدم', 'success');
        };

        window.forceMute = (uid) => {
            update(ref(db, `calls/${activeCallId}/participants/${uid}`), { audio: false });
            showToast('تم كتم الصوت', 'info');
        };

        // --- طلبات الانضمام ---
        function updateRequestsBadge() {
            const b = document.getElementById('req-count');
            if(pendingReqs.length > 0) {
                b.style.display = 'flex';
                b.innerText = pendingReqs.length;
                // إظهار تنبيه إذا كان هناك طلب جديد
                showToast(`${pendingReqs[0].fname} يريد الانضمام`, 'info');
            } else {
                b.style.display = 'none';
            }
        }

        window.showRequestsModal = () => {
            if(pendingReqs.length === 0) return showToast('لا توجد طلبات انتظار', 'info');
            
            const req = pendingReqs[0]; // التعامل مع أول واحد كمثال للتبسيط
            showModal(
                'طلب انضمام',
                `${req.fname} ${req.lname} يرغب بالدخول للمكالمة.`,
                `<img src="${req.img}" style="width:60px; height:60px; border-radius:50%;">`,
                `<button class="a-btn ab-danger" onclick="handleReq('${req.id}', false)">رفض</button>
                 <button class="a-btn ab-primary" onclick="handleReq('${req.id}', true)">قبول</button>`
            );
        };

        window.handleReq = (uid, approve) => {
            update(ref(db, `calls/${activeCallId}/participants/${uid}`), { 
                status: approve ? 'joined' : 'kicked' 
            });
            closeModal();
        };

        // --- الخروج والطرد ---
        window.confirmLeave = () => {
            showModal(
                'مغادرة المكالمة',
                'هل تريد حقاً الخروج؟ يمكنك العودة لاحقاً إذا لم تنته المكالمة.',
                '<i class="fas fa-sign-out-alt" style="color:var(--accent)"></i>',
                `<button class="a-btn ab-cancel" onclick="closeModal()">بقاء</button>
                 <button class="a-btn ab-danger" onclick="doLeave()">مغادرة</button>`
            );
        };

        window.doLeave = () => {
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            remove(ref(db, `calls/${activeCallId}/participants/${currentUser.id}`));
            localStorage.removeItem('vc_call_id');
            location.href = location.pathname;
        };

        function showKickedAlert() {
            showModal(
                'تم استبعادك',
                'قام المضيف بإخراجك من هذه المكالمة.',
                '<i class="fas fa-ban" style="color:var(--danger)"></i>',
                `<button class="a-btn ab-primary" onclick="location.href=location.pathname">حسناً</button>`
            );
            if(localStream) localStream.getTracks().forEach(t => t.stop());
        }

        // --- أدوات التحكم الشخصية ---
        window.toggleMic = () => {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            const btn = document.getElementById('btn-mic');
            
            if(track.enabled) {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
            } else {
                btn.classList.add('active'); // اللون الأبيض للكتم
                btn.innerHTML = '<i class="fas fa-microphone-slash" style="color:black"></i>';
            }
            
            update(ref(db, `calls/${activeCallId}/participants/${currentUser.id}`), { audio: track.enabled });
        };

        function updateAudioState(uid, isActive) {
            const el = document.getElementById(`mic-st-${uid}`);
            if(el) el.innerHTML = isActive ? 
                '<i class="fas fa-microphone"></i>' : 
                '<i class="fas fa-microphone-slash" style="color:var(--danger)"></i>';
        }

        window.copyLink = () => {
            const url = `${location.origin}${location.pathname}?call=${activeCallId}`;
            navigator.clipboard.writeText(url);
            showToast('تم نسخ رابط الدعوة', 'success');
        };

        // --- WebRTC & Audio Visualizer (مبسط) ---
        function detectVoice(uid, stream) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const src = audioCtx.createMediaStreamSource(stream);
            const anlz = audioCtx.createAnalyser();
            src.connect(anlz); anlz.fftSize = 64;
            const buf = new Uint8Array(anlz.frequencyBinCount);

            const loop = () => {
                const el = document.getElementById(`p-${uid}`);
                if(!el) return;
                anlz.getByteFrequencyData(buf);
                const avg = buf.reduce((a,b)=>a+b) / buf.length;
                if(avg > 25) el.classList.add('speaking');
                else el.classList.remove('speaking');
                requestAnimationFrame(loop);
            };
            loop();
        }

        function connectP2P(remoteUid) {
            if(peerConnections[remoteUid]) return;
            const pc = new RTCPeerConnection({ iceServers: [{urls:'stun:stun.l.google.com:19302'}] });
            peerConnections[remoteUid] = pc;
            
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            
            pc.onicecandidate = e => {
                if(e.candidate) push(ref(db, `calls/${activeCallId}/signals/${remoteUid}`), {
                    from: currentUser.id, type: 'ice', data: JSON.stringify(e.candidate)
                });
            };

            pc.ontrack = e => {
                const aud = new Audio();
                aud.srcObject = e.streams[0];
                aud.play();
                detectVoice(remoteUid, e.streams[0]);
            };

            // بدء العرض (الأبجدية لتجنب التصادم)
            if(currentUser.id < remoteUid) {
                pc.createOffer().then(o => pc.setLocalDescription(o)).then(() => {
                    push(ref(db, `calls/${activeCallId}/signals/${remoteUid}`), {
                        from: currentUser.id, type: 'offer', data: JSON.stringify(pc.localDescription)
                    });
                });
            }

            // استقبال الإشارات
            onValue(ref(db, `calls/${activeCallId}/signals/${currentUser.id}`), snap => {
                const msgs = snap.val();
                if(!msgs) return;
                Object.entries(msgs).forEach(([k, m]) => {
                    if(m.from === remoteUid) {
                        if(m.type === 'offer') {
                            pc.setRemoteDescription(JSON.parse(m.data))
                                .then(() => pc.createAnswer())
                                .then(a => pc.setLocalDescription(a))
                                .then(() => {
                                    push(ref(db, `calls/${activeCallId}/signals/${remoteUid}`), {
                                        from: currentUser.id, type: 'answer', data: JSON.stringify(pc.localDescription)
                                    });
                                    remove(child(ref(db, `calls/${activeCallId}/signals/${currentUser.id}`), k));
                                });
                        } else if (m.type === 'answer') {
                            pc.setRemoteDescription(JSON.parse(m.data));
                            remove(child(ref(db, `calls/${activeCallId}/signals/${currentUser.id}`), k));
                        } else if (m.type === 'ice') {
                            pc.addIceCandidate(JSON.parse(m.data));
                            remove(child(ref(db, `calls/${activeCallId}/signals/${currentUser.id}`), k));
                        }
                    }
                });
            });
        }

        function startTimer() {
            let s = 0;
            clearInterval(timerInt);
            timerInt = setInterval(() => {
                s++;
                document.getElementById('timer').innerText = 
                    `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            }, 1000);
        }

    </script>
</body>
</html>
