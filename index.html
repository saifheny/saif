<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Connect | Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e24;
            --primary: #a3ff12;
            --primary-dark: #8bd60a;
            --danger: #ff4757;
            --text: #ffffff;
            --text-muted: #aaaaaa;
            --chat-bg: #18181b;
            --my-msg-bg: #2d3436;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        /* --- شاشة الدخول --- */
        .setup-screen {
            width: 100%;
            max-width: 500px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            height: 100%;
            z-index: 20;
            background: var(--bg-color);
        }

        .logo-circle {
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; color: #000;
            margin-bottom: 1rem;
            box-shadow: 0 0 25px rgba(163, 255, 18, 0.4);
        }

        .avatar-upload {
            width: 110px; height: 110px;
            border-radius: 50%;
            background: var(--card-bg);
            margin: 1.5rem auto;
            position: relative;
            cursor: pointer;
            border: 2px dashed #444;
            overflow: hidden;
        }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; }
        .camera-icon { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); font-size: 0.8rem; padding: 5px; }

        input[type="text"] {
            width: 100%; padding: 15px;
            border-radius: 15px; border: 1px solid #333;
            background: var(--card-bg); color: white;
            font-size: 1.1rem; outline: none; margin-bottom: 1.5rem;
            text-align: center;
        }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 30px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-bottom: 10px; transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary { background: var(--card-bg); color: white; border: 1px solid #333; }

        /* --- شاشة المكالمة --- */
        .call-container {
            display: none; /* مخفي افتراضياً */
            flex-direction: column;
            width: 100%;
            height: 100%;
            max-width: 600px; /* لتقييد العرض على الديسك توب */
            position: relative;
        }

        /* الجزء العلوي: الفيديوهات */
        .video-section {
            flex: 1; /* تأخذ المساحة المتبقية */
            background: #000;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            overflow-y: auto;
            align-content: center;
            border-bottom: 1px solid #333;
            max-height: 60vh; /* الفيديو يأخذ 60% كحد أقصى */
        }

        .video-card {
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 1; /* مربع أو مستطيل حسب الشبكة */
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        .video-card video { width: 100%; height: 100%; object-fit: cover; }
        
        /* حالة الفيديو المغلق */
        .video-card.cam-off video { display: none; }
        .video-card.cam-off .video-placeholder { display: flex; }
        
        .video-placeholder {
            display: none;
            width: 100%; height: 100%;
            flex-direction: column;
            align-items: center; justify-content: center;
            background: #222;
        }
        .video-placeholder img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); margin-bottom: 5px; }

        /* طبقات المعلومات على الفيديو */
        .user-label {
            position: absolute; bottom: 8px; right: 8px;
            background: rgba(0,0,0,0.6); padding: 3px 8px;
            border-radius: 8px; font-size: 0.75rem; color: white;
            backdrop-filter: blur(4px); pointer-events: none;
        }

        .status-icons {
            position: absolute; top: 8px; right: 8px;
            display: flex; gap: 5px;
        }
        .mute-badge {
            background: rgba(255, 71, 87, 0.9);
            color: white; width: 24px; height: 24px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem;
        }

        /* زر الطرد للمضيف */
        .admin-kick-btn {
            position: absolute; top: 8px; left: 8px;
            background: rgba(0,0,0,0.6); color: var(--danger);
            border: none; width: 28px; height: 28px; border-radius: 50%;
            cursor: pointer; z-index: 5;
        }

        /* الجزء السفلي: الشات والتحكم */
        .bottom-section {
            height: 40vh; /* 40% من الشاشة */
            display: flex;
            flex-direction: column;
            background: var(--chat-bg);
        }

        /* منطقة الشات */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            background: #333;
            padding: 8px 12px;
            border-radius: 12px;
            border-bottom-right-radius: 2px;
            align-self: flex-start;
            max-width: 85%;
            font-size: 0.9rem;
            position: relative;
        }
        .message.mine {
            background: #2b4a08; /* أخضر غامق */
            border: 1px solid var(--primary-dark);
            align-self: flex-end;
            border-bottom-right-radius: 12px;
            border-bottom-left-radius: 2px;
        }
        .msg-sender { font-size: 0.7rem; color: var(--primary); margin-bottom: 2px; display: block; }
        .delete-msg-btn {
            position: absolute; top: -5px; left: -5px;
            background: var(--danger); color: white;
            border: none; border-radius: 50%; width: 18px; height: 18px;
            font-size: 10px; cursor: pointer; display: none;
        }
        .message:hover .delete-msg-btn { display: block; } /* يظهر عند اللمس/الماوس */

        /* حقل الإدخال */
        .chat-input-container {
            padding: 10px;
            background: #222;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .chat-input {
            flex: 1;
            padding: 10px;
            border-radius: 20px;
            border: none;
            background: #333;
            color: white;
            outline: none;
        }
        .send-btn {
            background: var(--primary);
            border: none;
            width: 40px; height: 40px;
            border-radius: 50%;
            color: black;
            cursor: pointer;
        }

        /* شريط التحكم */
        .controls-bar {
            padding: 10px;
            display: flex;
            justify-content: space-around;
            background: #111;
            border-top: 1px solid #333;
        }
        .control-btn {
            width: 50px; height: 50px;
            border-radius: 50%; border: none;
            font-size: 1.2rem; cursor: pointer;
            background: #333; color: white;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .control-btn.active { background: white; color: black; }
        .control-btn.hangup { background: var(--danger); color: white; }
        .control-btn.screen-share { color: var(--primary); border: 1px solid var(--primary); background: transparent; }
        .control-btn.screen-share.sharing { background: var(--primary); color: black; animation: pulse 2s infinite; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(163, 255, 18, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(163, 255, 18, 0); } 100% { box-shadow: 0 0 0 0 rgba(163, 255, 18, 0); } }

        /* نافذة الطلبات */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--card-bg); width: 90%; max-width: 350px;
            padding: 20px; border-radius: 15px; text-align: center;
        }
        .req-list { margin-top: 15px; }
        .req-item {
            background: #333; padding: 10px; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
        }
        .req-btn { padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; margin-left: 5px; }
        .accept { background: var(--primary); }
        .reject { background: #555; color: white; }
        
        .notification-badge {
            position: absolute; top: 0; right: 0;
            background: red; width: 15px; height: 15px;
            border-radius: 50%; border: 2px solid #111;
        }

    </style>
</head>
<body>

    <!-- شاشة الإعداد -->
    <div id="setup-screen" class="setup-screen">
        <div class="logo-circle"><i class="fa-solid fa-headset"></i></div>
        <h2 style="margin-bottom: 5px;">مرحباً بك</h2>
        <p style="color:#888; margin-bottom: 20px;">قم بإعداد ملفك الشخصي</p>

        <div class="avatar-upload" onclick="document.getElementById('avatar-input').click()">
            <img id="avatar-preview" src="assets/default-user.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
            <div class="camera-icon"><i class="fa-solid fa-camera"></i> تغيير الصورة</div>
        </div>
        <input type="file" id="avatar-input" accept="image/*" hidden>

        <input type="text" id="username" placeholder="اكتب اسمك هنا...">

        <button id="create-btn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> إنشاء غرفة جديدة</button>
        
        <div id="join-section" style="display:none; width: 100%;">
            <button id="join-btn" class="btn btn-primary"><i class="fa-solid fa-right-to-bracket"></i> انضمام للمكالمة</button>
            <p id="status-msg" style="color: var(--primary); margin-top: 10px; font-size: 0.9rem;"></p>
        </div>
    </div>

    <!-- شاشة المكالمة -->
    <div id="call-screen" class="call-container">
        
        <!-- قسم الفيديو (60%) -->
        <div class="video-section" id="video-grid">
            <!-- فيديو المستخدم المحلي -->
            <div class="video-card local" id="local-card">
                <video id="local-video" autoplay muted playsinline></video>
                <div class="video-placeholder">
                    <img id="local-placeholder-img" src="">
                    <span>أنت</span>
                </div>
                <div class="user-label">أنت (المضيف)</div>
                <div class="status-icons">
                    <div id="local-mute-icon" class="mute-badge" style="display:none;"><i class="fa-solid fa-microphone-slash"></i></div>
                </div>
            </div>
        </div>

        <!-- قسم الشات والتحكم (40%) -->
        <div class="bottom-section">
            <div class="chat-area" id="chat-messages">
                <div style="text-align: center; color: #555; font-size: 0.8rem; margin-top: 20px;">بدأت المحادثة</div>
            </div>
            
            <div class="chat-input-container">
                <input type="text" id="msg-input" class="chat-input" placeholder="اكتب رسالة...">
                <button id="send-msg-btn" class="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
            </div>

            <div class="controls-bar">
                <button id="toggle-mic" class="control-btn active"><i class="fa-solid fa-microphone"></i></button>
                <button id="toggle-cam" class="control-btn active"><i class="fa-solid fa-video"></i></button>
                <button id="share-screen" class="control-btn screen-share"><i class="fa-solid fa-display"></i></button>
                <button id="requests-btn" class="control-btn" style="display:none; position: relative;">
                    <i class="fa-solid fa-users"></i>
                    <div id="req-badge" class="notification-badge" style="display:none;"></div>
                </button>
                <button id="leave-btn" class="control-btn hangup"><i class="fa-solid fa-phone"></i></button>
            </div>
        </div>
    </div>

    <!-- نافذة الطلبات -->
    <div id="requests-modal" class="modal">
        <div class="modal-content">
            <h3>طلبات الانضمام</h3>
            <div id="requests-list" class="req-list"></div>
            <button onclick="document.getElementById('requests-modal').style.display='none'" style="margin-top:15px; background:none; border:none; color:#888;">إغلاق</button>
        </div>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
            authDomain: "story-97cf7.firebaseapp.com",
            databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
            projectId: "story-97cf7",
            storageBucket: "story-97cf7.firebasestorage.app",
            messagingSenderId: "742801388214",
            appId: "1:742801388214:web:32a305a8057b0582c5ec17"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- المتغيرات ---
        let localStream;
        let screenStream = null;
        let myId = localStorage.getItem('vc_uid') || Math.random().toString(36).substr(2, 9);
        localStorage.setItem('vc_uid', myId); // تثبيت الـ ID
        
        let roomId = new URLSearchParams(window.location.search).get('room');
        let isHost = false;
        let peers = {};
        
        // البيانات الشخصية (تحميل من الذاكرة)
        let myInfo = {
            name: localStorage.getItem('vc_name') || "",
            avatar: localStorage.getItem('vc_avatar') || "https://cdn-icons-png.flaticon.com/512/149/149071.png",
            mic: localStorage.getItem('vc_mic') !== 'false', // true by default
            cam: localStorage.getItem('vc_cam') !== 'false'  // true by default
        };

        // --- تهيئة الصفحة ---
        if (myInfo.name) document.getElementById('username').value = myInfo.name;
        document.getElementById('avatar-preview').src = myInfo.avatar;

        if (roomId) {
            document.getElementById('create-btn').style.display = 'none';
            document.getElementById('join-section').style.display = 'block';
        }

        // --- معالجة الصور ---
        document.getElementById('avatar-input').addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                const base64 = await resizeImage(e.target.files[0]);
                myInfo.avatar = base64;
                document.getElementById('avatar-preview').src = base64;
                localStorage.setItem('vc_avatar', base64);
            }
        });

        function resizeImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const size = 100; // حجم صغير
                        canvas.width = size; canvas.height = size;
                        ctx.drawImage(img, 0, 0, size, size);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // --- الأزرار ---
        document.getElementById('create-btn').onclick = async () => {
            if (!saveUserInfo()) return;
            roomId = Math.random().toString(36).substr(2, 6); // كود قصير
            isHost = true;
            await set(ref(db, `rooms/${roomId}`), { hostId: myId, created: Date.now() });
            enterCall();
        };

        document.getElementById('join-btn').onclick = async () => {
            if (!saveUserInfo()) return;
            const btn = document.getElementById('join-btn');
            btn.disabled = true;
            document.getElementById('status-msg').innerText = "جاري طلب الإذن...";
            
            await set(ref(db, `rooms/${roomId}/requests/${myId}`), { info: myInfo, status: 'pending' });

            onValue(ref(db, `rooms/${roomId}/requests/${myId}`), (snap) => {
                const val = snap.val();
                if (val?.status === 'accepted') enterCall();
                if (val?.status === 'rejected') {
                    document.getElementById('status-msg').innerText = "تم رفض الطلب.";
                    btn.disabled = false;
                }
            });
        };

        function saveUserInfo() {
            const name = document.getElementById('username').value.trim();
            if (!name) { alert("أدخل اسمك"); return false; }
            myInfo.name = name;
            localStorage.setItem('vc_name', name);
            return true;
        }

        // --- دخول المكالمة ---
        async function enterCall() {
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('call-screen').style.display = 'flex';
            
            // تحديث الرابط في المتصفح
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + roomId;
            window.history.pushState({path:newUrl},'',newUrl);

            // تشغيل الميديا
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('local-video').srcObject = localStream;
            document.getElementById('local-placeholder-img').src = myInfo.avatar;

            // تطبيق الإعدادات المحفوظة (Mic/Cam)
            toggleMedia('audio', myInfo.mic);
            toggleMedia('video', myInfo.cam);

            // إضافة بياناتي
            const userRef = ref(db, `rooms/${roomId}/participants/${myId}`);
            update(userRef, { info: myInfo });
            
            // مراقبة الطرد
            onValue(userRef, (snap) => {
                if(snap.val() === null && !isHost) { // إذا حذفت بياناتي وأنا لست المضيف
                    alert("تم إخراجك من المكالمة");
                    location.href = window.location.pathname;
                }
            });

            if (isHost) {
                document.getElementById('requests-btn').style.display = 'block';
                document.querySelector('.user-label').innerText = "أنت (المضيف)";
                monitorRequests();
            } else {
                document.querySelector('.user-label').innerText = "أنت";
            }

            initChat();
            initWebRTC();
        }

        // --- WebRTC ---
        function initWebRTC() {
            const partRef = ref(db, `rooms/${roomId}/participants`);
            onValue(partRef, (snap) => {
                const users = snap.val() || {};
                
                // التعامل مع المستخدمين الجدد
                Object.keys(users).forEach(uid => {
                    if (uid !== myId && !peers[uid]) {
                        createPeer(uid, users[uid].info);
                    }
                    // تحديث الحالة (مايك/كاميرا) للمستخدمين الموجودين
                    if (uid !== myId) {
                        updateUserStatusUI(uid, users[uid].info);
                    }
                });

                // إزالة الخارجين
                Object.keys(peers).forEach(uid => {
                    if (!users[uid]) {
                        document.getElementById(`video-card-${uid}`)?.remove();
                        peers[uid].close();
                        delete peers[uid];
                    }
                });
            });

            // استقبال الإشارات
            const signalsRef = ref(db, `rooms/${roomId}/signals/${myId}`);
            onValue(signalsRef, async (snap) => {
                const msgs = snap.val();
                if(!msgs) return;
                for(const [key, msg] of Object.entries(msgs)) {
                    await handleSignal(msg);
                    remove(ref(db, `rooms/${roomId}/signals/${myId}/${key}`));
                }
            });
        }

        async function createPeer(uid, info) {
            const pc = new RTCPeerConnection({ iceServers: [{urls:'stun:stun.l.google.com:19302'}] });
            peers[uid] = pc;

            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.ontrack = (e) => {
                let card = document.getElementById(`video-card-${uid}`);
                if (!card) {
                    card = document.createElement('div');
                    card.id = `video-card-${uid}`;
                    card.className = 'video-card';
                    // إضافة HTML الكارت مع زر الطرد إذا كنت المضيف
                    const kickBtn = isHost ? `<button class="admin-kick-btn" onclick="kickUser('${uid}')"><i class="fa-solid fa-ban"></i></button>` : '';
                    
                    card.innerHTML = `
                        <video autoplay playsinline></video>
                        <div class="video-placeholder"><img src="${info.avatar}"><span>${info.name}</span></div>
                        <div class="user-label">${info.name}</div>
                        <div class="status-icons">
                            <div id="mic-icon-${uid}" class="mute-badge" style="display:none;"><i class="fa-solid fa-microphone-slash"></i></div>
                        </div>
                        ${kickBtn}
                    `;
                    document.getElementById('video-grid').appendChild(card);
                }
                card.querySelector('video').srcObject = e.streams[0];
            };

            pc.onicecandidate = (e) => {
                if(e.candidate) push(ref(db, `rooms/${roomId}/signals/${uid}`), { type: 'candidate', sender: myId, val: JSON.stringify(e.candidate) });
            };

            if (myId > uid) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                push(ref(db, `rooms/${roomId}/signals/${uid}`), { type: 'offer', sender: myId, val: JSON.stringify(offer) });
            }
        }

        async function handleSignal(msg) {
            if(!peers[msg.sender]) await createPeer(msg.sender, {name: '...', avatar: ''}); // fallback info
            const pc = peers[msg.sender];
            const data = JSON.parse(msg.val);

            if (msg.type === 'offer') {
                await pc.setRemoteDescription(data);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                push(ref(db, `rooms/${roomId}/signals/${msg.sender}`), { type: 'answer', sender: myId, val: JSON.stringify(answer) });
            } else if (msg.type === 'answer') {
                await pc.setRemoteDescription(data);
            } else if (msg.type === 'candidate') {
                try { await pc.addIceCandidate(data); } catch(e){}
            }
        }

        // --- وظائف التحكم (Admin + User) ---

        // تحديث حالة المايك والكاميرا في الواجهة
        function updateUserStatusUI(uid, info) {
            const card = document.getElementById(`video-card-${uid}`);
            if(card) {
                // المايك
                const micIcon = document.getElementById(`mic-icon-${uid}`);
                micIcon.style.display = info.mic ? 'none' : 'flex';
                // الكاميرا
                if (!info.cam) card.classList.add('cam-off');
                else card.classList.remove('cam-off');
            }
        }

        // تبديل الميديا محلياً وإبلاغ السيرفر
        function toggleMedia(type, forcedState = null) {
            const isAudio = type === 'audio';
            const track = isAudio ? localStream.getAudioTracks()[0] : localStream.getVideoTracks()[0];
            const btn = isAudio ? document.getElementById('toggle-mic') : document.getElementById('toggle-cam');
            
            // تحديد الحالة الجديدة (إما مقلوب الحالي أو المفروض)
            const newState = forcedState !== null ? forcedState : !track.enabled;
            
            track.enabled = newState;
            myInfo[isAudio ? 'mic' : 'cam'] = newState;
            
            // حفظ التفضيل
            localStorage.setItem(isAudio ? 'vc_mic' : 'vc_cam', newState);

            // تحديث الزر
            if(newState) {
                btn.classList.add('active');
                btn.innerHTML = isAudio ? '<i class="fa-solid fa-microphone"></i>' : '<i class="fa-solid fa-video"></i>';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = isAudio ? '<i class="fa-solid fa-microphone-slash"></i>' : '<i class="fa-solid fa-video-slash"></i>';
            }

            // تحديث واجهتي المحلية
            const localCard = document.getElementById('local-card');
            if(isAudio) {
                document.getElementById('local-mute-icon').style.display = newState ? 'none' : 'flex';
            } else {
                newState ? localCard.classList.remove('cam-off') : localCard.classList.add('cam-off');
            }

            // إرسال التحديث لـ Firebase
            update(ref(db, `rooms/${roomId}/participants/${myId}/info`), myInfo);
        }

        document.getElementById('toggle-mic').onclick = () => toggleMedia('audio');
        document.getElementById('toggle-cam').onclick = () => toggleMedia('video');

        // مشاركة الشاشة
        document.getElementById('share-screen').onclick = async () => {
            const btn = document.getElementById('share-screen');
            if (!screenStream) {
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = screenStream.getVideoTracks()[0];
                    
                    // استبدال التراك لكل المتصلين
                    Object.values(peers).forEach(pc => {
                        const sender = pc.getSenders().find(s => s.track.kind === 'video');
                        if(sender) sender.replaceTrack(screenTrack);
                    });

                    // تغيير العرض المحلي
                    document.getElementById('local-video').srcObject = screenStream;
                    btn.classList.add('sharing');

                    // عند إيقاف المشاركة من المتصفح
                    screenTrack.onended = () => {
                        stopSharing(btn);
                    };

                } catch(e) { console.error(e); }
            } else {
                stopSharing(btn);
            }
        };

        function stopSharing(btn) {
            if(screenStream) {
                screenStream.getTracks().forEach(t => t.stop());
                screenStream = null;
            }
            // إعادة الكاميرا
            const camTrack = localStream.getVideoTracks()[0];
            Object.values(peers).forEach(pc => {
                const sender = pc.getSenders().find(s => s.track.kind === 'video');
                if(sender) sender.replaceTrack(camTrack);
            });
            document.getElementById('local-video').srcObject = localStream;
            btn.classList.remove('sharing');
        }

        // الطرد (للهوست)
        window.kickUser = (uid) => {
            if(confirm('هل أنت متأكد من طرد هذا المستخدم؟')) {
                remove(ref(db, `rooms/${roomId}/participants/${uid}`));
                remove(ref(db, `rooms/${roomId}/requests/${uid}`)); // إزالة طلبه أيضاً
            }
        };

        // --- الشات ---
        function initChat() {
            const chatRef = ref(db, `rooms/${roomId}/messages`);
            
            // إرسال
            document.getElementById('send-msg-btn').onclick = sendMessage;
            document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };

            // استقبال
            onValue(chatRef, (snap) => {
                const msgs = snap.val();
                const container = document.getElementById('chat-messages');
                container.innerHTML = '<div style="text-align: center; color: #555; font-size: 0.8rem; margin-top: 20px;">بدأت المحادثة</div>'; // مسح وإعادة بناء
                
                if(msgs) {
                    Object.entries(msgs).forEach(([key, msg]) => {
                        const div = document.createElement('div');
                        div.className = `message ${msg.senderId === myId ? 'mine' : ''}`;
                        
                        // زر الحذف للمضيف
                        const deleteBtn = isHost ? `<button class="delete-msg-btn" onclick="deleteMessage('${key}')"><i class="fa-solid fa-trash"></i></button>` : '';
                        
                        div.innerHTML = `
                            ${deleteBtn}
                            <span class="msg-sender">${msg.senderName}</span>
                            ${msg.text}
                        `;
                        container.appendChild(div);
                    });
                    container.scrollTop = container.scrollHeight;
                }
            });
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;
            
            push(ref(db, `rooms/${roomId}/messages`), {
                senderId: myId,
                senderName: myInfo.name,
                text: text,
                time: Date.now()
            });
            input.value = '';
        }

        window.deleteMessage = (msgId) => {
            remove(ref(db, `rooms/${roomId}/messages/${msgId}`));
        };

        // --- إدارة الطلبات (للمضيف) ---
        function monitorRequests() {
            onValue(ref(db, `rooms/${roomId}/requests`), (snap) => {
                const list = document.getElementById('requests-list');
                const badge = document.getElementById('req-badge');
                list.innerHTML = '';
                let count = 0;
                
                const reqs = snap.val() || {};
                Object.entries(reqs).forEach(([uid, data]) => {
                    if(data.status === 'pending') {
                        count++;
                        list.innerHTML += `
                            <div class="req-item">
                                <span>${data.info.name}</span>
                                <div>
                                    <button class="req-btn accept" onclick="answerReq('${uid}', 'accepted')">قبول</button>
                                    <button class="req-btn reject" onclick="answerReq('${uid}', 'rejected')">رفض</button>
                                </div>
                            </div>
                        `;
                    }
                });

                badge.style.display = count > 0 ? 'block' : 'none';
            });
        }

        window.answerReq = (uid, status) => {
            update(ref(db, `rooms/${roomId}/requests/${uid}`), { status: status });
            if(status === 'rejected') remove(ref(db, `rooms/${roomId}/requests/${uid}`)); // تنظيف
        };
        
        document.getElementById('requests-btn').onclick = () => {
            document.getElementById('requests-modal').style.display = 'flex';
        };

        // مغادرة
        document.getElementById('leave-btn').onclick = () => {
            if(confirm("مغادرة المكالمة؟")) location.href = window.location.pathname;
        };

    </script>
</body>
</html>
