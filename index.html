<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Buz Pro - مكالمات جماعية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #0f0f10;
            --bg-card: #1e1e24;
            --primary: #a5ff00; /* اللون الليموني */
            --danger: #ff4d4d;
            --text-main: #ffffff;
            --text-sec: #aaaaaa;
            --glass: rgba(255, 255, 255, 0.08);
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- شاشات الدخول --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; padding: 20px; transition: opacity 0.3s;
        }
        .screen.active { display: flex; }

        .logo-box {
            width: 100px; height: 100px;
            background: radial-gradient(circle, rgba(165,255,0,0.2) 0%, rgba(0,0,0,0) 70%);
            border: 2px solid var(--primary);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px; box-shadow: 0 0 20px rgba(165,255,0,0.3);
        }
        .logo-box i { font-size: 2.5rem; color: var(--primary); }

        .form-box { width: 100%; max-width: 350px; text-align: center; }
        
        .avatar-select {
            width: 90px; height: 90px; margin: 0 auto 20px;
            border-radius: 50%; background: var(--bg-card); border: 2px dashed #444;
            position: relative; cursor: pointer; overflow: hidden;
        }
        .avatar-select img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-select i { position: absolute; bottom: 5px; width: 100%; text-align: center; font-size: 12px; background: rgba(0,0,0,0.6); padding: 2px; }

        input[type="text"] {
            width: 100%; padding: 15px; border-radius: 50px;
            border: 1px solid #333; background: var(--bg-card);
            color: white; text-align: center; margin-bottom: 15px; outline: none;
        }
        input:focus { border-color: var(--primary); }

        .btn {
            width: 100%; padding: 15px; border-radius: 50px; border: none;
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-bottom: 10px; transition: 0.2s; font-size: 1rem;
        }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-sec { background: #333; color: white; }
        .btn:active { transform: scale(0.97); }

        /* --- شاشة المكالمة --- */
        #call-screen { padding: 0; justify-content: space-between; background: #000; }

        /* الهيدر */
        .header {
            width: 100%; height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            position: absolute; top: 0; z-index: 5;
        }
        .room-id { font-size: 0.9rem; background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; }
        
        /* شبكة الفيديو */
        .video-grid {
            flex: 1; width: 100%; display: grid; gap: 8px; padding: 70px 10px 10px;
            overflow-y: auto; align-content: center;
        }
        /* تنسيق الشبكة حسب العدد */
        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; } /* الثالث يأخذ مساحة */
        .grid-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }

        .video-card {
            background: #1a1a1a; border-radius: var(--radius); overflow: hidden;
            position: relative; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .video-card video { width: 100%; height: 100%; object-fit: cover; }
        
        /* حالة الفيديو مغلق */
        .video-card.cam-off video { display: none; }
        .video-card.cam-off .placeholder { display: flex; }
        
        .placeholder {
            display: none; flex-direction: column; align-items: center;
            width: 100%; height: 100%; justify-content: center; background: #222;
        }
        .placeholder img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; border: 2px solid #444; object-fit: cover; }
        
        /* معلومات المستخدم */
        .user-tag {
            position: absolute; bottom: 10px; left: 10px;
            background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 10px;
            font-size: 0.8rem; display: flex; align-items: center; gap: 6px; backdrop-filter: blur(4px);
        }
        .mute-icon { color: var(--danger); display: none; } /* يظهر عند الكتم */

        /* منطقة الشات */
        .chat-container {
            height: 30%; background: var(--bg-card); border-top-left-radius: 20px; border-top-right-radius: 20px;
            display: flex; flex-direction: column; position: relative; transition: height 0.3s;
            border-top: 1px solid #333;
        }
        .chat-container.collapsed { height: 40px; }
        
        .chat-header {
            padding: 10px; text-align: center; border-bottom: 1px solid #333; cursor: pointer;
            font-size: 0.8rem; color: var(--text-sec);
        }
        .chat-messages {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px;
        }
        .chat-input-area {
            padding: 10px; display: flex; gap: 10px; background: #111;
        }
        .chat-input-area input { margin: 0; text-align: right; padding: 10px; }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); border:none; cursor: pointer; }

        .msg {
            background: #333; padding: 8px 12px; border-radius: 12px; width: fit-content; max-width: 80%;
            position: relative; font-size: 0.9rem;
        }
        .msg.mine { align-self: flex-end; background: #2d4503; color: var(--primary); }
        .msg-name { font-size: 0.7rem; color: #aaa; margin-bottom: 2px; display: block;}
        .msg-del { position: absolute; left: -20px; top: 5px; color: var(--danger); cursor: pointer; display: none;}
        .msg:hover .msg-del { display: block; } /* يظهر الحذف للمضيف عند اللمس */

        /* شريط التحكم السفلي */
        .controls {
            padding: 15px; display: flex; justify-content: center; gap: 15px;
            background: rgba(0,0,0,0.9); width: 100%;
        }
        .ctrl-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 1.2rem;
            background: #333; color: white; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .ctrl-btn.active { background: white; color: black; }
        .ctrl-btn.hangup { background: var(--danger); width: 60px; height: 60px; margin-top: -5px; }

        /* القوائم المنبثقة */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100; display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: var(--bg-card); width: 85%; max-width: 400px; border-radius: 20px; padding: 20px;
        }
        .req-item {
            display: flex; justify-content: space-between; align-items: center; background: #2a2a2a;
            padding: 10px; margin-bottom: 10px; border-radius: 10px;
        }
        .req-user img { width: 35px; height: 35px; border-radius: 50%; margin-left: 10px; vertical-align: middle;}
        .btn-xs { padding: 5px 12px; border-radius: 8px; border: none; cursor: pointer; margin-left: 5px; font-size: 0.8rem;}
        
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; display: none;}
    </style>
</head>
<body>

    <!-- === 1. شاشة التسجيل / الانتظار === -->
    <div id="setup-screen" class="screen active">
        <div class="logo-box"><i class="fa-solid fa-tower-broadcast"></i></div>
        <div class="form-box">
            <h2 style="margin-bottom: 20px;">Buz Voice</h2>
            
            <div class="avatar-select" onclick="document.getElementById('file-in').click()">
                <img id="avatar-prev" src="https://cdn-icons-png.flaticon.com/512/847/847969.png">
                <i class="fa-solid fa-camera"></i>
            </div>
            <input type="file" id="file-in" hidden accept="image/*">
            
            <input type="text" id="username" placeholder="اكتب اسمك هنا...">
            
            <div id="start-btns">
                <button id="create-btn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> إنشاء غرفة جديدة</button>
                <div id="join-area" style="display:none; width:100%">
                     <button id="join-btn" class="btn btn-primary"><i class="fa-solid fa-phone"></i> انضمام للمكالمة</button>
                     <p id="status-txt" style="color: var(--primary); margin-top:10px; font-size:0.9rem;"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- === 2. شاشة المكالمة === -->
    <div id="call-screen" class="screen">
        <div class="header">
            <div class="room-id" id="room-display">ID: ...</div>
            <div>
                <button class="ctrl-btn" style="width:40px; height:40px; background:transparent;" onclick="copyLink()">
                    <i class="fa-regular fa-copy"></i>
                </button>
                <button class="ctrl-btn" style="width:40px; height:40px; background:transparent; position:relative;" id="users-btn">
                    <i class="fa-solid fa-users"></i>
                    <span id="req-badge" class="badge">0</span>
                </button>
            </div>
        </div>

        <!-- شبكة الفيديو -->
        <div id="video-grid" class="video-grid grid-1">
            <!-- سيتم إضافة الفيديوهات هنا -->
        </div>

        <!-- الشات -->
        <div class="chat-container" id="chat-panel">
            <div class="chat-header" onclick="toggleChat()">
                <i class="fa-solid fa-grip-lines"></i> المحادثة
            </div>
            <div class="chat-messages" id="chat-list">
                <!-- الرسائل -->
            </div>
            <div class="chat-input-area">
                <input type="text" id="msg-input" placeholder="اكتب رسالة...">
                <button class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- التحكم -->
        <div class="controls">
            <button id="mic-btn" class="ctrl-btn active"><i class="fa-solid fa-microphone"></i></button>
            <button id="cam-btn" class="ctrl-btn active"><i class="fa-solid fa-video"></i></button>
            <button id="share-btn" class="ctrl-btn"><i class="fa-solid fa-desktop"></i></button>
            <button id="hangup-btn" class="ctrl-btn hangup"><i class="fa-solid fa-phone-slash"></i></button>
        </div>
    </div>

    <!-- قائمة المشاركين والطلبات -->
    <div id="users-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>المتواجدون / الطلبات</h3>
                <i class="fa-solid fa-xmark" onclick="document.getElementById('users-modal').style.display='none'" style="cursor:pointer"></i>
            </div>
            <div id="requests-list"></div>
            <hr style="border-color:#333; margin:10px 0;">
            <div id="participants-list"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, remove, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
            authDomain: "story-97cf7.firebaseapp.com",
            databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
            projectId: "story-97cf7",
            storageBucket: "story-97cf7.firebasestorage.app",
            messagingSenderId: "742801388214",
            appId: "1:742801388214:web:32a305a8057b0582c5ec17",
            measurementId: "G-9DPPWX7CF0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // متغيرات الحالة
        let myId = generateId();
        let roomId = null;
        let localStream;
        let myInfo = { name: "", avatar: "https://cdn-icons-png.flaticon.com/512/847/847969.png" }; // صورة افتراضية
        let myState = { mic: true, cam: true };
        let peers = {};
        let isHost = false;
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // --- 1. التحقق من البيانات المحفوظة (Auto Login) ---
        const savedData = localStorage.getItem('buz_user');
        if (savedData) {
            const parsed = JSON.parse(savedData);
            document.getElementById('username').value = parsed.name;
            if(parsed.avatar) {
                myInfo.avatar = parsed.avatar;
                document.getElementById('avatar-prev').src = parsed.avatar;
            }
        }

        // معالجة الرابط
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('room')) {
            roomId = urlParams.get('room');
            document.getElementById('create-btn').style.display = 'none';
            document.getElementById('join-area').style.display = 'block';
        }

        // معالجة رفع الصورة
        document.getElementById('file-in').addEventListener('change', async (e) => {
            if(e.target.files[0]) {
                const base64 = await resizeImage(e.target.files[0]);
                myInfo.avatar = base64;
                document.getElementById('avatar-prev').src = base64;
            }
        });

        // --- 2. إنشاء / انضمام ---
        document.getElementById('create-btn').addEventListener('click', async () => {
            if(!validateUser()) return;
            roomId = generateId();
            isHost = true;
            await set(ref(db, `rooms/${roomId}`), { created: Date.now(), hostId: myId });
            startCall();
        });

        document.getElementById('join-btn').addEventListener('click', async () => {
            if(!validateUser()) return;
            
            // التحقق من العدد (الحد الأقصى 4)
            const snap = await get(child(ref(db), `rooms/${roomId}/participants`));
            if(snap.exists() && Object.keys(snap.val()).length >= 4) {
                alert("الغرفة ممتلئة (الحد الأقصى 4 أشخاص)");
                return;
            }

            document.getElementById('status-txt').innerText = "جاري انتظار موافقة المضيف...";
            await set(ref(db, `rooms/${roomId}/requests/${myId}`), { info: myInfo, status: 'pending' });

            onValue(ref(db, `rooms/${roomId}/requests/${myId}/status`), (s) => {
                if(s.val() === 'accepted') startCall();
                else if(s.val() === 'rejected') document.getElementById('status-txt').innerText = "تم الرفض.";
            });
        });

        function validateUser() {
            const name = document.getElementById('username').value.trim();
            if(!name) { alert("اكتب اسمك أولاً"); return false; }
            myInfo.name = name;
            // حفظ البيانات للمستقبل
            localStorage.setItem('buz_user', JSON.stringify(myInfo));
            return true;
        }

        // --- 3. بدء المكالمة ---
        async function startCall() {
            document.getElementById('setup-screen').classList.remove('active');
            document.getElementById('call-screen').classList.add('active');
            document.getElementById('room-display').innerText = `ID: ${roomId}`;

            // استعادة حالة المايك/الكاميرا من آخر جلسة لو أمكن (اختياري)
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                // إضافة الفيديو الخاص بي
                addVideoCard(myId, myInfo, true);
                const vid = document.getElementById(`vid-${myId}`);
                vid.srcObject = localStream;
                vid.muted = true; // اكتم صوتك لنفسك
            } catch(e) {
                alert("يرجى السماح بالوصول للكاميرا والميكروفون");
            }

            // تسجيل الدخول في قاعدة البيانات
            await update(ref(db, `rooms/${roomId}/participants/${myId}`), {
                info: myInfo,
                state: myState
            });

            // تفعيل المستمعين
            monitorParticipants();
            monitorChat();
            if(isHost) monitorRequests();

            // الاستماع للطرد (Kick)
            onValue(ref(db, `rooms/${roomId}/participants/${myId}`), (snap) => {
                if(!snap.exists()) {
                    alert("تم إخراجك من المكالمة.");
                    location.reload();
                }
            });
        }

        // --- 4. نظام الفيديو والشبكة ---
        function addVideoCard(userId, info, isLocal) {
            if(document.getElementById(`card-${userId}`)) return;

            const div = document.createElement('div');
            div.className = 'video-card';
            div.id = `card-${userId}`;
            div.innerHTML = `
                <video id="vid-${userId}" autoplay playsinline></video>
                <div class="placeholder">
                    <img src="${info.avatar}" alt="Avatar">
                    <span style="color:#aaa">الكاميرا مغلقة</span>
                </div>
                <div class="user-tag">
                    <i class="fa-solid fa-microphone-slash mute-icon" id="mute-${userId}"></i>
                    <span>${info.name}</span>
                </div>
            `;
            document.getElementById('video-grid').appendChild(div);
            adjustGrid();
        }

        function adjustGrid() {
            const grid = document.getElementById('video-grid');
            const count = grid.children.length;
            grid.className = `video-grid grid-${count > 4 ? 4 : count}`;
        }

        // مراقبة المشاركين وتحديث حالتهم
        function monitorParticipants() {
            const pRef = ref(db, `rooms/${roomId}/participants`);
            onValue(pRef, (snap) => {
                const parts = snap.val() || {};
                
                // تحديث القائمة للمضيف (للطرد)
                updateParticipantsList(parts);

                // إضافة/تحديث المشاركين
                Object.keys(parts).forEach(uid => {
                    // تحديث الحالة (مايك/كاميرا)
                    updateUserStateUI(uid, parts[uid].state);

                    if (uid === myId) return;

                    if (!peers[uid]) {
                        // مستخدم جديد، أنشئ الكارد وابدأ WebRTC
                        addVideoCard(uid, parts[uid].info, false);
                        initWebRTC(uid);
                    }
                });

                // إزالة الخارجين
                Object.keys(peers).forEach(uid => {
                    if(!parts[uid]) {
                        document.getElementById(`card-${uid}`)?.remove();
                        peers[uid].close();
                        delete peers[uid];
                        adjustGrid();
                    }
                });
            });
            
            // WebRTC Signaling
            const sigRef = ref(db, `rooms/${roomId}/signals/${myId}`);
            onValue(sigRef, async (snap) => {
                const signals = snap.val();
                if(signals) {
                    for(const [key, msg] of Object.entries(signals)) {
                        await handleSignal(msg);
                        remove(child(sigRef, key));
                    }
                }
            });
        }

        function updateUserStateUI(uid, state) {
            const card = document.getElementById(`card-${uid}`);
            if(!card || !state) return;

            // تحديث أيقونة الكاميرا
            if(state.cam) {
                card.classList.remove('cam-off');
            } else {
                card.classList.add('cam-off');
            }

            // تحديث أيقونة المايك
            const micIcon = document.getElementById(`mute-${uid}`);
            if(micIcon) micIcon.style.display = state.mic ? 'none' : 'block';
        }

        // --- 5. منطق WebRTC (مبسط) ---
        async function initWebRTC(targetId) {
            const pc = new RTCPeerConnection(rtcConfig);
            peers[targetId] = pc;
            
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.ontrack = (e) => {
                const vid = document.getElementById(`vid-${targetId}`);
                if(vid) vid.srcObject = e.streams[0];
            };

            pc.onicecandidate = (e) => {
                if(e.candidate) sendSignal(targetId, { type: 'candidate', candidate: JSON.stringify(e.candidate) });
            };

            if(myId > targetId) { // منع التصادم
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                sendSignal(targetId, { type: 'offer', offer: JSON.stringify(offer) });
            }
        }

        async function handleSignal(msg) {
            const sender = msg.sender;
            if(!peers[sender]) { // لو أنا المستقبل
                // نحتاج لجلب بياناته أولاً لرسم الـ Card (في حالة تأخر onValue)
                const snap = await get(ref(db, `rooms/${roomId}/participants/${sender}`));
                addVideoCard(sender, snap.val().info, false);
                await initWebRTC(sender);
            }
            const pc = peers[sender];
            if(msg.type === 'offer') {
                await pc.setRemoteDescription(JSON.parse(msg.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                sendSignal(sender, { type: 'answer', answer: JSON.stringify(answer) });
            } else if(msg.type === 'answer') {
                await pc.setRemoteDescription(JSON.parse(msg.answer));
            } else if(msg.type === 'candidate') {
                pc.addIceCandidate(JSON.parse(msg.candidate));
            }
        }

        function sendSignal(to, data) {
            push(ref(db, `rooms/${roomId}/signals/${to}`), { sender: myId, ...data });
        }

        // --- 6. الشات ---
        function monitorChat() {
            const cRef = ref(db, `rooms/${roomId}/chat`);
            onValue(cRef, (snap) => {
                const msgs = snap.val();
                const list = document.getElementById('chat-list');
                list.innerHTML = '';
                if(msgs) {
                    Object.keys(msgs).forEach(key => {
                        const m = msgs[key];
                        const div = document.createElement('div');
                        div.className = `msg ${m.senderId === myId ? 'mine' : ''}`;
                        div.innerHTML = `
                            <span class="msg-name">${m.name}</span>
                            ${m.text}
                            ${isHost ? `<i class="fa-solid fa-trash msg-del" onclick="window.delMsg('${key}')"></i>` : ''}
                        `;
                        list.appendChild(div);
                    });
                    list.scrollTop = list.scrollHeight;
                }
            });
        }

        window.sendMessage = () => {
            const txt = document.getElementById('msg-input').value;
            if(!txt) return;
            push(ref(db, `rooms/${roomId}/chat`), {
                senderId: myId, name: myInfo.name, text: txt, time: Date.now()
            });
            document.getElementById('msg-input').value = '';
        };

        window.delMsg = (key) => { if(isHost) remove(ref(db, `rooms/${roomId}/chat/${key}`)); };
        window.toggleChat = () => { document.getElementById('chat-panel').classList.toggle('collapsed'); };

        // --- 7. التحكم (Host + User) ---
        // أزرار التحكم
        document.getElementById('mic-btn').addEventListener('click', (e) => {
            myState.mic = !myState.mic;
            localStream.getAudioTracks()[0].enabled = myState.mic;
            updateBtn(e.currentTarget, myState.mic, 'fa-microphone', 'fa-microphone-slash');
            updateMyStateDB();
        });

        document.getElementById('cam-btn').addEventListener('click', (e) => {
            myState.cam = !myState.cam;
            localStream.getVideoTracks()[0].enabled = myState.cam;
            updateBtn(e.currentTarget, myState.cam, 'fa-video', 'fa-video-slash');
            updateUserStateUI(myId, myState); // تحديث محلي فوري
            updateMyStateDB();
        });

        // مشاركة الشاشة
        document.getElementById('share-btn').addEventListener('click', async () => {
            try {
                const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const videoTrack = screenStream.getVideoTracks()[0];
                
                // استبدال التراك في كل الاتصالات
                Object.values(peers).forEach(pc => {
                    const sender = pc.getSenders().find(s => s.track.kind === 'video');
                    if(sender) sender.replaceTrack(videoTrack);
                });
                
                // تحديث الفيديو المحلي
                document.getElementById(`vid-${myId}`).srcObject = screenStream;
                
                videoTrack.onended = () => {
                    // العودة للكاميرا عند ايقاف المشاركة
                    const camTrack = localStream.getVideoTracks()[0];
                    Object.values(peers).forEach(pc => {
                        const sender = pc.getSenders().find(s => s.track.kind === 'video');
                        if(sender) sender.replaceTrack(camTrack);
                    });
                    document.getElementById(`vid-${myId}`).srcObject = localStream;
                };
            } catch(e) { console.error(e); }
        });

        function updateMyStateDB() {
            update(ref(db, `rooms/${roomId}/participants/${myId}/state`), myState);
        }

        function updateBtn(btn, isActive, iconOn, iconOff) {
            btn.className = `ctrl-btn ${isActive ? 'active' : ''}`;
            btn.innerHTML = `<i class="fa-solid ${isActive ? iconOn : iconOff}"></i>`;
        }

        // إدارة المستخدمين (Host)
        document.getElementById('users-btn').addEventListener('click', () => {
            document.getElementById('users-modal').style.display = 'flex';
        });

        function monitorRequests() {
            onValue(ref(db, `rooms/${roomId}/requests`), (snap) => {
                const list = document.getElementById('requests-list');
                list.innerHTML = '';
                const reqs = snap.val() || {};
                let count = 0;
                Object.keys(reqs).forEach(key => {
                    if(reqs[key].status === 'pending') {
                        count++;
                        list.innerHTML += `
                            <div class="req-item">
                                <div class="req-user">
                                    <img src="${reqs[key].info.avatar}"> 
                                    <span>${reqs[key].info.name}</span>
                                </div>
                                <div>
                                    <button class="btn-xs btn-primary" onclick="window.ansReq('${key}','accepted')">قبول</button>
                                    <button class="btn-xs btn-sec" onclick="window.ansReq('${key}','rejected')">رفض</button>
                                </div>
                            </div>
                        `;
                    }
                });
                const badge = document.getElementById('req-badge');
                if(count > 0) { badge.style.display='block'; badge.innerText = count; } 
                else { badge.style.display='none'; list.innerHTML='<div style="text-align:center; color:#555">لا توجد طلبات</div>'; }
            });
        }

        function updateParticipantsList(parts) {
            const list = document.getElementById('participants-list');
            list.innerHTML = '<h4 style="margin-bottom:10px; color:#888">المشاركون</h4>';
            Object.keys(parts).forEach(uid => {
                const p = parts[uid];
                list.innerHTML += `
                    <div class="req-item">
                        <div class="req-user">
                            <img src="${p.info.avatar}">
                            <span>${p.info.name} ${uid===myId ? '(أنت)' : ''}</span>
                        </div>
                        ${isHost && uid !== myId ? 
                          `<button class="btn-xs" style="background:var(--danger); color:white" onclick="window.kickUser('${uid}')">طرد</button>` 
                          : ''}
                    </div>
                `;
            });
        }

        // Global Actions
        window.ansReq = (uid, st) => update(ref(db, `rooms/${roomId}/requests/${uid}`), { status: st });
        window.kickUser = (uid) => remove(ref(db, `rooms/${roomId}/participants/${uid}`));
        window.copyLink = () => {
            navigator.clipboard.writeText(`${window.location.origin}${window.location.pathname}?room=${roomId}`);
            alert("تم نسخ الرابط");
        };
        document.getElementById('hangup-btn').addEventListener('click', () => location.reload());

        // Utilities
        function generateId() { return Math.random().toString(36).substr(2, 6); }
        function resizeImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        const scale = 100 / img.width;
                        cvs.width = 100; cvs.height = img.height * scale;
                        cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                        resolve(cvs.toDataURL('image/jpeg', 0.6));
                    }
                }
            });
        }
    </script>
</body>
</html>
