<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Buz Pro V4 - Fixed & Enhanced</title>
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Alexandria:wght@200;300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.js"></script>

    <style>
        /* --- Core Variables --- */
        :root {
            --primary: #CCFF00;
            --primary-dim: #a3cc00;
            --secondary: #7C3AED;
            --accent: #00D4FF;
            --dark-bg: #000000;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --danger: #FF3B30;
            --success: #30D158;
            --warning: #FF9F0A;
        }

        * { 
            font-family: 'Tajawal', 'Alexandria', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--dark-bg);
            color: white;
            min-height: 100dvh;
            overflow: hidden;
        }

        /* --- Filters CSS --- */
        .filter-none { filter: none; }
        .filter-soft { filter: contrast(1.1) brightness(1.1) saturate(1.1) blur(0.5px); } /* تنعيم */
        .filter-warm { filter: sepia(0.3) contrast(1.1) brightness(1.1); } /* دافئ */
        .filter-glow { filter: brightness(1.2) contrast(1.1) saturate(1.3); } /* إضاءة */
        .filter-bw { filter: grayscale(1) contrast(1.2); } /* أبيض وأسود */
        .filter-cinema { filter: contrast(1.3) saturate(1.2) sepia(0.2); } /* سينمائي */

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        /* --- Button System --- */
        .btn-primary {
            background: var(--primary);
            color: black;
            font-weight: 800;
            border-radius: 50px;
            padding: 16px 32px;
            transition: all 0.3s;
            box-shadow: 0 0 20px rgba(204, 255, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
        }
        .btn-primary:active { transform: scale(0.96); }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.12);
            color: white;
            font-weight: 600;
            border-radius: 50px;
            padding: 16px 28px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }

        /* --- Inputs --- */
        .floating-input {
            width: 100%;
            padding: 20px;
            background: #1A1A1A;
            border: 2px solid #333;
            border-radius: 18px;
            color: white;
            font-size: 18px;
            transition: 0.3s;
            outline: none;
        }
        .floating-input:focus {
            border-color: var(--primary);
            background: #000;
        }

        /* --- Screen System --- */
        .screen {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            background: var(--dark-bg);
            z-index: 100;
            transition: opacity 0.3s ease, transform 0.3s ease;
            overflow-y: auto;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .screen.hidden-screen { opacity: 0; pointer-events: none; transform: scale(0.95); z-index: 0; }
        .screen.active-screen { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 100; }

        /* --- Video Grid (Fix for Mobile) --- */
        .video-grid-container {
            display: grid;
            gap: 8px;
            padding: 8px;
            width: 100%;
            height: 100%;
            align-content: center;
            /* Important: Add padding at bottom so controls don't cover video */
            padding-bottom: 140px; 
            overflow-y: auto;
        }

        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
        
        @media (min-width: 768px) {
            .grid-2 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr; }
        }

        .video-card {
            position: relative;
            background: #111;
            border-radius: 20px;
            overflow: hidden;
            width: 100%;
            height: 100%;
            min-height: 200px;
        }

        .video-card video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect */
        }

        /* --- Controls --- */
        .control-dock {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 15, 15, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            border-radius: 40px;
            display: flex;
            gap: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            justify-content: space-between;
        }

        .dock-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            transition: 0.2s;
        }
        .dock-btn:active { transform: scale(0.9); }
        .dock-btn.off { background: rgba(255,255,255,0.05); color: #777; position: relative; }
        .dock-btn.off::after { content:''; position: absolute; width: 100%; height: 2px; background: #777; transform: rotate(45deg); }
        .dock-btn.danger { background: var(--danger); }
        .dock-btn.accent { background: var(--primary); color: black; }

        /* --- Large Preview in Lobby --- */
        .lobby-preview-wrapper {
            flex: 1;
            width: 100%;
            position: relative;
            border-radius: 30px;
            overflow: hidden;
            background: #111;
            margin: 10px 0;
            display: flex;
            flex-direction: column;
        }

        .lobby-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        /* Filter Selector */
        .filters-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 10px;
        }
        
        .filter-btn {
            min-width: 70px;
            height: 70px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            background: #222;
            color: #aaa;
            font-size: 0.7rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
        }
        .filter-btn.active {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(204, 255, 0, 0.1);
        }
        .filter-btn i { font-size: 1.2rem; }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #222;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            border: 1px solid #333;
            z-index: 9999;
            transition: 0.5s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* Loading */
        .loader {
            width: 20px; 
            height: 20px; 
            border: 3px solid #fff; 
            border-bottom-color: transparent; 
            border-radius: 50%; 
            display: inline-block; 
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fa-solid fa-info-circle text-primary"></i>
        <span id="toast-msg">رسالة النظام</span>
    </div>

    <!-- 1. SPLASH SCREEN -->
    <div id="screen-splash" class="screen active-screen">
        <div class="flex-1 flex flex-col items-center justify-center p-8 text-center">
            <div class="w-32 h-32 bg-primary rounded-3xl flex items-center justify-center text-6xl text-black mb-6 shadow-[0_0_40px_rgba(204,255,0,0.3)]">
                <i class="fa-solid fa-bolt"></i>
            </div>
            <h1 class="text-4xl font-black mb-2">Buz<span class="text-primary">Pro</span></h1>
            <p class="text-gray-400 mb-12">تجربة تواصل أسرع وأوضح</p>
            
            <button onclick="checkUserAndProceed()" class="btn-primary w-full max-w-sm">
                ابدأ الآن <i class="fa-solid fa-arrow-left"></i>
            </button>
        </div>
    </div>

    <!-- 2. NAME/PROFILE SCREEN -->
    <div id="screen-setup" class="screen hidden-screen">
        <div class="flex-1 flex flex-col p-6">
            <h2 class="text-2xl font-bold mb-6">من أنت؟</h2>
            
            <!-- Avatar -->
            <div class="flex flex-col items-center mb-8">
                <div class="relative w-32 h-32 mb-4">
                    <img id="avatar-preview" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="w-full h-full rounded-full object-cover border-4 border-[#222]">
                    <button onclick="document.getElementById('file-input').click()" class="absolute bottom-0 right-0 w-10 h-10 bg-primary rounded-full text-black flex items-center justify-center shadow-lg">
                        <i class="fa-solid fa-camera"></i>
                    </button>
                </div>
                <input type="file" id="file-input" hidden accept="image/*" onchange="handleAvatar(event)">
            </div>

            <!-- Inputs -->
            <div class="space-y-4">
                <input type="text" id="user-name" class="floating-input" placeholder="اكتب اسمك هنا" dir="auto">
            </div>

            <div class="flex-1"></div>
            
            <button onclick="saveAndContinue()" class="btn-primary w-full mt-6">
                استمرار <i class="fa-solid fa-check"></i>
            </button>
        </div>
    </div>

    <!-- 3. LOBBY SCREEN (Enhanced) -->
    <div id="screen-lobby" class="screen hidden-screen">
        <div class="flex flex-col h-full p-4">
            <!-- Top Header -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <img id="lobby-avatar" src="" class="w-10 h-10 rounded-full border border-white/20">
                    <div>
                        <h3 id="lobby-name" class="font-bold text-sm">...</h3>
                        <p class="text-[10px] text-primary">جاهز للاتصال</p>
                    </div>
                </div>
                <button onclick="openFilters()" class="w-10 h-10 rounded-full bg-[#222] text-white flex items-center justify-center">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                </button>
            </div>

            <!-- Large Preview Area -->
            <div class="lobby-preview-wrapper shadow-2xl border border-white/10">
                <video id="lobby-video" autoplay playsinline muted class="lobby-video"></video>
                
                <!-- Overlay Controls -->
                <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-4">
                    <button onclick="toggleLobbyMic()" id="btn-lobby-mic" class="w-12 h-12 rounded-full bg-white/20 backdrop-blur text-white flex items-center justify-center">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <button onclick="toggleLobbyCam()" id="btn-lobby-cam" class="w-12 h-12 rounded-full bg-white/20 backdrop-blur text-white flex items-center justify-center">
                        <i class="fa-solid fa-video"></i>
                    </button>
                </div>
            </div>

            <!-- Filters Selection (Horizontal Scroll) -->
            <div id="filters-area" class="filters-scroll">
                <div class="filter-btn active" onclick="applyFilter('filter-none', this)">
                    <i class="fa-solid fa-ban"></i>
                    <span>طبيعي</span>
                </div>
                <div class="filter-btn" onclick="applyFilter('filter-soft', this)">
                    <i class="fa-solid fa-spa"></i>
                    <span>ناعم</span>
                </div>
                <div class="filter-btn" onclick="applyFilter('filter-glow', this)">
                    <i class="fa-solid fa-lightbulb"></i>
                    <span>إضاءة</span>
                </div>
                <div class="filter-btn" onclick="applyFilter('filter-warm', this)">
                    <i class="fa-solid fa-sun"></i>
                    <span>دافئ</span>
                </div>
                <div class="filter-btn" onclick="applyFilter('filter-cinema', this)">
                    <i class="fa-solid fa-film"></i>
                    <span>سينما</span>
                </div>
                <div class="filter-btn" onclick="applyFilter('filter-bw', this)">
                    <i class="fa-solid fa-circle-half-stroke"></i>
                    <span>أسود</span>
                </div>
            </div>

            <!-- Join Controls -->
            <div class="mt-2 space-y-3">
                <div class="flex gap-2">
                    <input type="text" id="room-code" class="floating-input text-center font-mono text-xl tracking-widest uppercase" placeholder="KOD-123" maxlength="6">
                </div>
                <div class="flex gap-2">
                    <button onclick="createRoom()" class="btn-secondary flex-1 text-sm">
                        <i class="fa-solid fa-plus"></i> إنشاء
                    </button>
                    <button onclick="joinRoom()" class="btn-primary flex-[2]" id="join-btn">
                        <i class="fa-solid fa-rocket"></i> انضمام
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. CALL SCREEN -->
    <div id="screen-call" class="screen hidden-screen">
        <!-- Room ID Header -->
        <div class="fixed top-4 left-4 z-50 bg-black/50 backdrop-blur px-4 py-2 rounded-full border border-white/10 flex items-center gap-2">
            <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
            <span id="active-room-id" class="font-mono font-bold tracking-wider">...</span>
            <button onclick="copyLink()" class="mr-2 text-gray-400 hover:text-primary"><i class="fa-regular fa-copy"></i></button>
        </div>

        <!-- Video Grid -->
        <div id="video-grid" class="video-grid-container grid-1">
            <!-- Videos injected here -->
        </div>

        <!-- Bottom Controls -->
        <div class="control-dock">
            <button onclick="toggleMic()" id="call-mic-btn" class="dock-btn"><i class="fa-solid fa-microphone"></i></button>
            <button onclick="toggleCam()" id="call-cam-btn" class="dock-btn"><i class="fa-solid fa-video"></i></button>
            <button onclick="switchCamera()" class="dock-btn"><i class="fa-solid fa-camera-rotate"></i></button>
            <!-- Filter Toggle in Call -->
            <button onclick="cycleFilters()" class="dock-btn"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            <button onclick="leaveCall()" class="dock-btn danger"><i class="fa-solid fa-phone-slash"></i></button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, remove, get, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
            authDomain: "story-97cf7.firebaseapp.com",
            databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
            projectId: "story-97cf7",
            storageBucket: "story-97cf7.firebasestorage.app",
            messagingSenderId: "742801388214",
            appId: "1:742801388214:web:32a305a8057b0582c5ec17"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // State Variables
        let myId = localStorage.getItem('buz_uid') || 'u_' + Math.random().toString(36).substr(2, 6);
        localStorage.setItem('buz_uid', myId);
        
        let localStream;
        let myProfile = JSON.parse(localStorage.getItem('buz_profile')) || null;
        let currentRoom = null;
        let isHost = false;
        let peers = {}; // RTC Connections
        let currentFilter = 'filter-none';
        
        // --- Navigation Logic ---
        window.nextStep = (id) => {
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active-screen');
                s.classList.add('hidden-screen');
            });
            const target = document.getElementById(id);
            target.classList.remove('hidden-screen');
            target.classList.add('active-screen');
        };

        // --- 1. Startup Logic (Deep Link Fix) ---
        window.onload = () => {
            // Check for Room URL Parameter immediately
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            if(roomParam) {
                // Save to Session Storage so it survives the name setup
                sessionStorage.setItem('pending_room', roomParam);
            }
        };

        window.checkUserAndProceed = () => {
            if(myProfile) {
                initLobby();
            } else {
                nextStep('screen-setup');
            }
        };

        // --- 2. Profile Setup ---
        window.handleAvatar = (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (ev) => document.getElementById('avatar-preview').src = ev.target.result;
                reader.readAsDataURL(file);
            }
        };

        window.saveAndContinue = () => {
            const name = document.getElementById('user-name').value.trim();
            if(!name) return showToast("الرجاء كتابة اسمك");

            myProfile = {
                name: name,
                avatar: document.getElementById('avatar-preview').src,
                id: myId
            };
            localStorage.setItem('buz_profile', JSON.stringify(myProfile));
            initLobby();
        };

        // --- 3. Lobby Logic (Enhanced) ---
        async function initLobby() {
            nextStep('screen-lobby');
            document.getElementById('lobby-name').textContent = myProfile.name;
            document.getElementById('lobby-avatar').src = myProfile.avatar;

            // Start Camera
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } }, 
                    audio: true 
                });
                const vid = document.getElementById('lobby-video');
                vid.srcObject = localStream;
                vid.classList.add(currentFilter); // Apply saved filter
            } catch(e) {
                showToast("تعذر الوصول للكاميرا");
            }

            // CHECK FOR PENDING JOIN (The Fix)
            const pendingRoom = sessionStorage.getItem('pending_room');
            if(pendingRoom) {
                document.getElementById('room-code').value = pendingRoom;
                showToast("تم اكتشاف رابط دعوة، اضغط انضمام");
                // Optional: Automatically click join if you prefer
                // joinRoom(); 
            }
        }

        // --- 4. Join/Create Logic ---
        window.createRoom = () => {
            const roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
            currentRoom = roomId;
            isHost = true;
            
            // Create in DB
            set(ref(db, `rooms/${roomId}`), {
                host: myId,
                created: Date.now()
            });

            enterCall();
        };

        window.joinRoom = () => {
            const roomId = document.getElementById('room-code').value.trim().toUpperCase();
            if(roomId.length < 3) return showToast("كود الغرفة غير صحيح");
            
            const btn = document.getElementById('join-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loader"></span> جاري الطلب...';

            currentRoom = roomId;
            isHost = false;

            // 1. Send Request
            const reqRef = ref(db, `rooms/${roomId}/requests/${myId}`);
            set(reqRef, {
                name: myProfile.name,
                avatar: myProfile.avatar,
                status: 'pending',
                timestamp: Date.now()
            });

            // 2. Listen for Response (Fixing the "Not Joining" bug)
            onValue(reqRef, (snapshot) => {
                const data = snapshot.val();
                if(!data) return; // Removed or null

                if(data.status === 'accepted') {
                    // Success! Remove listener and join
                    btn.innerHTML = originalText;
                    enterCall();
                    // Clean up request
                    remove(reqRef);
                } else if (data.status === 'rejected') {
                    btn.innerHTML = originalText;
                    showToast("تم رفض طلب الانضمام", true);
                }
            });

            // Timeout fallback
            setTimeout(() => {
                if(document.getElementById('screen-lobby').classList.contains('active-screen')) {
                    btn.innerHTML = originalText;
                    // Keep waiting or tell user?
                }
            }, 10000);
        };

        // --- 5. Call Logic ---
        async function enterCall() {
            nextStep('screen-call');
            document.getElementById('active-room-id').textContent = currentRoom;

            // Add Myself to Grid
            addVideoTile(myId, localStream, myProfile.name, true);

            // Register in Participants
            const pRef = ref(db, `rooms/${currentRoom}/participants/${myId}`);
            set(pRef, {
                name: myProfile.name,
                avatar: myProfile.avatar,
                online: true
            });
            onDisconnect(pRef).remove();

            // Initialize WebRTC (Simplified for brevity - Mesh Topology)
            initWebRTC();

            if(isHost) {
                // Host listens for requests
                onValue(ref(db, `rooms/${currentRoom}/requests`), (snap) => {
                    const reqs = snap.val() || {};
                    Object.entries(reqs).forEach(([uid, info]) => {
                        if(info.status === 'pending') {
                            if(confirm(`هل تقبل انضمام ${info.name}؟`)) {
                                update(ref(db, `rooms/${currentRoom}/requests/${uid}`), { status: 'accepted' });
                            } else {
                                update(ref(db, `rooms/${currentRoom}/requests/${uid}`), { status: 'rejected' });
                            }
                        }
                    });
                });
            }
        }

        // --- UI Functions ---
        function addVideoTile(uid, stream, name, isMe = false) {
            if(document.getElementById(`vid-container-${uid}`)) return;

            const div = document.createElement('div');
            div.id = `vid-container-${uid}`;
            div.className = 'video-card animate__animated animate__zoomIn';
            div.innerHTML = `
                <video id="vid-${uid}" autoplay playsinline ${isMe ? 'muted' : ''} class="${isMe ? currentFilter : ''}"></video>
                <div class="absolute bottom-2 right-2 bg-black/60 px-2 py-1 rounded-lg text-xs backdrop-blur">
                    ${name} ${isMe ? '(أنت)' : ''}
                </div>
            `;
            document.getElementById('video-grid').appendChild(div);
            
            const vidObj = document.getElementById(`vid-${uid}`);
            vidObj.srcObject = stream;

            updateGridClass();
        }

        function updateGridClass() {
            const container = document.getElementById('video-grid');
            const count = container.children.length;
            container.className = `video-grid-container grid-${count > 1 ? '2' : '1'}`;
        }

        // --- Filter System ---
        window.applyFilter = (filterName, btnElement) => {
            currentFilter = filterName;
            
            // Update UI buttons
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');

            // Apply to Lobby Video
            const lobbyVid = document.getElementById('lobby-video');
            if(lobbyVid) lobbyVid.className = `lobby-video ${filterName}`;

            // Apply to Call Video (if active)
            const myCallVid = document.getElementById(`vid-${myId}`);
            if(myCallVid) myCallVid.className = filterName;
        };

        const filtersList = ['filter-none', 'filter-soft', 'filter-glow', 'filter-warm', 'filter-cinema', 'filter-bw'];
        window.cycleFilters = () => {
            let idx = filtersList.indexOf(currentFilter);
            idx = (idx + 1) % filtersList.length;
            const nextFilter = filtersList[idx];
            currentFilter = nextFilter;
            
            const myCallVid = document.getElementById(`vid-${myId}`);
            if(myCallVid) myCallVid.className = nextFilter;
            showToast("تم تغيير الفلتر");
        };

        // --- Simple WebRTC Signaling (Essential) ---
        function initWebRTC() {
            // Listen for other participants
            onValue(ref(db, `rooms/${currentRoom}/participants`), (snap) => {
                const users = snap.val() || {};
                Object.keys(users).forEach(uid => {
                    if(uid !== myId && !peers[uid]) {
                        initConnection(uid);
                    }
                });
                // Remove left users
                Object.keys(peers).forEach(pId => {
                    if(!users[pId]) {
                        document.getElementById(`vid-container-${pId}`)?.remove();
                        peers[pId].close();
                        delete peers[pId];
                        updateGridClass();
                    }
                });
            });

            // Listen for signals
            onValue(ref(db, `rooms/${currentRoom}/signals/${myId}`), (snap) => {
                const msgs = snap.val() || {};
                Object.entries(msgs).forEach(async ([key, msg]) => {
                    if(msg.type === 'offer') {
                        await handleOffer(msg);
                    } else if (msg.type === 'answer') {
                        await peers[msg.sender].setRemoteDescription(JSON.parse(msg.sdp));
                    } else if (msg.type === 'candidate') {
                        try { await peers[msg.sender].addIceCandidate(JSON.parse(msg.candidate)); } catch(e){}
                    }
                    remove(ref(db, `rooms/${currentRoom}/signals/${myId}/${key}`));
                });
            });
        }

        async function initConnection(targetId) {
            const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            peers[targetId] = pc;

            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.ontrack = (e) => addVideoTile(targetId, e.streams[0], "مشترك");

            pc.onicecandidate = (e) => {
                if(e.candidate) {
                    push(ref(db, `rooms/${currentRoom}/signals/${targetId}`), {
                        type: 'candidate', sender: myId, candidate: JSON.stringify(e.candidate)
                    });
                }
            };

            // If I am the older ID (or logic to prevent duplicate offers), create offer
            if(myId > targetId) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                push(ref(db, `rooms/${currentRoom}/signals/${targetId}`), {
                    type: 'offer', sender: myId, sdp: JSON.stringify(offer)
                });
            }
        }

        async function handleOffer(msg) {
            const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            peers[msg.sender] = pc;
            
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            pc.ontrack = (e) => addVideoTile(msg.sender, e.streams[0], "مشترك");
            pc.onicecandidate = (e) => {
                if(e.candidate) push(ref(db, `rooms/${currentRoom}/signals/${msg.sender}`), { type: 'candidate', sender: myId, candidate: JSON.stringify(e.candidate) });
            };

            await pc.setRemoteDescription(JSON.parse(msg.sdp));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            
            push(ref(db, `rooms/${currentRoom}/signals/${msg.sender}`), {
                type: 'answer', sender: myId, sdp: JSON.stringify(answer)
            });
        }

        // --- Helpers ---
        window.toggleMic = () => {
            const enabled = localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled;
            document.getElementById('call-mic-btn').classList.toggle('off', !enabled);
        };
        window.toggleCam = () => {
            const enabled = localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled;
            document.getElementById('call-cam-btn').classList.toggle('off', !enabled);
        };
        window.leaveCall = () => location.reload();
        window.copyLink = () => {
            const link = `${location.origin}${location.pathname}?room=${currentRoom}`;
            navigator.clipboard.writeText(link);
            showToast("تم نسخ الرابط");
        };

        window.showToast = (msg, error = false) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('show');
            if(error) t.style.borderColor = 'red';
            setTimeout(() => t.classList.remove('show'), 3000);
        };
    </script>
</body>
</html>
