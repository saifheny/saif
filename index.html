<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>تطبيق الاجتماعات المطور</title>
    <!-- مكتبة الأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6C63FF;
            --danger: #FF6584;
            --success: #00E096;
            --dark: #1F2029;
            --darker: #15161C;
            --glass: rgba(255, 255, 255, 0.1);
            --border: rgba(255, 255, 255, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--darker);
            color: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* شاشات الدخول */
        .full-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--darker);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: opacity 0.5s;
        }

        .hidden { display: none !important; }

        .card {
            background: var(--dark);
            padding: 30px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid var(--border);
        }

        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: var(--darker);
            border: 1px solid var(--border);
            color: white;
            border-radius: 10px;
            outline: none;
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        
        button:active { transform: scale(0.98); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--border); }

        /* رفع الصورة */
        .avatar-upload {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            border-radius: 50%;
            background: var(--glass);
            overflow: hidden;
            border: 2px dashed var(--primary);
            cursor: pointer;
        }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-upload i { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; color: var(--primary); }

        /* واجهة الفيديو */
        #main-interface {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100%;
        }

        /* شبكة الفيديوهات */
        #video-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(45%, 1fr));
            gap: 10px;
            padding: 10px;
            overflow-y: auto;
            align-content: center;
        }

        .video-card {
            background: #252630;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 9/16; /* مناسب للموبايل */
            max-height: 400px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        /* إذا كان هناك مستخدم واحد فقط */
        .video-card:only-child { aspect-ratio: auto; max-height: 80vh; }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* مرآة */
        }

        /* حالة الفيديو المغلق */
        .no-video-placeholder {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #252630;
            z-index: 1;
        }
        .no-video-placeholder img { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--primary); margin-bottom: 10px; }

        /* معلومات المستخدم فوق الفيديو */
        .user-info {
            position: absolute; bottom: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 2;
        }
        .user-name {
            background: rgba(0,0,0,0.6);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            backdrop-filter: blur(5px);
        }
        .status-icons {
            display: flex; gap: 5px;
        }
        .status-icon {
            background: rgba(255, 69, 58, 0.8);
            width: 24px; height: 24px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px;
        }

        /* لوحة التحكم السفلية */
        .controls-bar {
            background: rgba(31, 32, 41, 0.95);
            padding: 15px 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top-left-radius: 25px;
            border-top-right-radius: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .control-btn {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: none;
            background: #333;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        .control-btn.active { background: var(--primary); }
        .control-btn.danger { background: var(--danger); }

        /* القوائم الجانبية (الشات والطلبات) */
        .side-panel {
            position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 80px);
            background: var(--darker);
            z-index: 50;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            display: flex; flex-direction: column;
            padding: 20px;
        }
        .side-panel.open { transform: translateY(0); }
        
        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border);
        }

        /* الشات */
        #chat-messages { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
        .message { padding: 10px; border-radius: 10px; background: var(--dark); max-width: 80%; position: relative; }
        .message.mine { align-self: flex-end; background: var(--primary); }
        .msg-sender { font-size: 10px; opacity: 0.7; margin-bottom: 2px; display: block; }
        .msg-text { font-size: 14px; }
        .chat-input-area { display: flex; gap: 10px; }

        /* قائمة الطلبات */
        .request-item {
            background: var(--dark); padding: 15px; border-radius: 10px;
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;
        }
        .req-info { display: flex; align-items: center; gap: 10px; }
        .req-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .req-actions { display: flex; gap: 5px; }

        /* رسائل التنبيه */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #333; padding: 10px 20px; border-radius: 20px;
            z-index: 2000; font-size: 14px; opacity: 0; pointer-events: none; transition: 0.3s;
        }
    </style>
</head>
<body>

    <!-- 1. شاشة تسجيل الدخول (تظهر مرة واحدة) -->
    <div id="login-screen" class="full-screen">
        <div class="card">
            <h2>مرحباً بك</h2>
            <p>سجل بياناتك للبدء</p>
            
            <div class="avatar-upload" onclick="document.getElementById('avatar-input').click()">
                <img id="avatar-preview" src="" style="display:none">
                <i id="avatar-icon" class="fas fa-camera"></i>
            </div>
            <input type="file" id="avatar-input" accept="image/*" hidden onchange="handleAvatarUpload(this)">
            
            <input type="text" id="username-input" placeholder="اسمك">
            <button onclick="saveUserAndContinue()">متابعة</button>
        </div>
    </div>

    <!-- 2. شاشة اللوبي (اختيار الغرفة) -->
    <div id="lobby-screen" class="full-screen hidden">
        <div class="card">
            <img id="user-avatar-display" src="" class="req-avatar" style="width: 80px; height: 80px; margin-bottom: 15px;">
            <h3 id="welcome-msg">أهلاً</h3>
            <button class="btn-success" onclick="createNewRoom()">إنشاء مكالمة جديدة</button>
            <p style="margin: 15px 0; opacity: 0.5;">- أو -</p>
            <input type="text" id="room-code-input" placeholder="رابط أو كود الغرفة">
            <button class="btn-outline" onclick="joinRoomFromInput()">انضمام</button>
        </div>
    </div>

    <!-- 3. شاشة الانتظار -->
    <div id="waiting-screen" class="full-screen hidden">
        <div class="card">
            <i class="fas fa-hourglass-half fa-3x" style="color: var(--primary); margin-bottom: 20px;"></i>
            <h3>في انتظار الموافقة...</h3>
            <p>لقد أرسلت طلباً للمضيف. يرجى الانتظار.</p>
        </div>
    </div>

    <!-- 4. واجهة المكالمة الرئيسية -->
    <div id="main-interface" class="hidden">
        <!-- شبكة الفيديو -->
        <div id="video-grid">
            <!-- سيتم إضافة الفيديوهات هنا ديناميكياً -->
        </div>

        <!-- الأزرار السفلية -->
        <div class="controls-bar">
            <button class="control-btn" onclick="toggleAudio()" id="mic-btn"><i class="fas fa-microphone"></i></button>
            <button class="control-btn" onclick="toggleVideo()" id="cam-btn"><i class="fas fa-video"></i></button>
            
            <button class="control-btn danger" onclick="leaveRoom()"><i class="fas fa-phone-slash"></i></button>
            
            <button class="control-btn" onclick="togglePanel('chat')">
                <i class="fas fa-comment-dots"></i>
            </button>
            
            <button class="control-btn" id="requests-btn" onclick="togglePanel('requests')" style="display:none">
                <i class="fas fa-users-cog"></i>
                <span id="req-badge" style="position:absolute; top:0; right:0; width:10px; height:10px; background:red; border-radius:50%; display:none;"></span>
            </button>
            
            <button class="control-btn" onclick="copyRoomLink()"><i class="fas fa-link"></i></button>
        </div>

        <!-- لوحة الشات -->
        <div id="chat-panel" class="side-panel">
            <div class="panel-header">
                <h3>المحادثة</h3>
                <button class="control-btn" style="width:30px;height:30px" onclick="togglePanel('chat')"><i class="fas fa-times"></i></button>
            </div>
            <div id="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" id="msg-input" placeholder="اكتب رسالة...">
                <button style="width: 50px; margin: 10px 0;" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- لوحة الطلبات (للمشرف فقط) -->
        <div id="requests-panel" class="side-panel">
            <div class="panel-header">
                <h3>طلبات الدخول</h3>
                <button class="control-btn" style="width:30px;height:30px" onclick="togglePanel('requests')"><i class="fas fa-times"></i></button>
            </div>
            <div id="requests-list">
                <p style="text-align:center; opacity:0.5;">لا توجد طلبات جديدة</p>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">تم نسخ الرابط</div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, remove, onChildAdded, onChildRemoved, get, child } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
            authDomain: "story-97cf7.firebaseapp.com",
            databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
            projectId: "story-97cf7",
            storageBucket: "story-97cf7.firebasestorage.app",
            messagingSenderId: "742801388214",
            appId: "1:742801388214:web:32a305a8057b0582c5ec17",
            measurementId: "G-9DPPWX7CF0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // متغيرات عامة
        let localStream;
        let peerConnections = {}; 
        let user = JSON.parse(localStorage.getItem('cal_user')) || null;
        let roomId = null;
        let isHost = false;
        
        // إعدادات WebRTC
        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
            ]
        };

        // ======================================================
        // 1. إدارة المستخدم والصور
        // ======================================================
        
        window.handleAvatarUpload = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // ضغط الصورة قبل الحفظ لتجنب امتلاء الذاكرة
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 150; // تصغير الصورة
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        const compressedData = canvas.toDataURL('image/jpeg', 0.7);
                        document.getElementById('avatar-preview').src = compressedData;
                        document.getElementById('avatar-preview').style.display = 'block';
                        document.getElementById('avatar-icon').style.display = 'none';
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.saveUserAndContinue = () => {
            const name = document.getElementById('username-input').value;
            const avatar = document.getElementById('avatar-preview').src;
            
            if (!name) return alert('الرجاء كتابة الاسم');
            
            const userId = 'user_' + Math.floor(Math.random() * 1000000);
            user = { 
                id: userId, 
                name: name, 
                avatar: avatar || 'https://via.placeholder.com/150', // صورة افتراضية
                videoOn: true,
                audioOn: true
            };
            
            localStorage.setItem('cal_user', JSON.stringify(user));
            checkLoginStatus();
        }

        function checkLoginStatus() {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('lobby-screen').classList.remove('hidden');
                document.getElementById('welcome-msg').innerText = `أهلاً، ${user.name}`;
                document.getElementById('user-avatar-display').src = user.avatar;
                
                // التحقق مما إذا كان هناك رابط غرفة في URL
                const urlParams = new URLSearchParams(window.location.search);
                const urlRoomId = urlParams.get('room');
                if (urlRoomId) {
                    roomId = urlRoomId;
                    joinRoomLogic();
                }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }
        
        // تشغيل عند البدء
        checkLoginStatus();

        // ======================================================
        // 2. إدارة الغرف والدخول
        // ======================================================

        window.createNewRoom = async () => {
            roomId = Math.random().toString(36).substring(2, 9);
            isHost = true;
            
            // إنشاء الغرفة في قاعدة البيانات
            await set(ref(db, `rooms/${roomId}`), {
                host: user.id,
                created: Date.now()
            });
            
            startMeeting();
        };

        window.joinRoomFromInput = () => {
            const input = document.getElementById('room-code-input').value;
            if (!input) return;
            // استخراج كود الغرفة لو كان رابطاً
            roomId = input.includes('room=') ? input.split('room=')[1] : input;
            joinRoomLogic();
        };

        async function joinRoomLogic() {
            // التحقق من وجود الغرفة
            const snapshot = await get(ref(db, `rooms/${roomId}`));
            if (!snapshot.exists()) {
                alert("الغرفة غير موجودة!");
                return;
            }

            const roomData = snapshot.val();
            if (roomData.host === user.id) {
                isHost = true;
                startMeeting();
            } else {
                // إرسال طلب انضمام
                document.getElementById('lobby-screen').classList.add('hidden');
                document.getElementById('waiting-screen').classList.remove('hidden');
                
                await set(ref(db, `rooms/${roomId}/requests/${user.id}`), {
                    name: user.name,
                    avatar: user.avatar,
                    id: user.id
                });
                
                // الاستماع لقبول الطلب
                onValue(ref(db, `rooms/${roomId}/participants/${user.id}`), (snapshot) => {
                    if (snapshot.exists()) {
                        document.getElementById('waiting-screen').classList.add('hidden');
                        startMeeting();
                    }
                });
            }
        }

        // ======================================================
        // 3. منطق الاجتماع و WebRTC
        // ======================================================

        async function startMeeting() {
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            
            // تحديث العنوان
            window.history.pushState({}, '', `?room=${roomId}`);

            // 1. الحصول على الميديا
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                addVideoStream(user.id, localStream, true, user);
            } catch (err) {
                console.error("Error media", err);
                // التعامل مع عدم وجود كاميرا
                localStream = new MediaStream(); // تيار فارغ
            }
            
            // 2. تسجيل الدخول في قائمة المشاركين
            const userRef = ref(db, `rooms/${roomId}/participants/${user.id}`);
            update(userRef, {
                id: user.id,
                name: user.name,
                avatar: user.avatar,
                videoOn: true,
                audioOn: true
            });
            
            // التعامل عند الخروج
            onDisconnect(userRef).remove();

            // 3. إعداد المستمعين (Listeners)
            setupRoomListeners();

            // 4. إذا كنت المضيف، استمع للطلبات
            if (isHost) {
                document.getElementById('requests-btn').style.display = 'block';
                setupRequestListeners();
            }
        }

        function setupRoomListeners() {
            // عند دخول شخص جديد
            onChildAdded(ref(db, `rooms/${roomId}/participants`), async (snapshot) => {
                const newUser = snapshot.val();
                if (newUser.id === user.id) return;
                
                // بدء الاتصال (WebRTC)
                // القاعدة: الأحدث ينشئ العرض (Offer) للأقدم لتقليل التصادم
                // هنا سنستخدم نهجاً بسيطاً: المضيف ومن معه يتصلون بالجديد
                
                createPeerConnection(newUser.id, true); // Initiator
            });
            
            // عند خروج شخص
            onChildRemoved(ref(db, `rooms/${roomId}/participants`), (snapshot) => {
                const leftUser = snapshot.val();
                removeVideoStream(leftUser.id);
                if (peerConnections[leftUser.id]) {
                    peerConnections[leftUser.id].close();
                    delete peerConnections[leftUser.id];
                }
            });

            // الاستماع لحالة الميكروفون والكاميرا للآخرين
            onValue(ref(db, `rooms/${roomId}/participants`), (snapshot) => {
                const users = snapshot.val();
                for (let id in users) {
                    updateUserUIStatus(id, users[id]);
                }
            });

            // الاستماع لإشارات WebRTC (Offer/Answer/Ice)
            onChildAdded(ref(db, `rooms/${roomId}/signals/${user.id}`), async (snapshot) => {
                const data = snapshot.val();
                const senderId = data.sender;
                
                if (!peerConnections[senderId]) {
                    createPeerConnection(senderId, false);
                }
                
                const pc = peerConnections[senderId];
                
                if (data.type === 'offer') {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    
                    push(ref(db, `rooms/${roomId}/signals/${senderId}`), {
                        type: 'answer',
                        answer: answer,
                        sender: user.id
                    });
                } else if (data.type === 'answer') {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                } else if (data.type === 'candidate') {
                    try {
                        await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                    } catch (e) { console.error("Error adding ice", e); }
                }
                
                // حذف الإشارة بعد معالجتها
                remove(ref(db, `rooms/${roomId}/signals/${user.id}/${snapshot.key}`));
            });

            // الاستماع للشات
            onChildAdded(ref(db, `rooms/${roomId}/chat`), (snapshot) => {
                appendMessage(snapshot.val(), snapshot.key);
            });
        }

        function createPeerConnection(targetId, isInitiator) {
            if (peerConnections[targetId]) return;
            
            const pc = new RTCPeerConnection(servers);
            peerConnections[targetId] = pc;
            
            // إضافة المسارات المحلية
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            
            // عند استقبال مسار (فيديو/صوت)
            pc.ontrack = (event) => {
                // التأكد من وجود عنصر الفيديو
                const remoteStream = event.streams[0];
                // نحتاج لجلب بيانات المستخدم لعرض الاسم والصورة
                get(ref(db, `rooms/${roomId}/participants/${targetId}`)).then((snap) => {
                    if (snap.exists()) {
                        addVideoStream(targetId, remoteStream, false, snap.val());
                    }
                });
            };
            
            // عند وجود مرشح ICE
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    push(ref(db, `rooms/${roomId}/signals/${targetId}`), {
                        type: 'candidate',
                        candidate: event.candidate.toJSON(),
                        sender: user.id
                    });
                }
            };

            if (isInitiator) {
                pc.onnegotiationneeded = async () => {
                    try {
                        const offer = await pc.createOffer();
                        await pc.setLocalDescription(offer);
                        push(ref(db, `rooms/${roomId}/signals/${targetId}`), {
                            type: 'offer',
                            offer: offer,
                            sender: user.id
                        });
                    } catch (err) { console.error(err); }
                };
            }
            
            return pc;
        }

        // ======================================================
        // 4. دوال واجهة المستخدم (UI)
        // ======================================================

        function addVideoStream(userId, stream, isLocal, userData) {
            const grid = document.getElementById('video-grid');
            if (document.getElementById(`vid-wrap-${userId}`)) return; // موجود بالفعل

            const wrap = document.createElement('div');
            wrap.className = 'video-card';
            wrap.id = `vid-wrap-${userId}`;
            
            // عنصر الفيديو
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            if (isLocal) video.muted = true; // كتم الصوت المحلي
            
            // طبقة "الفيديو مغلق"
            const placeholder = document.createElement('div');
            placeholder.className = 'no-video-placeholder';
            placeholder.id = `place-${userId}`;
            placeholder.style.display = 'none'; // مخفي افتراضياً
            placeholder.innerHTML = `
                <img src="${userData.avatar}">
                <p>${userData.name}</p>
            `;

            // معلومات المستخدم
            const info = document.createElement('div');
            info.className = 'user-info';
            info.innerHTML = `
                <span class="user-name">${isLocal ? 'أنت' : userData.name}</span>
                <div class="status-icons">
                    <div id="mic-stat-${userId}" class="status-icon" style="display:none"><i class="fas fa-microphone-slash"></i></div>
                </div>
            `;
            
            // أزرار التحكم للإدمن (طرد، كتم) على فيديو الآخرين
            if (isHost && !isLocal) {
                const adminControls = document.createElement('div');
                adminControls.style.cssText = "position:absolute; top:10px; left:10px; z-index:10;";
                adminControls.innerHTML = `
                    <button onclick="kickUser('${userId}')" style="background:red; color:white; border:none; border-radius:5px; padding:2px 5px; font-size:10px;">طرد</button>
                `;
                wrap.appendChild(adminControls);
            }

            wrap.appendChild(video);
            wrap.appendChild(placeholder);
            wrap.appendChild(info);
            grid.appendChild(wrap);
            
            updateUserUIStatus(userId, userData);
        }

        function removeVideoStream(userId) {
            const el = document.getElementById(`vid-wrap-${userId}`);
            if (el) el.remove();
        }

        function updateUserUIStatus(userId, data) {
            if (!data) return;
            const micIcon = document.getElementById(`mic-stat-${userId}`);
            const placeholder = document.getElementById(`place-${userId}`);
            
            // تحديث أيقونة المايك
            if (micIcon) micIcon.style.display = data.audioOn ? 'none' : 'flex';
            
            // تحديث عرض الفيديو (إذا الفيديو مغلق تظهر الصورة)
            if (placeholder) placeholder.style.display = data.videoOn ? 'none' : 'flex';
        }

        // ======================================================
        // 5. أدوات التحكم (أزرار)
        // ======================================================

        window.toggleAudio = () => {
            const track = localStream.getAudioTracks()[0];
            if (track) {
                track.enabled = !track.enabled;
                const btn = document.getElementById('mic-btn');
                btn.innerHTML = track.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
                btn.classList.toggle('danger', !track.enabled);
                
                update(ref(db, `rooms/${roomId}/participants/${user.id}`), { audioOn: track.enabled });
            }
        }

        window.toggleVideo = () => {
            const track = localStream.getVideoTracks()[0];
            if (track) {
                track.enabled = !track.enabled;
                const btn = document.getElementById('cam-btn');
                btn.innerHTML = track.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
                btn.classList.toggle('danger', !track.enabled);
                
                update(ref(db, `rooms/${roomId}/participants/${user.id}`), { videoOn: track.enabled });
            }
        }

        window.leaveRoom = () => {
            if (confirm("هل تريد مغادرة المكالمة؟")) {
                window.location.href = window.location.pathname; // إعادة تحميل الصفحة
            }
        };

        window.copyRoomLink = () => {
            const url = window.location.origin + window.location.pathname + '?room=' + roomId;
            navigator.clipboard.writeText(url);
            const toast = document.getElementById('toast');
            toast.style.opacity = 1;
            setTimeout(() => toast.style.opacity = 0, 2000);
        };

        window.togglePanel = (type) => {
            const panel = document.getElementById(type === 'chat' ? 'chat-panel' : 'requests-panel');
            panel.classList.toggle('open');
        };

        // ======================================================
        // 6. إدارة الشات
        // ======================================================

        window.sendMessage = () => {
            const input = document.getElementById('msg-input');
            const txt = input.value;
            if (!txt) return;
            
            push(ref(db, `rooms/${roomId}/chat`), {
                sender: user.name,
                senderId: user.id,
                text: txt,
                time: Date.now()
            });
            input.value = '';
        };

        function appendMessage(msg, key) {
            const box = document.getElementById('chat-messages');
            const div = document.createElement('div');
            const isMe = msg.senderId === user.id;
            div.className = `message ${isMe ? 'mine' : ''}`;
            
            // زر الحذف للمضيف
            let deleteBtn = '';
            if (isHost) {
                deleteBtn = `<span onclick="deleteMsg('${key}')" style="color:red; cursor:pointer; float:left; margin-right:5px;">&times;</span>`;
            }

            div.innerHTML = `
                ${deleteBtn}
                <span class="msg-sender">${isMe ? 'أنت' : msg.sender}</span>
                <span class="msg-text">${msg.text}</span>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        window.deleteMsg = (key) => {
            if(isHost) remove(ref(db, `rooms/${roomId}/chat/${key}`));
            // ملاحظة: لإزالة الرسالة من الشاشة فورياً يحتاج الأمر لمستمع onChildRemoved منفصل للشات
            // للتبسيط، سيتم حذفها من قاعدة البيانات، ولن تختفي من شاشات المستخدمين الحاليين حتى إعادة التحميل
            // أو يمكن إضافة مستمع remove ببساطة.
            document.querySelectorAll('.message').forEach(el => {
                if (el.innerHTML.includes(`deleteMsg('${key}')`)) el.remove();
            });
        };

        // ======================================================
        // 7. إدارة الطلبات (Admin Only)
        // ======================================================

        function setupRequestListeners() {
            onChildAdded(ref(db, `rooms/${roomId}/requests`), (snapshot) => {
                const req = snapshot.val();
                const list = document.getElementById('requests-list');
                document.getElementById('req-badge').style.display = 'block';
                
                // إزالة رسالة "لا توجد طلبات"
                if(list.children[0]?.tagName === 'P') list.innerHTML = '';

                const div = document.createElement('div');
                div.className = 'request-item';
                div.id = `req-${req.id}`;
                div.innerHTML = `
                    <div class="req-info">
                        <img src="${req.avatar}" class="req-avatar">
                        <span>${req.name}</span>
                    </div>
                    <div class="req-actions">
                        <button class="btn-success" style="padding:5px 10px; width:auto;" onclick="acceptUser('${req.id}', '${snapshot.key}')"><i class="fas fa-check"></i></button>
                        <button class="btn-danger" style="padding:5px 10px; width:auto;" onclick="rejectUser('${req.id}', '${snapshot.key}')"><i class="fas fa-times"></i></button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        window.acceptUser = (userId, reqKey) => {
            // نقل البيانات من requests إلى participants
            get(ref(db, `rooms/${roomId}/requests/${userId}`)).then((snap) => {
                const data = snap.val();
                update(ref(db, `rooms/${roomId}/participants/${userId}`), {
                    id: data.id,
                    name: data.name,
                    avatar: data.avatar,
                    videoOn: true,
                    audioOn: true
                });
                remove(ref(db, `rooms/${roomId}/requests/${userId}`));
                document.getElementById(`req-${userId}`).remove();
            });
        };

        window.rejectUser = (userId, reqKey) => {
            remove(ref(db, `rooms/${roomId}/requests/${userId}`));
            document.getElementById(`req-${userId}`).remove();
        };

        window.kickUser = (userId) => {
            if(confirm("هل أنت متأكد من طرد هذا المستخدم؟")) {
                remove(ref(db, `rooms/${roomId}/participants/${userId}`));
                // إجبار المستخدم على الخروج عبر إشارة خاصة أو الاعتماد على onChildRemoved لديه
                // هنا سنعتمد على removeVideo لديه ولكن لإجباره فعلياً نحتاج تحديث حالته
            }
        };
        
        // مساعدة لـ onDisconnect في Firebase القديم (غير متوفرة مباشرة في v9 modular بنفس الطريقة السهلة بدون استيراد)
        import { onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    </script>
</body>
</html>
