Ø¹Ø²Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Modal Behavior): Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø£Ùˆ Ø²Ø± "Ø°Ù‡Ø§Ø¨"ØŒ ØªØ¸Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¢Ù† ÙƒÙ€ "Modal" (Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©) ØªØ¹Ø²Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù† Ø§Ù„Ø®Ù„ÙÙŠØ©ØŒ Ù…Ù…Ø§ ÙŠØ­Ø³Ù† Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±ØŒ ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª.

ØªØ­Ø³ÙŠÙ† Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ø®Ù„ÙÙŠØ©): ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ØªØµÙ…ÙŠÙ… Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù (Discover Card) Ù„Ø¬Ø¹Ù„ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù…Ø± ÙˆØ§Ù„Ø¬Ù†Ø³ Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ø§Ù‹ ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¯Ø§ÙƒÙ†Ø© Ø£Ùˆ Ø§Ù„ÙØ§ØªØ­Ø©.

ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙˆØ§Ù„Ù€ UX (Modern/Open Source):

Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ GSAP (GreenSock): Ø§Ø³ØªØ®Ø¯Ù…Øª Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„ØªÙ†ÙÙŠØ° Ø­Ø±ÙƒØ§Øª Ø³Ù„Ø³Ø© ÙˆØ¹ØµØ±ÙŠØ© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø§Øª ÙˆØ§Ù„Ù€ "Modals".

ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ (Glassmorphism): ØªØ¹Ù…ÙŠÙ‚ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù€ "Glassmorphism" Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª Ù†Ø§Ø¹Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„ØªØ¨Ø¯Ùˆ Ø£ÙƒØ«Ø± Ø¬ÙˆØ¯Ø©.

ØªØºÙŠÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©: Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø¨Ø£Ø®Ø±Ù‰ Ù…ØªØ­Ø±ÙƒØ© Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„.

ØªÙØ¶Ù„ Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø« Ø§Ù„Ø°ÙŠ ÙŠØ¶Ù… Ù‡Ø°Ù‡ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª:

Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ØªÙŠ Ø·Ù„Ø¨ØªÙ‡Ø§:

Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ø²ÙˆÙ„ (Modal): ØªÙ… ØªØ­ÙˆÙŠÙ„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¥Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…Ø¹Ø²ÙˆÙ„Ø© Ø¹Ù† Ø§Ù„Ø®Ù„ÙÙŠØ©ØŒ ÙˆØ¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø°Ù‡Ø§Ø¨"ØŒ ÙŠØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.

ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙˆØ¶ÙˆØ­ (Gender/Age Badge): ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø´Ø±ÙŠØ· "Ø±Ø¬Ù„/Ø§Ù…Ø±Ø£Ø©" Ùˆ"Ø§Ù„Ø¹Ù…Ø±" ÙÙŠ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù Ù„ÙŠÙƒÙˆÙ† Ø¨Ø®Ù„ÙÙŠØ© Ø´Ø¨Ù‡ Ø´ÙØ§ÙØ© Ø¯Ø§ÙƒÙ†Ø© ÙˆÙ†Øµ Ø£Ø¨ÙŠØ¶ (background: rgba(0, 0, 0, 0.7); color: white;) Ù„Ø¶Ù…Ø§Ù† ÙˆØ¶ÙˆØ­Ù‡ Ø§Ù„ØªØ§Ù… ÙÙˆÙ‚ Ø£ÙŠ ØµÙˆØ±Ø©.

Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ·ÙˆØ± (GSAP): Ø¯Ù…Ø¬Øª Ù…ÙƒØªØ¨Ø© GSAP (ÙˆÙ‡ÙŠ Ù…ÙƒØªØ¨Ø© Ø±Ø³ÙˆÙ… Ù…ØªØ­Ø±ÙƒØ© Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ù…ØµØ¯Ø± ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©) Ù„ØªÙ†ÙÙŠØ° Ø­Ø±ÙƒØ§Øª Ø§Ù†ØªÙ‚Ø§Ù„ Ø³Ù„Ø³Ø© ÙˆÙ…Ù…ÙŠØ²Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§ÙØ° (Ù…Ø«Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù€ Modals) Ù…Ù…Ø§ ÙŠÙ…Ù†Ø­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¸Ù‡Ø±Ø§Ù‹ Ø¹ØµØ±ÙŠØ§Ù‹ ÙˆÙ…Ù…ÙŠØ²Ø§Ù‹ Ø¬Ø¯Ø§Ù‹.   <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© ÙˆØµØ§Ù„ Ù„Ù„ØªØ¹Ø§Ø±Ù ÙˆØ§Ù„Ø²ÙˆØ§Ø¬</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root {
            --primary: #ec4899; /* Pink-500 */
            --primary-dark: #be185d;
            --secondary: #8b5cf6; /* Violet-500 */
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --glass: rgba(17, 24, 39, 0.85);
            --border: rgba(236, 72, 153, 0.2);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --gradient: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            --gold: #fbbf24;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 10% 20%, rgba(236, 72, 153, 0.1) 0%, transparent 20%),
                              radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 20%);
            height: 100vh; height: 100dvh; width: 100%;
            overflow: hidden; position: fixed;
            color: var(--text-main); display: flex; flex-direction: column;
        }

        /* --- Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© (Ø§Ù„Ù‚Ù„ÙˆØ¨) --- */
        .hearts-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; pointer-events: none; z-index: 0; opacity: 0.3;
        }
        .floating-heart {
            position: absolute; bottom: -20px;
            color: var(--primary); font-size: 20px;
            animation: floatUp 10s linear infinite;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            20% { opacity: 0.8; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        /* --- Ø´Ø§Ø´Ø§Øª ÙƒØ§Ù…Ù„Ø© --- */
        .full-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a; z-index: 2000;
            display: flex; flex-direction: column; overflow-y: auto;
        }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ --- */
        .login-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100%; padding: 20px; z-index: 2001;
        }
        
        .logo-area { text-align: center; margin-bottom: 30px; animation: fadeInDown 1s; }
        .logo-icon { 
            font-size: 4rem; background: var(--gradient); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 10px; filter: drop-shadow(0 0 10px rgba(236,72,153,0.3));
        }
        .app-title { font-size: 2rem; font-weight: 800; letter-spacing: -1px; margin-bottom: 5px; }
        .app-slogan { color: var(--text-muted); font-size: 0.9rem; }

        .form-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            padding: 25px; border-radius: 24px; width: 100%; max-width: 400px;
            backdrop-filter: blur(10px); animation: fadeInUp 0.8s;
        }

        .input-group { margin-bottom: 15px; }
        .input-label { display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-muted); }
        .input-field-styled {
            width: 100%; padding: 14px; background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
            color: white; font-size: 0.95rem; outline: none; transition: 0.3s;
        }
        .input-field-styled:focus { border-color: var(--primary); background: rgba(0,0,0,0.4); }
        
        /* Avatar Upload Style */
        .avatar-upload {
            width: 100px; height: 100px; border-radius: 50%;
            background: rgba(255,255,255,0.05); border: 2px dashed var(--border);
            margin: 0 auto 15px; display: flex; justify-content: center; align-items: center;
            cursor: pointer; overflow: hidden; position: relative;
        }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-upload:hover { border-color: var(--primary); }

        .select-row { display: flex; gap: 10px; }
        .select-btn {
            flex: 1; padding: 12px; border-radius: 12px;
            background: rgba(255,255,255,0.05); cursor: pointer;
            border: 1px solid transparent; text-align: center; font-size: 0.9rem;
            transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .select-btn.active { background: var(--primary); border-color: white; box-shadow: 0 0 15px rgba(236,72,153,0.4); }

        .btn-gradient {
            width: 100%; padding: 16px; margin-top: 10px;
            background: var(--gradient); border: none; border-radius: 14px;
            color: white; font-weight: bold; font-size: 1.1rem;
            cursor: pointer; box-shadow: 0 5px 20px rgba(236,72,153,0.3);
            transition: 0.3s transform;
        }
        .btn-gradient:active { transform: scale(0.98); }

        /* --- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
        .main-layout { display: none; flex-direction: column; height: 100%; width: 100%; z-index: 100; }
        
        /* Header */
        .app-header {
            height: 65px; padding: 0 15px; background: var(--glass);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0; backdrop-filter: blur(10px); position: relative;
        }
        .header-title { font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        .header-actions { display: flex; gap: 10px; }
        .icon-btn { 
            background: transparent; border: none; color: white; 
            font-size: 1.2rem; cursor: pointer; padding: 5px; position: relative;
        }

        /* Notif Dropdown */
        .notif-dropdown {
            position: absolute; top: 65px; left: 10px;
            background: #1e293b; border: 1px solid var(--border);
            border-radius: 16px; padding: 0; width: 280px;
            display: none; flex-direction: column; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 200; overflow: hidden;
            max-height: 300px; overflow-y: auto;
        }
        .notif-item { 
            padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); 
            font-size: 0.85rem; color: #eee; display: flex; align-items: center; justify-content: space-between; gap: 10px;
            background: rgba(255,255,255,0.02);
        }
        .notif-item:last-child { border-bottom: none; }
        .notif-btn-go {
            background: var(--primary); color: white; border: none; padding: 5px 12px;
            border-radius: 20px; font-size: 0.75rem; cursor: pointer; white-space: nowrap;
        }
        
        /* Content Area */
        .content-area { flex: 1; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        
        /* Bottom Navigation */
        .bottom-nav {
            height: 70px; background: var(--glass);
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-around; align-items: center;
            flex-shrink: 0; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: var(--text-muted); text-decoration: none; cursor: pointer;
            width: 60px; transition: 0.3s;
        }
        .nav-item i { font-size: 1.3rem; margin-bottom: 2px; transition: 0.3s; }
        .nav-item span { font-size: 0.7rem; font-weight: 500; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-3px); text-shadow: 0 5px 10px rgba(236,72,153,0.5); }
        .nav-badge {
            position: absolute; top: -5px; right: -5px;
            background: var(--primary); color: white;
            font-size: 0.6rem; padding: 2px 5px; border-radius: 10px;
            border: 1px solid #1e293b;
        }

        /* --- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù (Cards) --- */
        .users-grid {
            padding: 15px; display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px;
        }
        .user-card {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 18px; overflow: hidden; position: relative;
            transition: 0.3s; cursor: pointer;
        }
        .user-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .user-card-img {
            height: 140px; width: 100%; background: #2a2a2a;
            display: flex; justify-content: center; align-items: center; font-size: 3rem; color: #555;
            position: relative; overflow: hidden;
        }
        .user-card-img img { width: 100%; height: 100%; object-fit: cover; }
        .user-status-dot {
            position: absolute; bottom: 10px; right: 10px;
            width: 12px; height: 12px; background: #22c55e;
            border-radius: 50%; border: 2px solid #1e293b;
        }
        .user-card-info { padding: 12px; }
        .user-card-name { font-weight: bold; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-card-details { font-size: 0.75rem; color: var(--text-muted); margin-top: 3px; }
        .gender-badge {
            position: absolute; top: 10px; left: 10px;
            padding: 3px 8px; border-radius: 20px; font-size: 0.7rem;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        }

        /* --- Ø§Ù„Ø´Ø§Øª --- */
        .chat-container { display: flex; flex-direction: column; height: 100%; }
        .messages-list { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .msg-bubble { 
            max-width: 80%; padding: 12px 16px; border-radius: 20px; 
            position: relative; font-size: 0.95rem; line-height: 1.5;
        }
        .msg-mine { 
            align-self: flex-end; background: var(--gradient); 
            color: white; border-bottom-left-radius: 20px; border-bottom-right-radius: 4px;
        }
        .msg-theirs { 
            align-self: flex-start; background: rgba(51, 65, 85, 0.8); border: 1px solid rgba(255,255,255,0.1);
            color: white; border-bottom-left-radius: 4px; border-bottom-right-radius: 20px;
        }
        
        /* Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ·Ù„Ø¨Ø§Øª Ø²ÙˆØ§Ø¬ */
        .gift-msg { 
            text-align: center; background: rgba(255,255,255,0.05) !important; 
            border: 2px solid var(--gold); padding: 20px;
        }
        .gift-icon { font-size: 3rem; margin-bottom: 5px; display: block; animation: pulse 2s infinite; }
        
        .proposal-msg {
            background: linear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%);
            color: #881337; border: 2px solid #be185d;
            text-align: center; padding: 20px; box-shadow: 0 5px 20px rgba(236,72,153,0.3);
        }
        .proposal-header { font-family: serif; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; display:block; }
        
        .chat-input-area {
            padding: 10px; background: var(--glass); display: flex; align-items: center; gap: 8px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .chat-input {
            flex: 1; background: rgba(255,255,255,0.05); border: none;
            padding: 12px 15px; border-radius: 25px; color: white; outline: none;
        }
        .action-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: rgba(255,255,255,0.05); color: var(--text-muted);
            cursor: pointer; transition: 0.3s; display: flex; justify-content: center; align-items: center;
        }
        .action-btn:hover { color: var(--primary); background: rgba(236,72,153,0.1); }
        .send-btn { background: var(--primary); color: white; }

        /* --- Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modals) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 3000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); padding: 20px;
        }
        .modal-content {
            background: #1e293b; border-radius: 24px; padding: 25px;
            width: 100%; max-width: 340px; position: relative;
            border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: zoomIn 0.3s;
        }
        .close-modal { position: absolute; top: 15px; left: 15px; color: #999; cursor: pointer; font-size: 1.2rem; }
        
        .profile-header { text-align: center; margin-bottom: 20px; }
        .profile-avatar-lg {
            width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 10px;
            background: #333; display: flex; justify-content: center; align-items: center;
            font-size: 2.5rem; border: 3px solid var(--primary); overflow: hidden;
        }
        .profile-avatar-lg img { width: 100%; height: 100%; object-fit: cover; }
        .profile-stat-row { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; font-size: 0.9rem; color: #ccc; }
        
        .gift-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .gift-item { 
            font-size: 2rem; padding: 10px; background: rgba(255,255,255,0.05); 
            border-radius: 12px; cursor: pointer; transition: 0.2s; text-align: center; 
        }
        .gift-item:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); }

        /* --- Toast Notification --- */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: rgba(15, 23, 42, 0.95); padding: 12px 25px;
            border-radius: 50px; border: 1px solid var(--primary);
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 10px 30px rgba(236,72,153,0.3);
            z-index: 4000; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            white-space: nowrap; pointer-events: none;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* Stickers Menu */
        .stickers-menu {
            position: absolute; bottom: 70px; right: 10px; width: 250px;
            background: #1e293b; border-radius: 15px; border: 1px solid var(--border);
            padding: 10px; display: none; grid-template-columns: repeat(4, 1fr); gap: 5px;
            z-index: 100; max-height: 200px; overflow-y: auto;
        }

    </style>
</head>
<body>

    <!-- Ø®Ù„ÙÙŠØ© Ø§Ù„Ù‚Ù„ÙˆØ¨ -->
    <div class="hearts-bg" id="heartsBg"></div>

    <!-- Ø§Ù„Ø£ØµÙˆØ§Øª -->
    <audio id="sndMsg" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>
    <audio id="sndNotif" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
    <audio id="sndMatch" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
    <div id="loginScreen" class="full-screen login-container">
        <div class="logo-area">
            <i class="fa-solid fa-infinity logo-icon"></i>
            <h1 class="app-title">ÙˆØµØ§Ù„</h1>
            <p class="app-slogan">Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„Ù‚Ù„ÙˆØ¨ ÙˆØ§Ù„Ø£Ø±ÙˆØ§Ø­</p>
        </div>

        <div class="form-card">
            <div class="input-group" style="text-align: center;">
                <label class="input-label">ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
                <div class="avatar-upload" onclick="document.getElementById('avatarInput').click()">
                    <img id="avatarPreview" src="" style="display:none;">
                    <i id="avatarPlaceholder" class="fa-solid fa-camera fa-2x" style="color: #666;"></i>
                </div>
                <input type="file" id="avatarInput" accept="image/*" style="display: none" onchange="handleAvatarSelect(this)">
            </div>

            <div class="input-group">
                <label class="input-label">Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±</label>
                <input type="text" id="regName" class="input-field-styled" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." maxlength="15">
            </div>

            <div class="input-group">
                <label class="input-label">Ø§Ù„Ø¹Ù…Ø±</label>
                <input type="number" id="regAge" class="input-field-styled" placeholder="Ù…Ø«Ù„Ø§Ù‹: 25">
            </div>

            <div class="input-group">
                <label class="input-label">Ø§Ù„Ø¬Ù†Ø³</label>
                <div class="select-row">
                    <div class="select-btn" onclick="selectGender('male', this)">
                        <i class="fa-solid fa-mars"></i> Ø±Ø¬Ù„
                    </div>
                    <div class="select-btn" onclick="selectGender('female', this)">
                        <i class="fa-solid fa-venus"></i> Ø§Ù…Ø±Ø£Ø©
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</label>
                <select id="regStatus" class="input-field-styled">
                    <option value="single">Ø£Ø¹Ø²Ø¨ / Ø¹Ø²Ø¨Ø§Ø¡</option>
                    <option value="divorced">Ù…Ø·Ù„Ù‚ / Ù…Ø·Ù„Ù‚Ø©</option>
                    <option value="widowed">Ø£Ø±Ù…Ù„ / Ø£Ø±Ù…Ù„Ø©</option>
                    <option value="married">Ù…ØªØ²ÙˆØ¬ / Ù…ØªØ²ÙˆØ¬Ø©</option>
                </select>
            </div>

            <div class="input-group">
                <label class="input-label">Ù‡Ø¯Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</label>
                <select id="regGoal" class="input-field-styled">
                    <option value="marriage">Ø²ÙˆØ§Ø¬ Ø´Ø±Ø¹ÙŠ</option>
                    <option value="friendship">ØµØ¯Ø§Ù‚Ø© Ù…Ø­ØªØ±Ù…Ø©</option>
                    <option value="chat">Ø¯Ø±Ø¯Ø´Ø© Ø¹Ø§Ù…Ø©</option>
                </select>
            </div>

            <p style="font-size: 0.7rem; color: #aaa; margin-top: 10px;">
                <input type="checkbox" id="termsCheck"> Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ§Ù„Ø§Ø­ØªØ±Ø§Ù… Ø§Ù„Ù…ØªØ¨Ø§Ø¯Ù„.
            </p>

            <button class="btn-gradient" onclick="registerUser()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©</button>
        </div>
    </div>

    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="mainApp" class="main-layout">
        
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <div class="app-header">
            <div class="header-title" id="headerTitle">
                <i class="fa-solid fa-infinity" style="color: var(--primary)"></i> ÙˆØµØ§Ù„
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleNotifPanel()">
                    <i class="fa-regular fa-bell"></i>
                    <span class="nav-badge" id="notifCount" style="display:none">0</span>
                </button>
                <button class="icon-btn" onclick="logout()"><i class="fa-solid fa-arrow-right-from-bracket"></i></button>
            </div>
            
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© -->
            <div id="notifPanel" class="notif-dropdown">
                <div id="notifListContainer"></div>
                <div class="notif-item" id="emptyNotifMsg" style="text-align:center; color:#666; justify-content:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>
            </div>
        </div>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (ÙŠØªØ¨Ø¯Ù„ Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨) -->
        <div class="content-area" id="contentArea">
            
            <!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) -->
            <div id="tab-discover" class="tab-content">
                <div style="padding: 15px; display: flex; gap: 10px;">
                    <select class="input-field-styled" style="padding: 8px;" onchange="filterUsers(this.value)">
                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                        <option value="male">Ø±Ø¬Ø§Ù„</option>
                        <option value="female">Ù†Ø³Ø§Ø¡</option>
                    </select>
                </div>
                <div class="users-grid" id="usersGrid">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª -->
                    <div style="text-align: center; grid-column: 1/-1; padding: 50px; color: #666;">
                        <i class="fa-solid fa-spinner fa-spin fa-2x"></i><br><br>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ Ø­ÙŠØ§ØªÙƒ...
                    </div>
                </div>
            </div>

            <!-- 2. Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
            <div id="tab-chats" class="tab-content" style="display: none;">
                <div class="messages-list" id="activeChatsList">
                    <p style="text-align: center; color: #666; margin-top: 50px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù†Ø´Ø·Ø©</p>
                </div>
            </div>

            <!-- 3. Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ -->
            <div id="tab-profile" class="tab-content" style="display: none; padding: 20px;">
                <div style="text-align: center;">
                    <div class="profile-avatar-lg" id="myAvatarDisplay"></div>
                    <h2 id="myNameDisplay" style="margin-bottom: 5px;">User</h2>
                    <p id="myDetailsDisplay" style="color: var(--primary); margin-bottom: 20px;">ØªÙØ§ØµÙŠÙ„</p>
                    
                    <div class="form-card" style="margin: 0 auto;">
                        <h3 style="margin-bottom: 15px; font-size: 1rem;">Ù†Ø¨Ø°Ø© Ø¹Ù†ÙŠ</h3>
                        <textarea id="myBioInput" class="input-field-styled" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹ Ø¹Ù† Ù†ÙØ³Ùƒ Ù„Ø¬Ø°Ø¨ Ø´Ø±ÙŠÙƒ Ø­ÙŠØ§ØªÙƒ..."></textarea>
                        <button class="btn-gradient" onclick="updateBio()" style="margin-top: 10px; font-size: 0.9rem;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                    </div>
                </div>
            </div>

            <!-- 4. Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (ØªØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„ÙƒÙ„) -->
            <div id="chatScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 1000; display: none; flex-direction: column;">
                <div class="app-header">
                    <div class="header-title">
                        <button class="icon-btn" onclick="closeChat()"><i class="fa-solid fa-arrow-right"></i></button>
                        <span id="chatPartnerName">Ø§Ù„Ø§Ø³Ù…</span>
                    </div>
                    <div class="header-actions">
                        <button class="icon-btn" style="color: var(--primary);" onclick="sendProposalUI()"><i class="fa-solid fa-ring"></i></button>
                        <button class="icon-btn" onclick="showPartnerProfile()"><i class="fa-solid fa-circle-info"></i></button>
                    </div>
                </div>
                
                <div class="messages-list" id="chatMessages"></div>
                
                <div class="chat-input-area">
                    <button class="action-btn" onclick="toggleStickers()"><i class="fa-regular fa-face-smile"></i></button>
                    <button class="action-btn" onclick="showGiftModal()"><i class="fa-solid fa-gift" style="color: var(--gold)"></i></button>
                    <input type="text" id="msgInput" class="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
                    <button class="action-btn send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>

                <div class="stickers-menu" id="stickersMenu">
                    <span onclick="sendSticker('ğŸ‘‹')">ğŸ‘‹</span>
                    <span onclick="sendSticker('â¤ï¸')">â¤ï¸</span>
                    <span onclick="sendSticker('ğŸŒ¹')">ğŸŒ¹</span>
                    <span onclick="sendSticker('ğŸ¥°')">ğŸ¥°</span>
                    <span onclick="sendSticker('ğŸ’')">ğŸ’</span>
                    <span onclick="sendSticker('ğŸ¤²')">ğŸ¤²</span>
                    <span onclick="sendSticker('âœ¨')">âœ¨</span>
                    <span onclick="sendSticker('ğŸ«')">ğŸ«</span>
                </div>
            </div>

        </div>

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ -->
        <div class="bottom-nav">
            <a onclick="switchTab('discover')" class="nav-item active" id="nav-discover">
                <i class="fa-solid fa-earth-americas"></i>
                <span>Ø§Ø³ØªÙƒØ´Ù</span>
            </a>
            <a onclick="switchTab('chats')" class="nav-item" id="nav-chats">
                <i class="fa-solid fa-comments"></i>
                <span>Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙŠ</span>
            </a>
            <a onclick="switchTab('profile')" class="nav-item" id="nav-profile">
                <i class="fa-solid fa-user"></i>
                <span>Ù…Ù„ÙÙŠ</span>
            </a>
        </div>
    </div>

    <!-- Modal: Ø¨Ø·Ø§Ù‚Ø© Ù…Ø³ØªØ®Ø¯Ù… -->
    <div id="userModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('userModal')">&times;</span>
            <div class="profile-header">
                <div class="profile-avatar-lg" id="modalUserAvatar"></div>
                <h2 id="modalUserName">Ø§Ø³Ù…</h2>
                <div id="modalUserBadges" style="margin-top:5px;"></div>
            </div>
            
            <div class="profile-stat-row">
                <span id="modalUserAge"></span>
                <span id="modalUserStatus"></span>
                <span id="modalUserCity"></span>
            </div>

            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px; min-height: 60px;">
                <p id="modalUserBio" style="font-size: 0.9rem; line-height: 1.4; color: #ddd;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø¨Ø°Ø©</p>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-gradient" style="flex: 2" onclick="startChatFromModal()">Ù…Ø±Ø§Ø³Ù„Ø© <i class="fa-solid fa-comment-dots"></i></button>
                <button class="btn-gradient" style="flex: 1; background: #333;" onclick="sendPoke()"><i class="fa-solid fa-hand-point-up"></i></button>
            </div>
        </div>
    </div>

    <!-- Modal: Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ -->
    <div id="giftModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('giftModal')">&times;</span>
            <h3 style="text-align: center; margin-bottom: 15px;">Ø£Ø±Ø³Ù„ Ù‡Ø¯ÙŠØ©</h3>
            <div class="gift-grid">
                <div class="gift-item" onclick="sendGift('rose', 'ğŸŒ¹')">ğŸŒ¹<br><span style="font-size:0.6rem">ÙˆØ±Ø¯Ø©</span></div>
                <div class="gift-item" onclick="sendGift('choco', 'ğŸ«')">ğŸ«<br><span style="font-size:0.6rem">Ø´ÙˆÙƒÙˆÙ„Ø§</span></div>
                <div class="gift-item" onclick="sendGift('ring', 'ğŸ’')">ğŸ’<br><span style="font-size:0.6rem">Ø®Ø§ØªÙ…</span></div>
                <div class="gift-item" onclick="sendGift('coffee', 'â˜•')">â˜•<br><span style="font-size:0.6rem">Ù‚Ù‡ÙˆØ©</span></div>
                <div class="gift-item" onclick="sendGift('heart', 'ğŸ’–')">ğŸ’–<br><span style="font-size:0.6rem">Ù‚Ù„Ø¨</span></div>
                <div class="gift-item" onclick="sendGift('crown', 'ğŸ‘‘')">ğŸ‘‘<br><span style="font-size:0.6rem">ØªØ§Ø¬</span></div>
                <div class="gift-item" onclick="sendGift('car', 'ğŸš—')">ğŸš—<br><span style="font-size:0.6rem">Ø³ÙŠØ§Ø±Ø©</span></div>
                <div class="gift-item" onclick="sendGift('house', 'ğŸ¡')">ğŸ¡<br><span style="font-size:0.6rem">Ø¨ÙŠØª</span></div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">
        <i class="fa-solid fa-bell" style="color: var(--primary)"></i>
        <span id="toastMsg">Ø±Ø³Ø§Ù„Ø©</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, onValue, update, remove, set, serverTimestamp, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
            authDomain: "story-97cf7.firebaseapp.com",
            databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
            projectId: "story-97cf7",
            storageBucket: "story-97cf7.firebasestorage.app",
            messagingSenderId: "742801388214",
            appId: "1:742801388214:web:32a305a8057b0582c5ec17"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- State ---
        let currentUser = JSON.parse(localStorage.getItem('wessal_user') || 'null');
        let selectedGender = '';
        let tempAvatar = "";
        let activeUsers = {};
        let currentChatId = null;
        let currentChatPartner = null;
        let notifications = [];

        // --- Init ---
        function initHearts() {
            const container = document.getElementById('heartsBg');
            for(let i=0; i<15; i++) {
                const heart = document.createElement('div');
                heart.className = 'floating-heart';
                heart.innerHTML = Math.random() > 0.5 ? 'â¤ï¸' : 'ğŸ’–';
                heart.style.left = Math.random() * 100 + '%';
                heart.style.animationDuration = (Math.random() * 5 + 5) + 's';
                heart.style.animationDelay = (Math.random() * 5) + 's';
                container.appendChild(heart);
            }
        }
        initHearts();

        if (currentUser) {
            initApp();
        }

        // --- Auth & Image Functions ---
        window.selectGender = (g, el) => {
            selectedGender = g;
            document.querySelectorAll('.select-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        };

        window.handleAvatarSelect = (input) => {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if(file.size > 150000) { alert('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ØµØºØ± (Ø£Ù‚Ù„ Ù…Ù† 150kb)'); return; }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    tempAvatar = e.target.result;
                    document.getElementById('avatarPreview').src = tempAvatar;
                    document.getElementById('avatarPreview').style.display = 'block';
                    document.getElementById('avatarPlaceholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        };

        window.registerUser = () => {
            const name = document.getElementById('regName').value.trim();
            const age = document.getElementById('regAge').value.trim();
            const status = document.getElementById('regStatus').value;
            const goal = document.getElementById('regGoal').value;
            const terms = document.getElementById('termsCheck').checked;

            if(!tempAvatar) { showToast('ÙŠØ¬Ø¨ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„'); return; }
            if(!name || !age || !selectedGender || !terms) {
                showToast('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ·');
                return;
            }
            if(age < 18) { showToast('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù…Ù† Ù‡Ù… ÙÙˆÙ‚ 18 Ø¹Ø§Ù…Ø§Ù‹ ÙÙ‚Ø·'); return; }

            const uid = 'u_' + Date.now() + Math.random().toString(36).substr(2, 4);
            currentUser = {
                id: uid, name, age, gender: selectedGender, status, goal, bio: "Ø£Ø¨Ø­Ø« Ø¹Ù† Ù†ØµÙŠØ¨ÙŠ...",
                avatar: tempAvatar,
                joined: Date.now()
            };
            
            localStorage.setItem('wessal_user', JSON.stringify(currentUser));
            update(ref(db, `users/${uid}`), currentUser);
            initApp();
        };

        function initApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            
            const presenceRef = ref(db, `users/${currentUser.id}`);
            update(presenceRef, { ...currentUser, online: true, lastSeen: serverTimestamp() });
            
            // Profile Init
            if(currentUser.avatar) {
                 document.getElementById('myAvatarDisplay').innerHTML = `<img src="${currentUser.avatar}">`;
            } else {
                 document.getElementById('myAvatarDisplay').innerHTML = currentUser.gender === 'male' ? '<i class="fa-solid fa-user-tie"></i>' : '<i class="fa-solid fa-user-nurse"></i>';
            }
            
            document.getElementById('myNameDisplay').innerText = currentUser.name;
            document.getElementById('myDetailsDisplay').innerText = `${currentUser.age} Ø³Ù†Ø© â€¢ ${getStatusText(currentUser.status)}`;
            document.getElementById('myBioInput').value = currentUser.bio || "";

            listenToUsers();
            listenToIncomingMessages();
            listenToNotifications(); // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        }

        window.logout = () => {
            if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                update(ref(db, `users/${currentUser.id}`), { online: false });
                localStorage.removeItem('wessal_user');
                location.reload();
            }
        };

        window.updateBio = () => {
            const newBio = document.getElementById('myBioInput').value;
            currentUser.bio = newBio;
            localStorage.setItem('wessal_user', JSON.stringify(currentUser));
            update(ref(db, `users/${currentUser.id}`), { bio: newBio });
            showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ');
        };

        // --- Notifications System ---
        function listenToNotifications() {
            const notifRef = ref(db, `notifications/${currentUser.id}`);
            onChildAdded(notifRef, (snap) => {
                const notif = snap.val();
                notifications.push(notif);
                updateNotifBadge();
                addNotifToDropdown(notif, snap.key);
                document.getElementById('sndNotif').play().catch(()=>{});
            });
        }

        function updateNotifBadge() {
            const count = notifications.length;
            const badge = document.getElementById('notifCount');
            if(count > 0) {
                badge.innerText = count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        function addNotifToDropdown(notif, key) {
            document.getElementById('emptyNotifMsg').style.display = 'none';
            const container = document.getElementById('notifListContainer');
            
            const item = document.createElement('div');
            item.className = 'notif-item';
            
            let actionHtml = '';
            if(notif.fromId) {
                actionHtml = `<button class="notif-btn-go" onclick="handleNotifClick('${notif.fromId}', '${notif.fromName}', '${key}')">Ø°Ù‡Ø§Ø¨</button>`;
            }

            item.innerHTML = `
                <div>
                    <strong>${notif.fromName || 'Ø§Ù„Ù†Ø¸Ø§Ù…'}</strong><br>
                    <span style="font-size:0.75rem; color:#aaa">${notif.text}</span>
                </div>
                ${actionHtml}
            `;
            
            // Add to top
            container.insertBefore(item, container.firstChild);
        }

        window.handleNotifClick = (fromId, fromName, key) => {
            // Remove notif from list (visually mostly, or could delete from DB)
            remove(ref(db, `notifications/${currentUser.id}/${key}`));
            notifications = notifications.filter(n => n.fromId !== fromId); // Simple cleanup
            updateNotifBadge();
            
            document.getElementById('notifPanel').style.display = 'none';
            openChat(fromId, fromName);
        };

        window.toggleNotifPanel = () => {
            const panel = document.getElementById('notifPanel');
            const isVisible = panel.style.display === 'flex';
            panel.style.display = isVisible ? 'none' : 'flex';
            if(!isVisible) {
                // maybe clear badge visually? 
                // document.getElementById('notifCount').style.display = 'none';
            }
        };

        function sendNotification(targetId, text) {
            push(ref(db, `notifications/${targetId}`), {
                text: text,
                fromId: currentUser.id,
                fromName: currentUser.name,
                timestamp: serverTimestamp()
            });
        }

        // --- Discovery ---
        function listenToUsers() {
            const usersRef = ref(db, 'users');
            onValue(usersRef, (snap) => {
                activeUsers = snap.val() || {};
                renderUsersGrid('all');
            });
        }

        window.filterUsers = (type) => { renderUsersGrid(type); };

        function renderUsersGrid(filter) {
            const grid = document.getElementById('usersGrid');
            grid.innerHTML = '';
            const users = Object.values(activeUsers).filter(u => u.id !== currentUser.id);

            if(users.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:#aaa">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                return;
            }

            users.forEach(u => {
                if (filter !== 'all' && u.gender !== filter) return;

                const card = document.createElement('div');
                card.className = 'user-card animate__animated animate__fadeIn';
                const genderBadge = u.gender === 'male' ? 'Ø±Ø¬Ù„' : 'Ø§Ù…Ø±Ø£Ø©';
                const isOnline = u.online ? '<span class="user-status-dot"></span>' : '';
                
                let imgHTML = '';
                if(u.avatar) {
                    imgHTML = `<img src="${u.avatar}">`;
                } else {
                    imgHTML = u.gender === 'male' ? '<i class="fa-solid fa-user-tie" style="font-size:3rem; color:#60a5fa"></i>' : '<i class="fa-solid fa-user-nurse" style="font-size:3rem; color:#ec4899"></i>';
                }

                card.innerHTML = `
                    <div class="user-card-img">
                        ${imgHTML}
                        <span class="gender-badge">${genderBadge} â€¢ ${u.age}</span>
                        ${isOnline}
                    </div>
                    <div class="user-card-info">
                        <div class="user-card-name">${u.name}</div>
                        <div class="user-card-details">${getStatusText(u.status)} â€¢ ${u.goal === 'marriage' ? 'ğŸ’ Ø²ÙˆØ§Ø¬' : 'ğŸ’¬ ØªØ¹Ø§Ø±Ù'}</div>
                    </div>
                `;
                card.onclick = () => openUserModal(u);
                grid.appendChild(card);
            });
        }

        function getStatusText(s) {
            const map = { single: 'Ø£Ø¹Ø²Ø¨', divorced: 'Ù…Ø·Ù„Ù‚', widowed: 'Ø£Ø±Ù…Ù„', married: 'Ù…ØªØ²ÙˆØ¬' };
            return map[s] || s;
        }

        // --- Profile Modal & Poke ---
        let currentModalUser = null;
        function openUserModal(u) {
            currentModalUser = u;
            
            if(u.avatar) {
                 document.getElementById('modalUserAvatar').innerHTML = `<img src="${u.avatar}">`;
            } else {
                 document.getElementById('modalUserAvatar').innerHTML = u.gender === 'male' ? '<i class="fa-solid fa-user-tie"></i>' : '<i class="fa-solid fa-user-nurse"></i>';
            }

            document.getElementById('modalUserName').innerText = u.name;
            document.getElementById('modalUserAge').innerText = `${u.age} Ø³Ù†Ø©`;
            document.getElementById('modalUserStatus').innerText = getStatusText(u.status);
            document.getElementById('modalUserCity').innerText = u.goal === 'marriage' ? 'ğŸ’ Ø²ÙˆØ§Ø¬' : 'ğŸ¤ ØµØ¯Ø§Ù‚Ø©';
            document.getElementById('modalUserBio').innerText = u.bio || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø¨Ø°Ø©...";
            
            document.getElementById('userModal').style.display = 'flex';
        }

        window.startChatFromModal = () => {
            closeModal('userModal');
            openChat(currentModalUser.id, currentModalUser.name);
        };

        window.sendPoke = () => {
            closeModal('userModal');
            showToast(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†ÙƒØ²Ø© Ø¥Ù„Ù‰ ${currentModalUser.name} ğŸ˜‰`);
            sendNotification(currentModalUser.id, `Ù‚Ø§Ù… ${currentUser.name} Ø¨Ù†ÙƒØ²Ùƒ ğŸ˜‰`);
        };

        // --- Chat Functions ---
        window.openChat = (partnerId, partnerName) => {
            currentChatPartner = { id: partnerId, name: partnerName };
            const chatId = [currentUser.id, partnerId].sort().join('_');
            currentChatId = chatId;
            
            document.getElementById('chatPartnerName').innerText = partnerName;
            document.getElementById('chatMessages').innerHTML = '';
            document.getElementById('chatScreen').style.display = 'flex';
            
            const chatRef = ref(db, `chats/${chatId}`);
            document.getElementById('chatMessages').innerHTML = '';
            onChildAdded(chatRef, (snap) => {
                renderMessage(snap.val());
            });
        };

        window.closeChat = () => {
            document.getElementById('chatScreen').style.display = 'none';
            currentChatId = null;
            currentChatPartner = null;
        };

        window.sendMessage = (type = 'text', content = null) => {
            if(!currentChatId) return;
            
            const input = document.getElementById('msgInput');
            const text = content || input.value.trim();
            if(!text) return;

            const msgData = {
                senderId: currentUser.id,
                senderName: currentUser.name,
                text: text,
                type: type, 
                timestamp: serverTimestamp()
            };

            push(ref(db, `chats/${currentChatId}`), msgData);
            
            update(ref(db, `user_chats/${currentUser.id}/${currentChatPartner.id}`), {
                partnerName: currentChatPartner.name, lastMsg: type === 'text' ? text : 'Ù…Ø±ÙÙ‚', time: Date.now()
            });
            update(ref(db, `user_chats/${currentChatPartner.id}/${currentUser.id}`), {
                partnerName: currentUser.name, lastMsg: type === 'text' ? text : 'Ù…Ø±ÙÙ‚', time: Date.now()
            });
            
            // Send Notification for new message
            // Note: In real app, check if user is already in chat to avoid spam
            sendNotification(currentChatPartner.id, `Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ${currentUser.name}`);

            if(type === 'text') input.value = '';
            document.getElementById('sndMsg').play().catch(()=>{});
        };

        function renderMessage(msg) {
            const list = document.getElementById('chatMessages');
            const isMine = msg.senderId === currentUser.id;
            const div = document.createElement('div');
            
            if (msg.type === 'gift') {
                div.className = `msg-bubble gift-msg animate__animated animate__bounceIn`;
                div.style.alignSelf = 'center';
                const giftData = JSON.parse(msg.text);
                div.innerHTML = `
                    <span class="gift-icon">${giftData.icon}</span>
                    <strong>${isMine ? 'Ø£Ø±Ø³Ù„Øª' : 'Ø£Ø±Ø³Ù„ Ù„Ùƒ'} Ù‡Ø¯ÙŠØ©</strong><br>
                    <span style="color: #ec4899">${giftData.name}</span>
                `;
            } else if (msg.type === 'proposal') {
                div.className = `msg-bubble proposal-msg animate__animated animate__pulse`;
                div.style.alignSelf = 'center';
                div.innerHTML = `
                    <span class="proposal-header">ğŸ’ Ø·Ù„Ø¨ Ø²ÙˆØ§Ø¬ Ø±Ø³Ù…ÙŠ</span>
                    <p>Ù‡Ù„ ØªÙ‚Ø¨Ù„ÙŠÙ† Ø¨ÙŠ Ø´Ø±ÙŠÙƒØ§Ù‹ Ù„Ø­ÙŠØ§ØªÙƒØŸ</p>
                `;
                if(!isMine) document.getElementById('sndMatch').play().catch(()=>{});
            } else if (msg.type === 'sticker') {
                 div.className = `msg-bubble ${isMine ? 'msg-mine' : 'msg-theirs'}`;
                 div.style.background = 'transparent';
                 div.style.fontSize = '3rem';
                 div.innerText = msg.text;
            } else {
                div.className = `msg-bubble ${isMine ? 'msg-mine' : 'msg-theirs'}`;
                div.innerText = msg.text;
            }

            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        }

        // --- Gifts & Extras ---
        window.showGiftModal = () => document.getElementById('giftModal').style.display = 'flex';
        window.sendGift = (name, icon) => {
            closeModal('giftModal');
            sendMessage('gift', JSON.stringify({ name, icon }));
        };

        window.toggleStickers = () => {
            const menu = document.getElementById('stickersMenu');
            menu.style.display = menu.style.display === 'grid' ? 'none' : 'grid';
        };
        window.sendSticker = (s) => {
            document.getElementById('stickersMenu').style.display = 'none';
            sendMessage('sticker', s);
        };

        window.sendProposalUI = () => {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø²ÙˆØ§Ø¬ Ø±Ø³Ù…ÙŠØŸ')) {
                sendMessage('proposal', 'Marriage Request');
            }
        };

        window.showPartnerProfile = () => {
             if(currentChatPartner && activeUsers[currentChatPartner.id]) {
                 openUserModal(activeUsers[currentChatPartner.id]);
             } else {
                 showToast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
             }
        };

        // --- Chat List Logic ---
        function listenToIncomingMessages() {
            onValue(ref(db, `user_chats/${currentUser.id}`), (snap) => {
                const list = document.getElementById('activeChatsList');
                list.innerHTML = '';
                const chats = snap.val();
                
                if(!chats) {
                    list.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù†Ø´Ø·Ø©</p>';
                    return;
                }

                Object.entries(chats).forEach(([pid, data]) => {
                    const item = document.createElement('div');
                    item.style.padding = '15px';
                    item.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                    item.style.display = 'flex';
                    item.style.alignItems = 'center';
                    item.style.gap = '15px';
                    item.style.cursor = 'pointer';
                    
                    // Try to get avatar if available in activeUsers
                    let avatarHtml = '<i class="fa-solid fa-user"></i>';
                    if(activeUsers[pid] && activeUsers[pid].avatar) {
                        avatarHtml = `<img src="${activeUsers[pid].avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
                    }

                    item.innerHTML = `
                        <div style="width:45px; height:45px; background:#333; border-radius:50%; display:flex; justify-content:center; align-items:center; color:var(--primary); overflow:hidden;">
                            ${avatarHtml}
                        </div>
                        <div>
                            <div style="font-weight:bold">${data.partnerName}</div>
                            <div style="font-size:0.8rem; color:#888">${data.lastMsg}</div>
                        </div>
                    `;
                    item.onclick = () => openChat(pid, data.partnerName);
                    list.appendChild(item);
                });
            });
        }

        // --- UI Utils ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).style.display = 'block';
            document.getElementById(`nav-${tab}`).classList.add('active');
        };
        
        switchTab('discover');

        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

    </script>
</body>
</html       Ù…ØªØ·ÙˆØ±Ù‡ Ø­Ø· Ù„ÙŠ Ø­Ø§Ø¬Ø§Øª Ù…ØªØ·ÙˆØ±Ù‡ ØªØ§Ù†ÙŠ Ø²ÙˆØ¯ Ù„ÙŠ Ø§Ù„ØªØ·ÙˆØ± Ø§ÙƒØ«Ø± Ø²ÙˆØ¯ ØªØ·ÙˆØ± ÙˆÙ…ØµØ§Ø¯Ø± Ù…ÙØªÙˆØ­Ù‡ ÙˆÙ„Ùˆ ØªØ¹Ø±Ù ØªØ­Ø· Ø§ÙŠ Ø­Ø§Ø¬Ù‡ Ù…Ù† Ø§Ù„Ø§Ù†ØªØ±Ù†Øª Ø¨Ø±Ø¯Ù‡ Ø¨ØªÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‡ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø± ÙˆØ­Ø·ÙŠ Ù„ÙŠ Ø­Ø§Ø¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ù‡ Ø¬Ø¯Ø§ Ø­Ø· Ù„ÙŠ Ø­Ø§Ø¬Ø§Øª Ù…Ù† ÙƒÙ„ Ø­ØªÙ‡.vv
