<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Infinity Call Ultra | مكالمات فيديو</title>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts (Cairo for Arabic) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-deep: #000000;
            --primary: #6C63FF;
            --accent: #00f2ff;
            --danger: #ff4757;
            --glass: rgba(20, 20, 20, 0.6);
            --glass-strong: rgba(10, 10, 10, 0.9);
            --border: rgba(255, 255, 255, 0.15);
            --text: #ffffff;
            --radius-lg: 24px;
            --radius-md: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg-deep);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none; /* Prevent text selection */
        }

        /* --- Animations --- */
        @keyframes slideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(108, 99, 255, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(108, 99, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(108, 99, 255, 0); } }

        /* --- Common UI --- */
        .btn {
            border: none; outline: none; cursor: pointer;
            transition: 0.2s active;
            display: flex; align-items: center; justify-content: center;
        }
        .btn:active { transform: scale(0.95); }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
        }

        /* --- Login Wizard --- */
        #login-screen {
            position: fixed; inset: 0; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%);
        }

        .wizard-card {
            width: 90%; max-width: 400px;
            padding: 30px; border-radius: var(--radius-lg);
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            text-align: center; position: relative;
            overflow: hidden; min-height: 400px;
            display: flex; flex-direction: column; justify-content: center;
        }

        .step-content {
            display: none;
            animation: slideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            flex-direction: column; align-items: center; gap: 20px;
            width: 100%;
        }
        .step-content.active { display: flex; }

        .step-title { font-size: 24px; margin-bottom: 10px; color: var(--primary); }
        
        /* Avatar Step */
        .avatar-preview {
            width: 140px; height: 140px; border-radius: 50%;
            border: 4px solid var(--primary); overflow: hidden;
            position: relative; margin: 10px auto;
            background: #000;
        }
        .avatar-preview video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
        
        .btn-upload {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.7); color: white; padding: 5px;
            font-size: 12px; cursor: pointer;
        }

        /* Input Step */
        .inp-field {
            width: 100%; padding: 15px; border-radius: 12px;
            background: rgba(255,255,255,0.1); border: 1px solid var(--border);
            color: white; text-align: center; font-size: 18px;
        }
        .inp-field:focus { border-color: var(--primary); outline: none; }

        .btn-action {
            width: 100%; padding: 15px; border-radius: 12px;
            background: var(--primary); color: white; font-weight: bold; font-size: 16px;
            margin-top: 10px;
        }
        .btn-secondary { background: transparent; border: 1px solid var(--border); margin-top: 10px; }

        /* --- Main App --- */
        #app-container {
            flex: 1; position: relative; width: 100%; height: 100%;
        }

        /* Video Grid & Layouts */
        #video-grid {
            width: 100%; height: 100%;
            display: flex; flex-wrap: wrap;
            align-content: center; justify-content: center;
            gap: 10px; padding: 10px;
            transition: all 0.3s ease;
        }

        .video-card {
            position: relative; overflow: hidden; background: #111;
            border-radius: var(--radius-md); box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        .video-card.local video { transform: scaleX(-1); }

        /* --- 1v1 Mode (Mobile Style) --- */
        body.mode-1v1 #video-grid { padding: 0; gap: 0; display: block; }
        
        body.mode-1v1 .video-card.remote {
            position: absolute; inset: 0; width: 100% !important; height: 100% !important;
            border-radius: 0; z-index: 1;
        }
        
        body.mode-1v1 .video-card.local {
            position: absolute; 
            width: 110px !important; height: 150px !important;
            bottom: 100px; right: 20px; /* Default position */
            z-index: 10;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            cursor: grab;
            touch-action: none; /* Important for dragging */
        }

        /* --- Grid Mode (3+ Users) --- */
        body:not(.mode-1v1) .video-card {
            flex: 1 1 300px;
            max-width: 600px;
            aspect-ratio: 16/9;
        }

        /* --- Controls (Toggleable) --- */
        .ui-layer {
            position: fixed; inset: 0; pointer-events: none; z-index: 100;
            transition: opacity 0.3s ease;
        }
        body.ui-hidden .ui-layer { opacity: 0; }

        .app-header {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px; display: flex; justify-content: space-between;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            pointer-events: auto;
        }

        .dock-container {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; padding: 12px 25px;
            background: var(--glass-strong); border-radius: 40px;
            border: 1px solid var(--border);
            pointer-events: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .ctrl-btn {
            width: 50px; height: 50px; border-radius: 50%; font-size: 20px;
            background: rgba(255,255,255,0.1); color: white;
        }
        .ctrl-btn.off { background: rgba(255,71,87,0.2); color: var(--danger); }
        .ctrl-btn.end { background: var(--danger); }

        /* --- User Info --- */
        .user-tag {
            position: absolute; bottom: 10px; left: 10px;
            padding: 4px 10px; background: rgba(0,0,0,0.5);
            border-radius: 12px; font-size: 12px; backdrop-filter: blur(4px);
            z-index: 2; pointer-events: none;
        }

        /* --- Dragging Helper --- */
        .dragging { opacity: 0.8; transform: scale(1.05); box-shadow: 0 10px 30px rgba(108, 99, 255, 0.4); }

    </style>
</head>
<body>

    <!-- Login Wizard -->
    <div id="login-screen">
        <div class="wizard-card">
            
            <!-- Step 1: Avatar -->
            <div id="step-1" class="step-content active">
                <h3 class="step-title">اختر صورتك</h3>
                <div class="avatar-preview" onclick="document.getElementById('file-in').click()">
                    <video id="preview-video" autoplay playsinline muted></video>
                    <img id="preview-img" style="display:none">
                    <div class="btn-upload"><i class="fas fa-camera"></i> تغيير</div>
                </div>
                <input type="file" id="file-in" hidden accept="image/*" onchange="handleFileSelect(this)">
                <button class="btn btn-action" onclick="nextStep(2)">التالي <i class="fas fa-chevron-left" style="margin-right:8px"></i></button>
            </div>

            <!-- Step 2: Name -->
            <div id="step-2" class="step-content">
                <h3 class="step-title">ما هو اسمك؟</h3>
                <input type="text" id="username" class="inp-field" placeholder="اكتب اسمك هنا">
                <button class="btn btn-action" onclick="nextStep(3)">التالي</button>
                <button class="btn btn-secondary" onclick="nextStep(1)">رجوع</button>
            </div>

            <!-- Step 3: Room -->
            <div id="step-3" class="step-content">
                <h3 class="step-title">غرفة الاجتماع</h3>
                <input type="text" id="room-code-inp" class="inp-field" placeholder="كود الغرفة (اتركه فارغاً لإنشاء جديد)">
                <button class="btn btn-action" style="background: var(--success);" onclick="startApp()">
                    <i class="fas fa-rocket" style="margin-left:8px"></i> انطلاق
                </button>
                <button class="btn btn-secondary" onclick="nextStep(2)">رجوع</button>
            </div>

        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" style="display:none;">
        
        <!-- Video Layer -->
        <div id="video-grid">
            <!-- Videos injected here -->
        </div>

        <!-- UI Layer (Header & Controls) -->
        <div class="ui-layer">
            <div class="app-header">
                <div style="background:rgba(255,255,255,0.1); padding:5px 15px; border-radius:20px; display:flex; gap:10px; align-items:center;" onclick="copyLink()">
                    <span style="color:var(--accent); font-weight:bold;">ID:</span>
                    <span id="room-display">...</span>
                    <i class="fas fa-copy" style="font-size:12px; opacity:0.7"></i>
                </div>
                <div id="status-indicator" style="width:10px; height:10px; background:#2ecc71; border-radius:50%; box-shadow:0 0 10px #2ecc71;"></div>
            </div>

            <div class="dock-container">
                <button class="btn ctrl-btn" id="mic-btn" onclick="toggleAudio()"><i class="fas fa-microphone"></i></button>
                <button class="btn ctrl-btn" id="cam-btn" onclick="toggleVideo()"><i class="fas fa-video"></i></button>
                <button class="btn ctrl-btn end" onclick="leaveRoom()"><i class="fas fa-phone-slash"></i></button>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" style="position:fixed; top:20px; left:50%; transform:translate(-50%, -100px); background:white; color:black; padding:10px 20px; border-radius:30px; transition:0.3s; z-index:5000; font-weight:bold;">تم النسخ!</div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, push, onChildAdded, onChildRemoved, onDisconnect, remove } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Config
        const firebaseConfig = {
            apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
            authDomain: "story-97cf7.firebaseapp.com",
            databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
            projectId: "story-97cf7",
            storageBucket: "story-97cf7.firebasestorage.app",
            messagingSenderId: "742801388214",
            appId: "1:742801388214:web:32a305a8057b0582c5ec17"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // State
        let user = { id: 'u_' + Math.random().toString(36).substr(2, 6), name: '', avatar: null };
        let roomId = null;
        let localStream = null;
        let peers = {};
        const rtcConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
        
        // --- Wizard Logic ---
        window.nextStep = (step) => {
            if(step === 2) {
                // Ensure camera is ready or fallback
                if(!localStream) initCamera();
            }
            if(step === 3) {
                const name = document.getElementById('username').value.trim();
                if(!name) return alert('الرجاء كتابة الاسم');
                user.name = name;
            }
            
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
        };

        window.handleFileSelect = (input) => {
            if(input.files[0]){
                const reader = new FileReader();
                reader.onload = (e) => {
                    user.avatar = e.target.result;
                    document.getElementById('preview-img').src = user.avatar;
                    document.getElementById('preview-img').style.display = 'block';
                    document.getElementById('preview-video').style.display = 'none';
                    // Stop video track if image selected to save battery
                    if(localStream) localStream.getVideoTracks().forEach(t => t.enabled = false);
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        async function initCamera() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('preview-video').srcObject = localStream;
            } catch(e) {
                console.log("No Camera");
            }
        }

        // --- App Start ---
        window.startApp = async () => {
            roomId = document.getElementById('room-code-inp').value || Math.random().toString(36).substr(2, 6).toUpperCase();
            document.getElementById('room-display').innerText = roomId;
            
            // UI Switch
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            
            // Setup Local Video
            addVideo(user.id, localStream, true);
            
            // Firebase Join
            const userRef = ref(db, `rooms/${roomId}/participants/${user.id}`);
            update(userRef, { ...user, avatar: user.avatar || 'https://via.placeholder.com/150' });
            onDisconnect(userRef).remove();

            // Listeners
            onChildAdded(ref(db, `rooms/${roomId}/participants`), handleParticipantAdd);
            onChildRemoved(ref(db, `rooms/${roomId}/participants`), handleParticipantRemove);
            onChildAdded(ref(db, `rooms/${roomId}/signals/${user.id}`), handleSignal);
            
            // Double Tap Listener
            setupDoubleTap();
        };

        // --- WebRTC Core ---
        function handleParticipantAdd(snap) {
            const p = snap.val();
            if(p.id === user.id) return;
            
            addVideo(p.id, null, false);
            
            const isInitiator = user.id > p.id;
            initPeer(p.id, isInitiator);
        }

        function handleParticipantRemove(snap) {
            const id = snap.val().id;
            if(peers[id]) { peers[id].close(); delete peers[id]; }
            const el = document.getElementById(`wrap-${id}`);
            if(el) el.remove();
            checkLayout();
        }

        async function initPeer(partnerId, initiator) {
            if(peers[partnerId]) return;
            const pc = new RTCPeerConnection(rtcConfig);
            peers[partnerId] = pc;

            if(localStream) localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

            pc.onicecandidate = e => {
                if(e.candidate) sendSignal(partnerId, { type: 'candidate', candidate: JSON.stringify(e.candidate) });
            };

            pc.ontrack = e => {
                const vid = document.getElementById(`vid-${partnerId}`);
                if(vid && e.streams[0]) vid.srcObject = e.streams[0];
            };

            if(initiator) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                sendSignal(partnerId, { type: 'offer', sdp: JSON.stringify(offer) });
            }
        }

        async function handleSignal(snap) {
            const data = snap.val();
            const pc = peers[data.sender];
            if(!pc) return;

            if(data.type === 'offer') {
                await pc.setRemoteDescription(JSON.parse(data.sdp));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                sendSignal(data.sender, { type: 'answer', sdp: JSON.stringify(answer) });
            } else if(data.type === 'answer') {
                await pc.setRemoteDescription(JSON.parse(data.sdp));
            } else if(data.type === 'candidate') {
                try { await pc.addIceCandidate(JSON.parse(data.candidate)); } catch(e){}
            }
            remove(snap.ref);
        }

        function sendSignal(to, data) {
            push(ref(db, `rooms/${roomId}/signals/${to}`), { ...data, sender: user.id });
        }

        // --- Layout & UI Logic ---
        function addVideo(id, stream, isLocal) {
            const div = document.createElement('div');
            div.id = `wrap-${id}`;
            div.className = `video-card ${isLocal ? 'local' : 'remote'}`;
            div.innerHTML = `
                <video id="vid-${id}" autoplay playsinline ${isLocal ? 'muted' : ''}></video>
                <div class="user-tag">${isLocal ? 'أنت' : 'متصل'}</div>
            `;
            document.getElementById('video-grid').appendChild(div);
            if(stream) document.getElementById(`vid-${id}`).srcObject = stream;
            
            if(isLocal) makeDraggable(div);
            checkLayout();
        }

        function checkLayout() {
            const grid = document.getElementById('video-grid');
            const count = grid.children.length; // Local + Remote(s)
            
            // Activate 1v1 Mode only if exactly 2 people
            if(count === 2) {
                document.body.classList.add('mode-1v1');
            } else {
                document.body.classList.remove('mode-1v1');
            }
        }

        // --- Interactions: Double Tap & Drag ---
        function setupDoubleTap() {
            let lastTap = 0;
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                if(now - lastTap < 300) {
                    // Double Tap detected
                    document.body.classList.toggle('ui-hidden');
                }
                lastTap = now;
            });
            // Desktop double click support
            document.addEventListener('dblclick', () => {
                document.body.classList.toggle('ui-hidden');
            });
        }

        function makeDraggable(el) {
            // Only allow dragging if we are in 1v1 mode (implied by class check inside handler if needed, 
            // but here we just attach basic logic, constraints will be handled by layout CSS mostly, 
            // but for movement we need JS)
            
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            const startDrag = (e) => {
                // Only drag local video in 1v1 mode
                if(!document.body.classList.contains('mode-1v1')) return;
                
                isDragging = true;
                el.classList.add('dragging');
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                startX = clientX;
                startY = clientY;
                
                const rect = el.getBoundingClientRect();
                // Store offset from right/bottom or left/top based on computed style
                // Simplest is to switch to top/left based positioning upon first drag
                el.style.bottom = 'auto';
                el.style.right = 'auto';
                el.style.left = rect.left + 'px';
                el.style.top = rect.top + 'px';
            };

            const drag = (e) => {
                if(!isDragging) return;
                e.preventDefault(); // Prevent scroll while dragging video
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                const dx = clientX - startX;
                const dy = clientY - startY;
                
                const currentLeft = parseFloat(el.style.left);
                const currentTop = parseFloat(el.style.top);
                
                el.style.left = `${currentLeft + dx}px`;
                el.style.top = `${currentTop + dy}px`;
                
                startX = clientX;
                startY = clientY;
            };

            const stopDrag = () => {
                isDragging = false;
                el.classList.remove('dragging');
                
                // Snap to bounds logic (optional, keeping it simple for "Anywhere")
                const rect = el.getBoundingClientRect();
                const winW = window.innerWidth;
                const winH = window.innerHeight;
                
                // Keep inside screen
                if(rect.left < 0) el.style.left = '10px';
                if(rect.top < 0) el.style.top = '10px';
                if(rect.right > winW) el.style.left = (winW - rect.width - 10) + 'px';
                if(rect.bottom > winH) el.style.top = (winH - rect.height - 10) + 'px';
            };

            el.addEventListener('mousedown', startDrag);
            el.addEventListener('touchstart', startDrag, {passive: false});
            
            window.addEventListener('mousemove', drag);
            window.addEventListener('touchmove', drag, {passive: false});
            
            window.addEventListener('mouseup', stopDrag);
            window.addEventListener('touchend', stopDrag);
        }

        // --- Controls ---
        window.toggleAudio = () => {
            const t = localStream.getAudioTracks()[0];
            t.enabled = !t.enabled;
            document.getElementById('mic-btn').classList.toggle('off', !t.enabled);
        };
        window.toggleVideo = () => {
            const t = localStream.getVideoTracks()[0];
            t.enabled = !t.enabled;
            document.getElementById('cam-btn').classList.toggle('off', !t.enabled);
        };
        window.leaveRoom = () => location.reload();
        window.copyLink = () => {
            navigator.clipboard.writeText(location.href);
            const t = document.getElementById('toast');
            t.style.transform = "translate(-50%, 20px)";
            setTimeout(() => t.style.transform = "translate(-50%, -100px)", 2000);
        };

    </script>
</body>
</html>
