<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>VoiceConnect Ultimate V5</title>
    <!-- Ø®Ø· ØªØ¬ÙˆØ§Ù„ Ø§Ù„Ø¹ØµØ±ÙŠ -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-deep: #0f0c29;
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --primary: #8e44ad;
            --primary-grad: linear-gradient(to right, #8e44ad, #c0392b);
            --accent: #00f260;
            --accent-grad: linear-gradient(to right, #00f260, #0575e6);
            --text-main: #ffffff;
            --text-sec: #b2bec3;
            --danger: #ff4757;
            --glow-primary: 0 0 15px rgba(142, 68, 173, 0.6);
            --glow-accent: 0 0 15px rgba(0, 242, 96, 0.4);
            --radius-lg: 24px;
            --radius-md: 16px;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }

        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            height: 100dvh; /* Dynamic Height for Mobile */
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© */
        .bg-anim {
            position: absolute; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(142,68,173,0.15) 0%, transparent 50%),
                        radial-gradient(circle, rgba(5,117,230,0.1) 0%, transparent 50%);
            animation: moveBg 15s linear infinite; z-index: -1;
        }
        @keyframes moveBg { 0% { transform: translate(-25%, -25%) rotate(0deg); } 100% { transform: translate(0, 0) rotate(360deg); } }

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ */
        .app-shell {
            width: 100%; height: 100%;
            max-width: 480px; /* Mobile First Constraint */
            background: rgba(18, 18, 28, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            box-shadow: 0 0 60px rgba(0,0,0,0.5);
        }

        @media (min-width: 768px) {
            .app-shell { height: 90dvh; border-radius: 35px; border: 1px solid var(--glass-border); }
        }

        /* Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 25px;
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none;
            transform: scale(0.95) translateY(20px);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1; overflow-y: auto; overflow-x: hidden;
            padding-bottom: calc(80px + var(--safe-bottom)); /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ */
        }
        .view.active { opacity: 1; pointer-events: all; transform: scale(1) translateY(0); z-index: 10; }

        /* Scrollbar ØªØ¬Ù…ÙŠÙ„ÙŠ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        /* Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†ØµÙŠØ© */
        h1 { font-size: 2.5rem; font-weight: 900; background: var(--accent-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; letter-spacing: -1px; }
        h2 { font-size: 1.8rem; font-weight: 800; margin-bottom: 10px; color: white; }
        .subtitle { color: var(--text-sec); font-size: 0.95rem; margin-bottom: 30px; line-height: 1.5; font-weight: 400; }

        /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .inp-group { position: relative; margin-bottom: 20px; width: 100%; }
        .inp-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: var(--primary); font-size: 1.2rem; }
        .inp {
            width: 100%; background: rgba(0,0,0,0.25);
            border: 2px solid var(--glass-border);
            padding: 18px 55px 18px 20px; border-radius: var(--radius-md);
            color: white; font-size: 1.1rem; transition: 0.3s;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }
        .inp:focus { border-color: var(--primary); box-shadow: var(--glow-primary); background: rgba(142, 68, 173, 0.05); transform: translateY(-2px); }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .btn-main {
            width: 100%; padding: 18px; border: none; border-radius: var(--radius-lg);
            background: var(--primary-grad);
            color: white; font-weight: 800; font-size: 1.2rem;
            cursor: pointer; margin-top: auto;
            box-shadow: 0 10px 30px rgba(142, 68, 173, 0.4);
            transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 12px;
            position: relative; overflow: hidden;
        }
        .btn-main:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(142, 68, 173, 0.6); }
        .btn-main:active { transform: scale(0.97); }
        .btn-ghost { background: transparent; color: var(--text-sec); border: none; padding: 10px; cursor: pointer; font-size: 0.9rem; }

        /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ÙØ§ØªØ§Ø± */
        .avatar-uploader {
            width: 160px; height: 160px; margin: 0 auto 30px;
            border-radius: 50%;
            border: 4px dashed rgba(255,255,255,0.2);
            display: flex; justify-content: center; align-items: center;
            position: relative; cursor: pointer; transition: 0.3s;
            background: rgba(255,255,255,0.03); overflow: hidden;
        }
        .avatar-uploader:hover { border-color: var(--accent); background: rgba(0, 242, 96, 0.05); }
        .avatar-uploader.has-img { border: 4px solid var(--accent); box-shadow: 0 0 25px rgba(0, 242, 96, 0.3); }
        .avatar-uploader img { width: 100%; height: 100%; object-fit: cover; animation: fadeIn 0.5s; }
        .avatar-uploader i { font-size: 2.5rem; color: rgba(255,255,255,0.3); }
        
        .presets-container { display: flex; gap: 12px; overflow-x: auto; padding: 10px 5px; width: 100%; scroll-behavior: smooth; margin-bottom: 20px; }
        .preset {
            min-width: 65px; height: 65px; border-radius: 18px;
            background: var(--glass); border: 1px solid var(--glass-border);
            display: flex; justify-content: center; align-items: center;
            font-size: 2rem; cursor: pointer; transition: 0.3s;
        }
        .preset:hover { transform: scale(1.1); background: rgba(255,255,255,0.15); }
        .preset.active { border-color: var(--accent); background: rgba(0,242,96,0.15); box-shadow: var(--glow-accent); transform: scale(1.15); }

        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ */
        .dash-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; backdrop-filter: blur(10px); }
        .user-pill { display: flex; align-items: center; gap: 10px; }
        .user-pill img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--accent); object-fit: cover; }
        
        .action-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
            border: 1px solid var(--glass-border);
            padding: 25px; border-radius: 24px; margin-bottom: 20px;
            display: flex; align-items: center; gap: 20px; cursor: pointer;
            transition: all 0.4s ease; position: relative; overflow: hidden;
        }
        .action-card::before { content: ''; position: absolute; left: 0; top: 0; width: 4px; height: 100%; background: var(--primary); opacity: 0; transition: 0.3s; }
        .action-card:hover { transform: translateX(5px); background: rgba(255,255,255,0.08); }
        .action-card:hover::before { opacity: 1; }
        .card-icon { width: 60px; height: 60px; background: rgba(142, 68, 173, 0.15); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: #d6a2e8; transition: 0.3s; }
        .action-card:hover .card-icon { transform: rotate(10deg) scale(1.1); background: var(--primary); color: white; }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„ØºØ±ÙØ© */
        .room-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; align-content: flex-start; padding-bottom: 120px; }
        .participant {
            background: rgba(0,0,0,0.3); border-radius: 25px;
            aspect-ratio: 0.85; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 2px solid transparent; transition: 0.3s; overflow: hidden;
        }
        /* Speaker Effect */
        .participant.speaking { border-color: var(--accent); box-shadow: 0 0 30px rgba(0, 242, 96, 0.2); animation: pulseBorder 1.5s infinite; }
        @keyframes pulseBorder { 0% { box-shadow: 0 0 0 0 rgba(0, 242, 96, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(0, 242, 96, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 242, 96, 0); } }
        
        .p-img-box { position: relative; width: 70px; height: 70px; margin-bottom: 10px; }
        .p-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.2); z-index: 2; position: relative; }
        .p-name { font-size: 0.9rem; font-weight: 700; max-width: 90%; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        .p-mic-status { position: absolute; bottom: 0; right: -5px; width: 24px; height: 24px; background: var(--bg-deep); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; border: 2px solid #333; z-index: 3; }

        /* Visualizer Bar inside Participant */
        .mini-viz { position: absolute; bottom: 0; left: 0; width: 100%; height: 40%; opacity: 0.3; z-index: 1; pointer-events: none; display: flex; align-items: flex-end; justify-content: center; gap: 2px; padding: 0 10px 10px; }
        .viz-bar { flex: 1; background: var(--accent); border-radius: 2px 2px 0 0; transition: height 0.1s; height: 5%; }

        /* Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ */
        .dock-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: rgba(22, 22, 35, 0.85); backdrop-filter: blur(20px);
            padding: 12px 20px; border-radius: 50px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100;
        }
        .dock-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            background: rgba(255,255,255,0.05); color: white; font-size: 1.2rem;
            cursor: pointer; transition: 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .dock-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-5px); }
        .dock-btn.active { background: white; color: var(--primary); box-shadow: 0 0 20px white; }
        .dock-btn.danger { background: rgba(255, 71, 87, 0.15); color: var(--danger); }
        .dock-btn.danger:hover { background: var(--danger); color: white; box-shadow: 0 0 20px var(--danger); }
        .badge { position: absolute; top: -2px; right: -2px; width: 18px; height: 18px; background: var(--danger); border-radius: 50%; font-size: 0.7rem; border: 2px solid var(--bg-deep); display: none; align-items: center; justify-content: center; }

        /* Chat Drawer */
        .chat-drawer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 75%;
            background: #1a1a2e; border-radius: 30px 30px 0 0;
            transform: translateY(110%); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 90; display: flex; flex-direction: column; border-top: 1px solid var(--glass-border);
        }
        .chat-drawer.open { transform: translateY(0); }
        .chat-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); font-weight: bold; position: relative; }
        .close-chat { position: absolute; right: 20px; top: 20px; background: none; border: none; color: #888; font-size: 1.2rem; cursor: pointer; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 15px; max-width: 80%; align-self: flex-start; font-size: 0.9rem; border: 1px solid transparent; }
        .msg.mine { background: rgba(142, 68, 173, 0.2); border-color: rgba(142, 68, 173, 0.5); align-self: flex-end; }
        .chat-input-area { padding: 15px; background: rgba(0,0,0,0.2); display: flex; gap: 10px; }
        .chat-inp { flex: 1; background: rgba(255,255,255,0.1); border: none; padding: 12px 20px; border-radius: 25px; color: white; }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--accent); border: none; cursor: pointer; color: #000; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 200; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: all; }
        .modal-box {
            background: #1e1e2f; width: 85%; max-width: 340px;
            padding: 30px; border-radius: 30px; text-align: center;
            transform: scale(0.8); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid var(--glass-border); box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-overlay.show .modal-box { transform: scale(1); }

        /* Toast */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: rgba(20, 20, 30, 0.95); border: 1px solid var(--primary);
            padding: 12px 25px; border-radius: 50px; display: flex; align-items: center; gap: 12px;
            z-index: 300; transition: 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: max-content; max-width: 90%;
        }
        .toast.show { transform: translateX(-50%) translateY(10px); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .loader { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        canvas#bg-viz { position: absolute; bottom: 0; left: 0; width: 100%; height: 150px; z-index: 0; pointer-events: none; opacity: 0.3; mask-image: linear-gradient(to top, black, transparent); }
    </style>
</head>
<body>

    <!-- Ø®Ù„ÙÙŠØ© Ø­ÙŠØ© -->
    <div class="bg-anim"></div>

    <div class="app-shell" id="app">
        
        <!-- === Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© === -->
        <div class="view active" id="v-welcome">
            <div style="text-align:center; margin-top: 15vh;">
                <div style="font-size: 3.5rem; color: var(--accent); margin-bottom: 20px;"><i class="fas fa-wave-square"></i></div>
                <h1>Voice<span style="color:white">X</span> Pro</h1>
                <p class="subtitle">ØªØ¬Ø±Ø¨Ø© ØªÙˆØ§ØµÙ„ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ ØºØ§Ù…Ø±Ø©<br>Ø¨Ø£Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø© ØµÙˆØªÙŠØ© ÙˆØªØµÙ…ÙŠÙ… Ù…Ø°Ù‡Ù„</p>
                <div class="loader" id="init-loader"></div>
            </div>
        </div>

        <!-- === Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ === -->
        <div class="view" id="v-login">
            <h1 style="font-size: 2rem;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h1>
            <p class="subtitle">Ø£Ù†Ø´Ø¦ Ù‡ÙˆÙŠØªÙƒ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¹Ø§Ù„Ù…</p>

            <div class="avatar-uploader" id="av-box" onclick="triggerUpload()">
                <img id="av-img" style="display:none">
                <i class="fas fa-camera" id="av-icon"></i>
            </div>
            <input type="file" id="file-upl" hidden accept="image/*">

            <div class="presets-container" id="presets-list">
                <!-- JS will fill this -->
            </div>

            <div class="inp-group">
                <i class="fas fa-user inp-icon"></i>
                <input type="text" id="username" class="inp" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±">
            </div>

            <button class="btn-main" onclick="processLogin()">
                Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†ØµØ© <i class="fas fa-arrow-left"></i>
            </button>
        </div>

        <!-- === Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Dashboard) === -->
        <div class="view" id="v-dash">
            <div class="dash-header">
                <div>
                    <h2>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
                    <span style="color:var(--accent); font-size:0.8rem">â— Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</span>
                </div>
                <div class="user-pill">
                    <div style="text-align:left">
                        <div id="d-name" style="font-weight:bold; font-size:0.9rem">Guest</div>
                        <div style="font-size:0.7rem; color:#aaa">Basic User</div>
                    </div>
                    <img id="d-img" src="">
                </div>
            </div>

            <div class="action-card" onclick="startNewRoom()">
                <div class="card-icon"><i class="fas fa-microphone-alt"></i></div>
                <div>
                    <h3 style="color:white; margin-bottom:5px">ØºØ±ÙØ© ØµÙˆØªÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                    <p style="color:#888; font-size:0.85rem">Ø£Ù†Ø´Ø¦ Ù…Ø³Ø§Ø­Ø© ÙˆØ§Ø¯Ø¹Ù Ø£ØµØ¯Ù‚Ø§Ø¡Ùƒ Ù„Ù„Ø­Ø¯ÙŠØ« Ø¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©</p>
                </div>
            </div>

            <div class="action-card" onclick="showSettings()">
                <div class="card-icon"><i class="fas fa-sliders-h"></i></div>
                <div>
                    <h3 style="color:white; margin-bottom:5px">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØµÙˆØª</h3>
                    <p style="color:#888; font-size:0.85rem">Ø¶Ø¨Ø· Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆØªØ¬Ù‡ÙŠØ²Ø§Øª Ø§Ù„ØµÙˆØª</p>
                </div>
            </div>

            <div id="rejoin-alert" style="display:none; margin-top:20px; background: rgba(0, 242, 96, 0.1); border:1px solid var(--accent); padding:15px; border-radius:15px; text-align:center; cursor:pointer" onclick="rejoinRoom()">
                <i class="fas fa-phone-volume" style="color:var(--accent); margin-bottom:5px; font-size:1.5rem"></i>
                <div style="color:var(--accent); font-weight:bold">Ù„Ø¯ÙŠÙƒ Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ø§Ø±ÙŠØ©ØŒ Ø§Ø¶ØºØ· Ù„Ù„Ø¹ÙˆØ¯Ø©</div>
            </div>
        </div>

        <!-- === Ø§Ù„ØºØ±ÙØ© (Room) === -->
        <div class="view" id="v-room" style="padding-bottom: 0;">
            <!-- Header -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; z-index:5; position:relative">
                <div style="background:rgba(0,0,0,0.4); padding:8px 15px; border-radius:20px; font-family:monospace; color:var(--accent); border:1px solid rgba(255,255,255,0.1)">
                    <i class="far fa-clock"></i> <span id="room-timer">00:00</span>
                </div>
                <div style="display:flex; gap:10px">
                    <button class="btn-ghost" onclick="copyLink()" style="background:rgba(255,255,255,0.1); border-radius:50%; width:40px; height:40px;"><i class="fas fa-link"></i></button>
                    <button class="btn-ghost" onclick="leaveRoom(false)" style="background:rgba(255,71,87,0.2); color:var(--danger); border-radius:50%; width:40px; height:40px;"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <!-- Participants Grid -->
            <div class="room-grid" id="grid">
                <!-- Cards injected here -->
            </div>

            <!-- Canvas Background Viz for Room -->
            <canvas id="bg-viz"></canvas>

            <!-- Bottom Dock -->
            <div class="dock-bar">
                <button class="dock-btn" id="btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
                <button class="dock-btn" onclick="toggleChat()">
                    <i class="fas fa-comment-dots"></i>
                    <div class="badge" id="chat-badge">0</div>
                </button>
                <button class="dock-btn" onclick="shareRoom()"><i class="fas fa-user-plus"></i></button>
                <button class="dock-btn danger" onclick="leaveRoom()"><i class="fas fa-phone-slash"></i></button>
            </div>

            <!-- Chat Drawer -->
            <div class="chat-drawer" id="chat-drawer">
                <div class="chat-header">
                    Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ÙƒØªØ§Ø¨ÙŠØ©
                    <button class="close-chat" onclick="toggleChat()"><i class="fas fa-chevron-down"></i></button>
                </div>
                <div class="chat-msgs" id="chat-box"></div>
                <div class="chat-input-area">
                    <input type="text" class="chat-inp" id="chat-inp" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="handleEnter(event)">
                    <button class="send-btn" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

    </div>

    <!-- === MODAL === -->
    <div class="modal-overlay" id="modal">
        <div class="modal-box">
            <i id="m-icon" style="font-size:3.5rem; margin-bottom:20px; display:block;"></i>
            <h3 id="m-title" style="margin-bottom:10px; color:white"></h3>
            <p id="m-text" style="color:#bbb; margin-bottom:25px; font-size:0.95rem; line-height:1.6"></p>
            <div id="m-actions" style="display:flex; gap:10px; justify-content:center; flex-direction:column"></div>
        </div>
    </div>

    <!-- === TOAST === -->
    <div class="toast" id="toast">
        <div id="t-icon"></div>
        <span id="t-msg" style="color:white; font-size:0.9rem"></span>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, push, get, child, onDisconnect } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8", // Ù…ÙØªØ§Ø­ Ø¹Ø§Ù… (Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙ‚Ø·)
            authDomain: "story-97cf7.firebaseapp.com",
            databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
            projectId: "story-97cf7",
            storageBucket: "story-97cf7.firebasestorage.app",
            messagingSenderId: "742801388214",
            appId: "1:742801388214:web:32a305a8057b0582c5ec17"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- STATE & AUDIO ENGINE ---
        let user = JSON.parse(localStorage.getItem('vx_user')) || {};
        let activeRoom = localStorage.getItem('vx_room');
        let audioCtx, analyser, localStream;
        let peers = {};
        let roomTimerInt;
        let isMuted = false;
        
        // --- SOUND EFFECTS ---
        const Sounds = {
            click: () => playTone(800, 'sine', 0.1),
            success: () => { playTone(523, 'sine', 0.1); setTimeout(()=>playTone(659, 'sine', 0.2), 100); },
            error: () => playTone(150, 'sawtooth', 0.3),
            join: () => playTone(1000, 'triangle', 0.3),
            msg: () => playTone(1200, 'sine', 0.1)
        };

        function playTone(freq, type, dur) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.value = freq;
            osc.connect(gain); gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        // --- NAVIGATION & UI ---
        const $ = id => document.getElementById(id);
        const showView = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            $(id).classList.add('active');
        };

        // Init Sequence
        setTimeout(() => {
            $('init-loader').style.display = 'none';
            if(user.id && user.name) {
                const params = new URLSearchParams(location.search);
                if(params.get('room')) joinRoomSequence(params.get('room'));
                else initDash();
            } else {
                generatePresets();
                showView('v-login');
            }
        }, 1500);

        // --- LOGIN LOGIC ---
        function generatePresets() {
            const emojis = ['ğŸ‘½','ğŸ¤–','ğŸ¦','ğŸ¦Š','ğŸ¼','ğŸ¦„','ğŸ‘»','ğŸƒ'];
            const con = $('presets-list');
            con.innerHTML = '';
            emojis.forEach(e => {
                const div = document.createElement('div');
                div.className = 'preset'; div.innerText = e;
                div.onclick = () => {
                    document.querySelectorAll('.preset').forEach(p=>p.classList.remove('active'));
                    div.classList.add('active');
                    generateAvatar(e);
                };
                con.appendChild(div);
            });
        }

        window.triggerUpload = () => $('file-upl').click();
        $('file-upl').onchange = (e) => {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = (ev) => {
                    user.img = ev.target.result;
                    $('av-img').src = user.img; $('av-img').style.display = 'block';
                    $('av-box').classList.add('has-img');
                    Sounds.success();
                }
                r.readAsDataURL(f);
            }
        };

        function generateAvatar(emoji) {
            const c = document.createElement('canvas'); c.width=150; c.height=150;
            const x = c.getContext('2d');
            x.fillStyle = '#1e272e'; x.fillRect(0,0,150,150);
            x.font = '80px Arial'; x.textAlign='center'; x.textBaseline='middle';
            x.fillText(emoji, 75, 80);
            user.img = c.toDataURL();
            $('av-img').src = user.img; $('av-img').style.display = 'block';
            $('av-box').classList.add('has-img');
            Sounds.click();
        }

        window.processLogin = () => {
            const name = $('username').value.trim();
            if(!name || !user.img) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© ÙˆØ§Ø³Ù…', 'exclamation-circle', 'var(--danger)'); Sounds.error(); return; }
            
            user.id = 'u_' + Date.now().toString(36);
            user.name = name;
            localStorage.setItem('vx_user', JSON.stringify(user));
            
            // Save to DB for presence
            set(ref(db, `users/${user.id}`), user);
            
            const params = new URLSearchParams(location.search);
            if(params.get('room')) joinRoomSequence(params.get('room'));
            else initDash();
            Sounds.success();
        };

        function initDash() {
            $('d-name').innerText = user.name;
            $('d-img').src = user.img;
            showView('v-dash');
            
            if(activeRoom) {
                get(ref(db, `rooms/${activeRoom}`)).then(s => {
                    if(s.exists()) $('rejoin-alert').style.display = 'block';
                    else localStorage.removeItem('vx_room');
                });
            }
        }

        // --- ROOM LOGIC ---
        window.startNewRoom = () => {
            const rid = Date.now().toString(36);
            set(ref(db, `rooms/${rid}`), {
                host: user.id,
                created: Date.now(),
                status: 'active'
            }).then(() => joinRoomSequence(rid));
        };

        window.rejoinRoom = () => joinRoomSequence(activeRoom);

        async function joinRoomSequence(rid) {
            Sounds.click();
            activeRoom = rid;
            localStorage.setItem('vx_room', rid);
            
            // UI Prep
            showView('v-room');
            $('grid').innerHTML = ''; // Clear old
            
            // 1. Get Audio
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                initVisualizer(localStream);
            } catch(e) {
                showModal('Ø®Ø·Ø£ Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†', 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±', '<button class="btn-main" onclick="closeModal()">Ø­Ø³Ù†Ø§Ù‹</button>', 'microphone-slash', '#e74c3c');
                return;
            }

            // 2. Add Self to DB
            const pRef = ref(db, `rooms/${rid}/participants/${user.id}`);
            await set(pRef, { info: user, muted: false, online: true });
            onDisconnect(pRef).remove(); // Auto remove on close

            // 3. Add Self Card
            addParticipantCard(user.id, user, true);

            // 4. Listen for others
            onValue(ref(db, `rooms/${rid}/participants`), snap => {
                const parts = snap.val() || {};
                
                // Remove stale
                document.querySelectorAll('.participant').forEach(el => {
                    const uid = el.id.replace('p-', '');
                    if(!parts[uid]) {
                        el.remove();
                        if(peers[uid]) { peers[uid].close(); delete peers[uid]; }
                    }
                });

                // Add/Update
                Object.keys(parts).forEach(uid => {
                    const p = parts[uid];
                    if(uid !== user.id) {
                        if(!$(`p-${uid}`)) {
                            addParticipantCard(uid, p.info, false);
                            initWebRTC(uid);
                            Sounds.join();
                        }
                    }
                    updateCardStatus(uid, p.muted);
                });
            });

            // 5. Chat Listener
            onValue(ref(db, `rooms/${rid}/chat`), snap => {
                const msgs = snap.val();
                if(msgs) {
                    const keys = Object.keys(msgs);
                    const lastKey = keys[keys.length-1];
                    const m = msgs[lastKey];
                    // Very basic check to avoid duplicate append on load, 
                    // in real app use timestamp check. 
                    // For immersive simplicity, we clear and render last few:
                    renderChat(msgs);
                }
            });

            startTimer();
        }

        function addParticipantCard(uid, info, isMe) {
            const div = document.createElement('div');
            div.className = 'participant';
            div.id = `p-${uid}`;
            div.innerHTML = `
                <div class="p-img-box">
                    <img src="${info.img}" class="p-img">
                    <div class="p-mic-status" id="ms-${uid}"><i class="fas fa-microphone"></i></div>
                </div>
                <div class="p-name">${isMe ? 'Ø£Ù†Øª' : info.name}</div>
                
                <!-- Mini Visualizer Bars -->
                <div class="mini-viz" id="viz-${uid}">
                    <div class="viz-bar" style="height:10%"></div>
                    <div class="viz-bar" style="height:20%"></div>
                    <div class="viz-bar" style="height:15%"></div>
                    <div class="viz-bar" style="height:10%"></div>
                </div>
            `;
            $('grid').appendChild(div);
        }

        function updateCardStatus(uid, muted) {
            const icon = $(`ms-${uid}`);
            if(muted) {
                icon.innerHTML = '<i class="fas fa-microphone-slash" style="color:var(--danger)"></i>';
                icon.style.borderColor = 'var(--danger)';
            } else {
                icon.innerHTML = '<i class="fas fa-microphone" style="color:var(--accent)"></i>';
                icon.style.borderColor = 'var(--accent)';
            }
        }

        // --- VISUALIZER ENGINE ---
        function initVisualizer(stream) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 64;
            source.connect(analyser);

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            const animate = () => {
                if(!activeRoom) return;
                analyser.getByteFrequencyData(dataArray);
                
                // 1. Update Self Bars
                const vol = dataArray.reduce((a,b)=>a+b)/dataArray.length;
                updateVizBars(user.id, dataArray, vol);

                // 2. Send Vol to DB (Throttled in real app, simplified here)
                // In this simple version, we only visualize local. 
                // WebRTC audio tracks would need their own analysers for remote users.
                
                requestAnimationFrame(animate);
            };
            animate();
        }

        function updateVizBars(uid, data, vol) {
            const card = $(`p-${uid}`);
            if(!card) return;
            
            // Border Pulse
            if(vol > 30 && !isMuted) card.classList.add('speaking');
            else card.classList.remove('speaking');

            // Bars Height
            const bars = card.querySelectorAll('.viz-bar');
            bars.forEach((bar, i) => {
                // Map some frequency data to bar height
                const val = data[i * 4] || 10;
                bar.style.height = Math.max(10, (val / 255) * 100) + '%';
            });
        }

        // Remote Audio Viz Helper
        function attachRemoteViz(uid, stream) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const src = ctx.createMediaStreamSource(stream);
            const anz = ctx.createAnalyser();
            anz.fftSize = 32;
            src.connect(anz);
            const data = new Uint8Array(anz.frequencyBinCount);

            const loop = () => {
                if(!$(`p-${uid}`)) { ctx.close(); return; }
                anz.getByteFrequencyData(data);
                const vol = data.reduce((a,b)=>a+b)/data.length;
                updateVizBars(uid, data, vol);
                requestAnimationFrame(loop);
            };
            loop();
        }

        // --- WEBRTC (MESH NETWORK) ---
        function initWebRTC(rid) {
            if(peers[rid]) return;
            const pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
            peers[rid] = pc;
            
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

            pc.ontrack = e => {
                const audio = new Audio();
                audio.srcObject = e.streams[0];
                audio.play();
                attachRemoteViz(rid, e.streams[0]);
            };

            pc.onicecandidate = e => {
                if(e.candidate) push(ref(db, `rooms/${activeRoom}/signals/${rid}`), { from:user.id, type:'ice', data:JSON.stringify(e.candidate) });
            };

            // Negotiation
            if(user.id < rid) {
                pc.createOffer().then(o => pc.setLocalDescription(o)).then(() => {
                    push(ref(db, `rooms/${activeRoom}/signals/${rid}`), { from:user.id, type:'offer', data:JSON.stringify(pc.localDescription) });
                });
            }

            // Signal Listener
            onValue(ref(db, `rooms/${activeRoom}/signals/${user.id}`), snap => {
                const msgs = snap.val();
                if(!msgs) return;
                Object.entries(msgs).forEach(([key, msg]) => {
                    if(msg.from === rid) {
                        const data = JSON.parse(msg.data);
                        if(msg.type === 'offer') {
                            pc.setRemoteDescription(data).then(()=>pc.createAnswer()).then(a=>pc.setLocalDescription(a)).then(() => {
                                push(ref(db, `rooms/${activeRoom}/signals/${rid}`), { from:user.id, type:'answer', data:JSON.stringify(pc.localDescription) });
                                remove(child(ref(db, `rooms/${activeRoom}/signals/${user.id}`), key));
                            });
                        } else if(msg.type === 'answer') {
                            pc.setRemoteDescription(data).then(() => remove(child(ref(db, `rooms/${activeRoom}/signals/${user.id}`), key)));
                        } else if(msg.type === 'ice') {
                            pc.addIceCandidate(data).then(() => remove(child(ref(db, `rooms/${activeRoom}/signals/${user.id}`), key)));
                        }
                    }
                });
            });
        }

        // --- FEATURES ---
        window.toggleMic = () => {
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            update(ref(db, `rooms/${activeRoom}/participants/${user.id}`), { muted: isMuted });
            
            const btn = $('btn-mic');
            if(isMuted) {
                btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                btn.classList.add('danger'); btn.classList.remove('active');
            } else {
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
                btn.classList.remove('danger'); btn.classList.add('active');
            }
            Sounds.click();
        };

        window.toggleChat = () => {
            $('chat-drawer').classList.toggle('open');
            $('chat-badge').style.display = 'none';
        };

        window.sendChat = () => {
            const txt = $('chat-inp').value.trim();
            if(!txt) return;
            push(ref(db, `rooms/${activeRoom}/chat`), { sender: user.name, text: txt, time: Date.now() });
            $('chat-inp').value = '';
            Sounds.click();
        };
        
        window.handleEnter = (e) => { if(e.key === 'Enter') sendChat(); };

        function renderChat(msgs) {
            const box = $('chat-box');
            box.innerHTML = '';
            Object.values(msgs).forEach(m => {
                const div = document.createElement('div');
                div.className = 'msg ' + (m.sender === user.name ? 'mine' : '');
                div.innerHTML = `<b>${m.sender}</b>: ${m.text}`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
            
            if(!$('chat-drawer').classList.contains('open')) {
                $('chat-badge').style.display = 'flex';
                $('chat-badge').innerText = '!';
                Sounds.msg();
            }
        }

        window.copyLink = () => {
            const url = `${location.origin}${location.pathname}?room=${activeRoom}`;
            navigator.clipboard.writeText(url);
            showToast('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ©', 'link');
        };

        window.shareRoom = () => {
             if (navigator.share) {
                navigator.share({
                    title: 'Ø§Ù†Ø¶Ù… Ù„ØºØ±ÙØªÙŠ ÙÙŠ VoiceX',
                    text: 'ØªØ¹Ø§Ù„ Ù†Ø¯Ø±Ø¯Ø´ Ø¨ØµÙˆØª Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø©!',
                    url: `${location.origin}${location.pathname}?room=${activeRoom}`
                }).catch(console.error);
            } else {
                copyLink();
            }
        };

        window.leaveRoom = (confirm=true) => {
            if(confirm) {
                showModal('Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©ØŸ', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ', 
                    `<button class="btn-main" style="padding:10px" onclick="confirmLeave()">Ù†Ø¹Ù…ØŒ Ø®Ø±ÙˆØ¬</button>
                     <button class="btn-ghost" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>`, 
                     'door-open', '#ff4757');
            } else { confirmLeave(); }
        };

        window.confirmLeave = () => {
            if(localStream) localStream.getTracks().forEach(t=>t.stop());
            remove(ref(db, `rooms/${activeRoom}/participants/${user.id}`));
            localStorage.removeItem('vx_room');
            location.href = location.pathname; // Reload cleanup
        };

        window.showSettings = () => {
            showModal('Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙˆØª (Ù‚Ø±ÙŠØ¨Ø§Ù‹)', '<button class="btn-main" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>', 'cog', '#8e44ad');
        };

        // --- UTILS ---
        function startTimer() {
            let s=0; clearInterval(roomTimerInt);
            roomTimerInt = setInterval(() => {
                s++;
                const m = Math.floor(s/60).toString().padStart(2,'0');
                const sec = (s%60).toString().padStart(2,'0');
                $('room-timer').innerText = `${m}:${sec}`;
            }, 1000);
        }

        function showToast(msg, icon, color='#00f260') {
            $('t-msg').innerText = msg;
            $('t-icon').innerHTML = `<i class="fas fa-${icon}" style="color:${color}; font-size:1.2rem;"></i>`;
            $('toast').classList.add('show');
            setTimeout(() => $('toast').classList.remove('show'), 3000);
        }

        window.showModal = (title, text, html, icon, color) => {
            $('m-title').innerText = title; $('m-text').innerText = text; $('m-actions').innerHTML = html;
            $('m-icon').className = `fas fa-${icon}`; $('m-icon').style.color = color;
            $('modal').classList.add('show');
            Sounds.click();
        };
        window.closeModal = () => $('modal').classList.remove('show');
    </script>
</body>
</html>
