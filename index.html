<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceConnect - Ultra Modern Call App</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6C63FF;
            --secondary: #2A2D3E;
            --accent: #00f2ff;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --danger: #ff4b4b;
            --success: #00d26a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #0f0c29;
            background: linear-gradient(to right, #24243e, #302b63, #0f0c29);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Animated Background Particles */
        .bg-animation {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 10s infinite ease-in-out;
        }
        .orb-1 { width: 300px; height: 300px; background: var(--primary); top: -50px; left: -50px; }
        .orb-2 { width: 200px; height: 200px; background: var(--accent); bottom: -50px; right: -50px; animation-delay: -5s; }

        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(30px, 50px); }
        }

        /* Container */
        .app-container {
            width: 100%;
            max-width: 480px; /* Mobile First logic but looks good on desktop */
            min-height: 100vh;
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            position: relative;
            overflow: hidden;
            transition: all 0.5s ease;
        }

        @media (min-width: 768px) {
            .app-container {
                min-height: 85vh;
                height: auto;
                border-radius: 30px;
                max-width: 400px;
            }
            /* Grid view expansion */
            .app-container.expanded {
                max-width: 900px;
                min-height: 80vh;
            }
        }

        /* Screens Management */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .screen.active {
            opacity: 1;
            pointer-events: all;
            transform: scale(1);
            z-index: 10;
        }

        /* Typography & Elements */
        h1 { font-weight: 900; font-size: 2rem; margin-bottom: 0.5rem; background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        p { color: #aaa; margin-bottom: 2rem; text-align: center; line-height: 1.6; }

        .input-group {
            width: 100%;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .input-field {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255,255,255,0.07);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: 0.3s;
        }

        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(108, 99, 255, 0.3);
        }

        .btn-main {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), #4a40d4);
            border: none;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 15px rgba(108, 99, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-main:active { transform: scale(0.98); }
        .btn-main:hover { filter: brightness(1.2); }

        /* Photo Upload */
        .photo-upload-container {
            width: 120px; height: 120px;
            border-radius: 50%;
            border: 3px dashed rgba(255,255,255,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin-bottom: 2rem;
            overflow: hidden;
            position: relative;
            transition: 0.3s;
        }
        .photo-upload-container:hover { border-color: var(--accent); }
        .photo-upload-container img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .photo-upload-container i { font-size: 2rem; color: #aaa; }

        /* Dashboard */
        .dash-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            position: absolute; top: 20px; left: 0; padding: 0 20px;
        }
        .user-mini { display: flex; align-items: center; gap: 10px; }
        .user-mini img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--accent); }
        
        .card-menu {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            width: 100%;
        }
        .card-opt {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.3s;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .card-opt:hover { background: rgba(255,255,255,0.1); border-color: var(--primary); transform: translateY(-5px); }
        .icon-box {
            width: 50px; height: 50px;
            background: rgba(108, 99, 255, 0.2);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; color: var(--primary);
        }

        /* Call Room */
        .call-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            width: 100%;
            height: 60%;
            overflow-y: auto;
            padding: 10px;
        }

        .participant {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            position: relative;
            aspect-ratio: 1/1;
            transition: 0.3s;
        }
        
        /* Speaking Animation */
        .participant.speaking { border: 2px solid var(--success); box-shadow: 0 0 15px var(--success); }
        .participant img { width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px; object-fit: cover; }
        .participant span { font-size: 0.8rem; font-weight: bold; }
        
        .controls-bar {
            position: absolute; bottom: 30px;
            display: flex; gap: 20px;
            background: rgba(0,0,0,0.5);
            padding: 15px 30px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }
        
        .ctrl-btn {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        .btn-mute { background: #333; color: white; }
        .btn-mute.muted { background: white; color: #333; }
        .btn-end { background: var(--danger); color: white; }
        .btn-approve { background: var(--success); color: white; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 210, 106, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(0, 210, 106, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 210, 106, 0); } }

        /* Toast Notification */
        .toast {
            position: absolute; top: 20px; left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: 0.4s;
            z-index: 100;
            display: flex; align-items: center; gap: 10px;
            font-weight: bold;
            font-size: 0.9rem;
            width: 90%;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* Hidden Canvas for compression */
        canvas { display: none; }
    </style>
</head>
<body>

    <div class="bg-animation">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fas fa-info-circle" style="color: var(--primary)"></i>
        <span id="toast-msg">رسالة تنبيه</span>
    </div>

    <div class="app-container" id="app">
        
        <!-- STEP 1: Name -->
        <div class="screen active" id="screen-name">
            <h1>أهلاً بك</h1>
            <p>للبدء، أخبرنا باسمك</p>
            <div class="input-group">
                <input type="text" id="fname" class="input-field" placeholder="الاسم الأول">
            </div>
            <div class="input-group">
                <input type="text" id="lname" class="input-field" placeholder="اسم العائلة">
            </div>
            <button class="btn-main" onclick="goToPhoto()">
                التالي <i class="fas fa-arrow-left"></i>
            </button>
        </div>

        <!-- STEP 2: Photo & Terms -->
        <div class="screen" id="screen-photo">
            <h1>صورتك الشخصية</h1>
            <p>اجعل أصدقاءك يتعرفون عليك</p>
            
            <label for="file-upload" class="photo-upload-container" id="photo-preview-box">
                <i class="fas fa-camera"></i>
                <img id="preview-img" src="" alt="Avatar">
            </label>
            <input type="file" id="file-upload" accept="image/*" hidden onchange="handleImageUpload(event)">
            <canvas id="canvas"></canvas>

            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; width: 100%;">
                <input type="checkbox" id="terms" style="accent-color: var(--primary); transform: scale(1.2);">
                <label for="terms" style="font-size: 0.8rem; color: #ccc;">أوافق على الشروط وسياسة الاستخدام</label>
            </div>

            <button class="btn-main" onclick="finishRegistration()">
                إتمام التسجيل <i class="fas fa-check"></i>
            </button>
        </div>

        <!-- STEP 3: Dashboard -->
        <div class="screen" id="screen-dashboard">
            <div class="dash-header">
                <div class="user-mini">
                    <img id="dash-avatar" src="" alt="">
                    <div>
                        <h4 id="dash-name" style="margin:0; font-size: 0.9rem;">اسم المستخدم</h4>
                        <span style="font-size: 0.7rem; color: var(--success);">● متصل</span>
                    </div>
                </div>
                <i class="fas fa-cog" style="font-size: 1.2rem; cursor: pointer;"></i>
            </div>

            <h2 style="margin-bottom: 20px;">ابدأ مكالمة</h2>

            <div class="card-menu">
                <div class="card-opt" onclick="startCall('individual')">
                    <div class="icon-box"><i class="fas fa-user"></i></div>
                    <div>
                        <h3>مكالمة فردية</h3>
                        <span style="font-size: 0.8rem; color: #aaa;">تحدث مع شخص واحد بجودة عالية</span>
                    </div>
                </div>
                <div class="card-opt" onclick="startCall('group')">
                    <div class="icon-box"><i class="fas fa-users"></i></div>
                    <div>
                        <h3>مكالمة جماعية</h3>
                        <span style="font-size: 0.8rem; color: #aaa;">غرفة تتسع لـ 6 أشخاص</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 4: Join/Waiting -->
        <div class="screen" id="screen-join">
            <div class="photo-upload-container" style="border:none; width: 100px; height: 100px; margin-bottom: 10px;">
                <img id="join-host-img" src="" style="display:block">
            </div>
            <h3 id="join-host-name">اسم المضيف</h3>
            <p>يدعوك لمكالمة صوتية</p>
            <button class="btn-main" onclick="joinRoomAction()">
                انضمام للمكالمة <i class="fas fa-phone"></i>
            </button>
        </div>

        <!-- STEP 5: Call Room -->
        <div class="screen" id="screen-call">
            <div style="position: absolute; top: 20px; width: 100%; text-align: center;">
                <span id="call-timer" style="background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 15px; font-family: monospace;">00:00</span>
                <!-- Host Only: Link Copy -->
                <div id="copy-link-btn" onclick="copyLink()" style="margin-top: 10px; font-size: 0.8rem; color: var(--accent); cursor: pointer;">
                    <i class="fas fa-copy"></i> نسخ رابط الدعوة
                </div>
            </div>

            <!-- Participants Grid -->
            <div class="call-grid" id="participants-grid">
                <!-- Added dynamically -->
            </div>

            <!-- Incoming Request (Host Only) -->
            <div id="approval-area" style="position: absolute; bottom: 100px; width: 90%; display: none;">
                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <span id="requester-name" style="font-size: 0.9rem;">شخص يريد الانضمام...</span>
                    <button class="ctrl-btn btn-approve" onclick="approveJoin()" style="width: 35px; height: 35px; font-size: 0.9rem;"><i class="fas fa-check"></i></button>
                </div>
            </div>

            <div class="controls-bar">
                <button class="ctrl-btn btn-mute" onclick="toggleMute(this)"><i class="fas fa-microphone"></i></button>
                <button class="ctrl-btn btn-end" onclick="endCall()"><i class="fas fa-phone-slash"></i></button>
            </div>
        </div>

    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push, remove, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
            authDomain: "story-97cf7.firebaseapp.com",
            databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
            projectId: "story-97cf7",
            storageBucket: "story-97cf7.firebasestorage.app",
            messagingSenderId: "742801388214",
            appId: "1:742801388214:web:32a305a8057b0582c5ec17",
            measurementId: "G-9DPPWX7CF0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- GLOBAL STATE ---
        let currentUser = { id: null, fname: '', lname: '', avatar: '' };
        let currentCallId = null;
        let localStream = null;
        let peerConnections = {}; // Map of userId -> RTCPeerConnection
        let isHost = false;
        let pendingUser = null; // For host approval

        // WebRTC Config (STUN servers)
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // --- UI NAVIGATION ---
        window.goToPhoto = () => {
            const fname = document.getElementById('fname').value;
            const lname = document.getElementById('lname').value;
            if(!fname || !lname) return showToast('الرجاء إدخال الاسم كاملاً');
            currentUser.fname = fname;
            currentUser.lname = lname;
            switchScreen('screen-photo');
        }

        window.handleImageUpload = (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        // Compress image using Canvas
                        const canvas = document.getElementById('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 100; // Small size for DB
                        canvas.height = 100;
                        ctx.drawImage(img, 0, 0, 100, 100);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        currentUser.avatar = dataUrl;
                        
                        document.getElementById('preview-img').src = dataUrl;
                        document.getElementById('preview-img').style.display = 'block';
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        window.finishRegistration = () => {
            if(!currentUser.avatar) return showToast('الرجاء اختيار صورة');
            if(!document.getElementById('terms').checked) return showToast('يجب الموافقة على الشروط');
            
            // Create user ID or use existing if local storage
            let storedId = localStorage.getItem('vc_uid');
            if(!storedId) {
                storedId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('vc_uid', storedId);
            }
            currentUser.id = storedId;

            // Save to DB (Optional, mostly we just keep local state for this demo)
            set(ref(db, 'users/' + currentUser.id), {
                fname: currentUser.fname,
                lname: currentUser.lname,
                avatar: currentUser.avatar
            });

            // Set Dashboard info
            document.getElementById('dash-avatar').src = currentUser.avatar;
            document.getElementById('dash-name').textContent = currentUser.fname + ' ' + currentUser.lname;

            // Check if joining a link
            const urlParams = new URLSearchParams(window.location.search);
            const callId = urlParams.get('call');

            if (callId) {
                currentCallId = callId;
                checkRoom(callId);
            } else {
                switchScreen('screen-dashboard');
            }
        }

        // --- CALL LOGIC ---

        window.startCall = (type) => {
            isHost = true;
            currentCallId = Math.random().toString(36).substr(2, 9);
            
            // Setup DB for Call
            set(ref(db, 'calls/' + currentCallId), {
                type: type,
                host: currentUser.id,
                status: 'active',
                created: Date.now()
            });

            // Add self to participants
            set(ref(db, `calls/${currentCallId}/participants/${currentUser.id}`), {
                info: currentUser,
                status: 'joined' // Host is auto-joined
            });

            startRoomLogic();
        }

        function checkRoom(callId) {
            get(ref(db, `calls/${callId}`)).then((snapshot) => {
                if(snapshot.exists()) {
                    // Show Join Screen
                    get(ref(db, `users/${snapshot.val().host}`)).then((hostSnap) => {
                        const hostData = hostSnap.val();
                        document.getElementById('join-host-name').textContent = hostData ? hostData.fname : 'مستخدم';
                        if(hostData) document.getElementById('join-host-img').src = hostData.avatar;
                        switchScreen('screen-join');
                    });
                } else {
                    showToast('المكالمة انتهت أو غير موجودة');
                    switchScreen('screen-dashboard');
                }
            });
        }

        window.joinRoomAction = () => {
            // Add self as "waiting"
            set(ref(db, `calls/${currentCallId}/participants/${currentUser.id}`), {
                info: currentUser,
                status: 'waiting'
            });

            // Listen for status change (Approval)
            const statusRef = ref(db, `calls/${currentCallId}/participants/${currentUser.id}/status`);
            onValue(statusRef, (snapshot) => {
                const status = snapshot.val();
                if(status === 'joined') {
                    startRoomLogic(); // Approved!
                } else if (status === 'kicked') {
                    alert('تم رفض طلبك أو طردك من المكالمة');
                    location.reload();
                }
            });

            showToast('في انتظار موافقة المضيف...');
        }

        // --- ROOM & WEBRTC CORE ---

        async function startRoomLogic() {
            switchScreen('screen-call');
            startTimer();

            // 1. Get Local Audio
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                addParticipantToGrid(currentUser.id, currentUser, true); // Add Self
                
                // Expand container for grid view
                document.querySelector('.app-container').classList.add('expanded');

                // 2. Listen for Participants
                const partsRef = ref(db, `calls/${currentCallId}/participants`);
                onValue(partsRef, (snapshot) => {
                    const parts = snapshot.val();
                    if(!parts) return;

                    Object.keys(parts).forEach(uid => {
                        if (uid === currentUser.id) return; // Skip self

                        const pData = parts[uid];

                        // HOST LOGIC: Check waiting users
                        if(isHost && pData.status === 'waiting') {
                            pendingUser = uid;
                            document.getElementById('requester-name').textContent = `${pData.info.fname} يريد الانضمام`;
                            document.getElementById('approval-area').style.display = 'flex';
                            playNotificationSound();
                        }

                        // Connected users Logic
                        if(pData.status === 'joined') {
                            // If user is new to UI, add to grid
                            if(!document.getElementById(`p-${uid}`)) {
                                addParticipantToGrid(uid, pData.info, false);
                                // Initiate WebRTC connection if we don't have one
                                if(!peerConnections[uid]) {
                                    initiateConnection(uid, isHost); // Simplistic: Host initiates to everyone else
                                }
                            }
                        }
                    });

                    // Remove users who left
                    const currentDivs = document.querySelectorAll('.participant');
                    currentDivs.forEach(div => {
                        const uid = div.id.replace('p-', '');
                        if(!parts[uid] && uid !== currentUser.id) {
                            div.remove();
                            if(peerConnections[uid]) {
                                peerConnections[uid].close();
                                delete peerConnections[uid];
                            }
                        }
                    });
                });

                // Listen for Signals (Offer/Answer/Ice)
                listenForSignals();

            } catch (err) {
                console.error(err);
                showToast('لم يتم العثور على ميكروفون');
            }
        }

        // --- WEBRTC SIGNALING ---
        // Warning: Full Mesh for group calls is complex. 
        // This is a simplified version where signals are exchanged via DB paths unique to user pairs.
        
        function initiateConnection(remoteUid, shouldOffer) {
            // Signal Path: calls/{callId}/signals/{recipientId}/{senderId}
            const pc = new RTCPeerConnection(rtcConfig);
            peerConnections[remoteUid] = pc;

            // Add local tracks
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            // On Ice Candidate
            pc.onicecandidate = (event) => {
                if(event.candidate) {
                    push(ref(db, `calls/${currentCallId}/signals/${remoteUid}/${currentUser.id}`), {
                        type: 'candidate',
                        candidate: JSON.parse(JSON.stringify(event.candidate))
                    });
                }
            };

            // On Track (Remote Audio)
            pc.ontrack = (event) => {
                const audio = document.createElement('audio');
                audio.srcObject = event.streams[0];
                audio.autoplay = true;
                document.body.appendChild(audio);
                
                // Visualize audio
                visualizeAudio(remoteUid, event.streams[0]);
            };

            if(shouldOffer) {
                // Determine who offers based on string comparison to avoid collision or logic (Host offers to Joiner)
                // Actually, let's keep it simpler: Any new joined user, we try to connect. 
                // To avoid double offers, let's say: ID string comparison.
                if (currentUser.id > remoteUid) {
                    createOffer(pc, remoteUid);
                }
            }
        }

        async function createOffer(pc, remoteUid) {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            push(ref(db, `calls/${currentCallId}/signals/${remoteUid}/${currentUser.id}`), {
                type: 'offer',
                sdp: JSON.stringify(offer)
            });
        }

        function listenForSignals() {
            const mySignalsRef = ref(db, `calls/${currentCallId}/signals/${currentUser.id}`);
            onValue(mySignalsRef, (snapshot) => {
                const senders = snapshot.val();
                if(!senders) return;

                Object.keys(senders).forEach(senderId => {
                    const messages = senders[senderId];
                    Object.keys(messages).forEach(async key => {
                        const msg = messages[key];
                        // If we haven't processed this message yet (you'd normally need a way to mark processed, 
                        // here we just rely on Firebase events being triggered. Real apps delete processed signals).
                        
                        if(!peerConnections[senderId]) {
                            initiateConnection(senderId, false);
                        }
                        
                        const pc = peerConnections[senderId];

                        if(msg.type === 'offer') {
                            if(pc.signalingState !== "stable") return; // Prevent glare
                            await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(msg.sdp)));
                            const answer = await pc.createAnswer();
                            await pc.setLocalDescription(answer);
                            push(ref(db, `calls/${currentCallId}/signals/${senderId}/${currentUser.id}`), {
                                type: 'answer',
                                sdp: JSON.stringify(answer)
                            });
                            // Remove processed offer
                            remove(ref(db, `calls/${currentCallId}/signals/${currentUser.id}/${senderId}/${key}`));
                        } 
                        else if (msg.type === 'answer') {
                            if(pc.signalingState === "have-local-offer") {
                                await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(msg.sdp)));
                                remove(ref(db, `calls/${currentCallId}/signals/${currentUser.id}/${senderId}/${key}`));
                            }
                        } 
                        else if (msg.type === 'candidate') {
                            try {
                                await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
                                remove(ref(db, `calls/${currentCallId}/signals/${currentUser.id}/${senderId}/${key}`));
                            } catch(e) {}
                        }
                    });
                });
            });
        }

        // --- HOST ACTIONS ---
        window.approveJoin = () => {
            if(pendingUser) {
                update(ref(db, `calls/${currentCallId}/participants/${pendingUser}`), {
                    status: 'joined'
                });
                document.getElementById('approval-area').style.display = 'none';
                pendingUser = null;
            }
        }

        window.copyLink = () => {
            const url = window.location.origin + window.location.pathname + '?call=' + currentCallId;
            navigator.clipboard.writeText(url).then(() => showToast('تم نسخ الرابط!'));
        }

        // --- UTILS ---
        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function addParticipantToGrid(uid, info, isSelf) {
            const grid = document.getElementById('participants-grid');
            const div = document.createElement('div');
            div.className = 'participant';
            div.id = `p-${uid}`;
            div.innerHTML = `
                <img src="${info.avatar}" alt="user">
                <span>${isSelf ? 'أنت' : info.fname}</span>
            `;
            grid.appendChild(div);
            
            // Host can kick (simple UI logic)
            if(isHost && !isSelf) {
                // Add kick button logic here if needed
            }
        }

        window.toggleMute = (btn) => {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            btn.classList.toggle('muted');
            btn.innerHTML = track.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
        }

        window.endCall = () => {
            // Remove self
            remove(ref(db, `calls/${currentCallId}/participants/${currentUser.id}`));
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            location.href = window.location.origin + window.location.pathname; // Reload to fresh start
        }

        let seconds = 0;
        function startTimer() {
            setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                document.getElementById('call-timer').innerText = 
                    `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
            }, 1000);
        }

        function playNotificationSound() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 500;
            gain.gain.value = 0.1;
            osc.start();
            setTimeout(() => osc.stop(), 200);
        }

        // Fake visualizer (animation based on audio presence)
        function visualizeAudio(uid, stream) {
            // In a real app, use WebAudioAPI AnalyzerNode. 
            // For this single-file demo to keep performance high:
            // We just add a class periodically if audio track is enabled.
            const el = document.getElementById(`p-${uid}`);
            if(!el) return;
            
            // Simple simulation
            setInterval(() => {
                if(Math.random() > 0.5) el.classList.add('speaking');
                else el.classList.remove('speaking');
            }, 200);
        }

    </script>
</body>
</html>
