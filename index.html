<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VoiceConnect Ultimate V4</title>
    <!-- Ø®Ø· ØªØ¬ÙˆØ§Ù„ Ø§Ù„Ø¹ØµØ±ÙŠ -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-deep: #050510;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --primary: #6c5ce7;
            --accent: #00d2d3;
            --pink: #ff9ff3;
            --success: #2ecc71;
            --danger: #ff6b6b;
            --glow: 0 0 20px rgba(108, 92, 231, 0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }

        body {
            background-color: var(--bg-deep);
            color: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(108, 92, 231, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 210, 211, 0.15) 0%, transparent 40%);
        }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© */
        .particles { position: absolute; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .particle { position: absolute; background: white; border-radius: 50%; opacity: 0.3; animation: floatUp linear infinite; }
        @keyframes floatUp { 0% { transform: translateY(100vh) scale(0); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: translateY(-10vh) scale(1); opacity: 0; } }

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .app-shell {
            width: 100%; height: 100%;
            background: rgba(20, 20, 30, 0.6);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            position: relative; overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @media (min-width: 768px) {
            .app-shell { width: 400px; height: 85vh; border-radius: 30px; border: 1px solid var(--border); }
            .app-shell.wide { width: 900px; }
        }

        /* Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 30px;
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none;
            transform: scale(0.9) translateY(30px);
            transition: 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1;
        }
        .view.active { opacity: 1; pointer-events: all; transform: scale(1) translateY(0); z-index: 10; }

        /* Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ù†ØµÙˆØµ */
        h1, h2 { font-weight: 900; background: linear-gradient(to right, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; text-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .subtitle { color: #888; font-size: 0.9rem; margin-bottom: 30px; line-height: 1.6; }

        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        .inp-box { position: relative; margin-bottom: 20px; }
        .inp {
            width: 100%; background: rgba(0,0,0,0.3);
            border: 2px solid var(--border);
            padding: 18px 20px; border-radius: 18px;
            color: white; font-size: 1.1rem; transition: 0.3s;
        }
        .inp:focus { border-color: var(--primary); box-shadow: var(--glow); background: rgba(108, 92, 231, 0.1); transform: translateY(-2px); }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn-main {
            width: 100%; padding: 18px; border: none; border-radius: 20px;
            background: linear-gradient(135deg, var(--primary), #4834d4);
            color: white; font-weight: 800; font-size: 1.1rem;
            cursor: pointer; margin-top: auto;
            box-shadow: 0 10px 30px rgba(108, 92, 231, 0.4);
            transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 10px; position: relative; overflow: hidden;
        }
        .btn-main::after { content: ''; position: absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent); transform: skewX(-20deg) translateX(-150%); transition: 0.5s; }
        .btn-main:hover::after { transform: skewX(-20deg) translateX(150%); }
        .btn-main:active { transform: scale(0.95); }

        /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ÙØ§ØªØ§Ø± (Ù…Ø¹Ø¯Ù„) */
        .avatar-section { display: flex; flex-direction: column; align-items: center; width: 100%; }
        
        /* Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .avatar-preview-box {
            width: 140px; height: 140px;
            border-radius: 50%;
            border: 3px dashed rgba(255,255,255,0.3);
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 20px; overflow: hidden; position: relative;
            background: rgba(255,255,255,0.05); transition: 0.3s;
            cursor: pointer;
        }
        .avatar-preview-box.has-img { border: 3px solid var(--accent); box-shadow: 0 0 20px var(--accent); }
        .avatar-preview-box img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-preview-box i { font-size: 2rem; color: rgba(255,255,255,0.5); }

        /* Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø®ØµÙŠØ§Øª */
        .avatars-grid-label { font-size: 0.9rem; color: var(--accent); margin-bottom: 10px; align-self: flex-start; }
        .presets-scroll {
            display: flex; gap: 15px; overflow-x: auto; width: 100%; padding: 10px 5px;
            scroll-behavior: smooth;
        }
        .presets-scroll::-webkit-scrollbar { height: 5px; }
        .presets-scroll::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
        
        .preset-item {
            min-width: 70px; height: 70px;
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            display: flex; justify-content: center; align-items: center;
            font-size: 2rem; cursor: pointer;
            transition: 0.3s; border: 1px solid transparent;
        }
        .preset-item:hover { transform: scale(1.1); background: rgba(255,255,255,0.2); }
        .preset-item.selected { border-color: var(--accent); background: rgba(0, 210, 211, 0.2); box-shadow: 0 0 15px rgba(0, 210, 211, 0.3); transform: scale(1.15); }

        /* Dashboard Items */
        .dash-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            padding: 20px; border-radius: 24px; margin-bottom: 15px;
            display: flex; align-items: center; gap: 15px; cursor: pointer;
            transition: 0.4s; position: relative; overflow: hidden;
        }
        .dash-card:hover { border-color: var(--primary); transform: translateY(-5px); background: rgba(108, 92, 231, 0.1); }
        .icon-box { width: 55px; height: 55px; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--accent); }

        /* Room Grid */
        .room-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
            align-content: start; flex: 1; overflow-y: auto; padding-bottom: 100px;
        }
        .participant {
            background: rgba(0,0,0,0.4); border-radius: 20px;
            aspect-ratio: 1; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid transparent; transition: 0.3s; overflow: hidden;
        }
        .participant img { width: 65%; aspect-ratio: 1; border-radius: 50%; object-fit: cover; margin-bottom: 8px; border: 2px solid transparent; transition: 0.2s; }
        .participant span { font-size: 0.75rem; font-weight: bold; width: 90%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ­Ø¯Ø« */
        .participant.speaking { border-color: var(--success); box-shadow: 0 0 25px rgba(46, 204, 113, 0.2); }
        .participant.speaking img { transform: scale(1.15); border-color: var(--success); }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙƒØ§Ø±Ø¯ */
        .card-controls {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 8px;
            opacity: 0; transition: 0.3s;
        }
        .participant:hover .card-controls { opacity: 1; }
        .mini-btn { width: 32px; height: 32px; border-radius: 10px; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .mb-kick { background: rgba(255, 107, 107, 0.2); color: var(--danger); }
        .mb-kick:hover { background: var(--danger); color: white; }
        .mb-mute { background: rgba(255,255,255,0.1); }
        .mb-mute:hover { background: white; color: black; }

        /* Bottom Bar */
        .bottom-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; padding: 10px 20px;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(15px);
            border-radius: 40px; border: 1px solid var(--border); z-index: 50;
        }
        .c-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            background: rgba(255,255,255,0.08); color: white; font-size: 1.2rem;
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center;
        }
        .c-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-3px); }
        .c-btn.active { background: white; color: black; box-shadow: 0 0 15px white; }
        .c-btn.danger { background: rgba(255, 107, 107, 0.2); color: var(--danger); }
        .c-btn.danger:hover { background: var(--danger); color: white; box-shadow: 0 0 15px var(--danger); }

        /* Modal & Toast */
        .custom-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(10px);
        }
        .custom-modal.show { opacity: 1; pointer-events: all; }
        .modal-content {
            background: #1a1a2e; width: 90%; max-width: 340px;
            padding: 30px; border-radius: 30px; text-align: center;
            border: 1px solid var(--border); transform: scale(0.8); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .custom-modal.show .modal-content { transform: scale(1); }

        .toast {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: rgba(15, 15, 25, 0.95); border: 1px solid var(--primary);
            padding: 12px 25px; border-radius: 50px; display: flex; align-items: center; gap: 12px;
            z-index: 200; transition: 0.5s; width: max-content; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        canvas { display: none; }
    </style>
</head>
<body>

    <!-- Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© -->
    <div class="particles" id="particles"></div>

    <div class="app-shell" id="app">
        
        <!-- STEP 1: Ø§Ù„Ø§Ø³Ù… -->
        <div class="view active" id="v-name">
            <h1 style="font-size: 2.5rem; margin-top: 40px;">Voice<span style="color:var(--primary)">X</span></h1>
            <p class="subtitle">Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØµÙˆØªÙŠØ© Ø§Ù„Ø£ÙƒØ«Ø± ØªØ·ÙˆØ±Ø§Ù‹</p>
            
            <div class="inp-box">
                <input type="text" id="fname" class="inp" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„" oninput="playTone('type')">
            </div>
            <div class="inp-box">
                <input type="text" id="lname" class="inp" placeholder="Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©" oninput="playTone('type')">
            </div>

            <button class="btn-main" onclick="toStep2()">
                Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i>
            </button>
        </div>

        <!-- STEP 2: Ø§Ù„ØµÙˆØ±Ø© (Ø¥ØµÙ„Ø§Ø­ ÙƒØ§Ù…Ù„ + Ø´Ø®ØµÙŠØ§Øª Ø¬Ø§Ù‡Ø²Ø©) -->
        <div class="view" id="v-avatar">
            <h2>Ù‡ÙˆÙŠØªÙƒ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</h2>
            <p class="subtitle">Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£Ùˆ Ø§Ø®ØªØ± Ø´Ø®ØµÙŠØ©</p>

            <div class="avatar-section">
                <!-- Ø²Ø± Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
                <div class="avatar-preview-box" id="avatar-box" onclick="triggerUpload()">
                    <i class="fas fa-camera"></i>
                    <img id="preview-img" style="display:none">
                </div>
                <input type="file" id="file-upl" hidden accept="image/*">
                
                <!-- Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø®ØµÙŠØ§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© -->
                <div class="avatars-grid-label">Ø£Ùˆ Ø§Ø®ØªØ± Ø´Ø®ØµÙŠØ© Ø¬Ø§Ù‡Ø²Ø©:</div>
                <div class="presets-scroll">
                    <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡Ø§ Ø¨Ø§Ù„ÙƒÙˆØ¯ -->
                    <div class="preset-item" onclick="selectPreset('ğŸ‘½')">ğŸ‘½</div>
                    <div class="preset-item" onclick="selectPreset('ğŸ¤–')">ğŸ¤–</div>
                    <div class="preset-item" onclick="selectPreset('ğŸ¦Š')">ğŸ¦Š</div>
                    <div class="preset-item" onclick="selectPreset('ğŸ¦')">ğŸ¦</div>
                    <div class="preset-item" onclick="selectPreset('ğŸ‘»')">ğŸ‘»</div>
                    <div class="preset-item" onclick="selectPreset('ğŸƒ')">ğŸƒ</div>
                    <div class="preset-item" onclick="selectPreset('ğŸ‘¾')">ğŸ‘¾</div>
                </div>
            </div>

            <canvas id="canvas-processor"></canvas>

            <div style="margin-top: 20px; display:flex; align-items:center; gap:10px; font-size:0.8rem; color:#aaa; background:rgba(255,255,255,0.05); padding:10px; border-radius:12px;">
                <input type="checkbox" id="terms" style="accent-color:var(--primary)" onchange="playTone('select')">
                <span>Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… ÙˆØ§Ù„Ø®ØµÙˆØµÙŠØ©</span>
            </div>

            <button class="btn-main" onclick="finishRegister()">
                Ø¯Ø®ÙˆÙ„ <i class="fas fa-rocket"></i>
            </button>
            <button onclick="showView('v-name'); playTone('back')" style="background:transparent; border:none; color:#888; margin-top:10px; cursor:pointer">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <!-- DASHBOARD -->
        <div class="view" id="v-dash">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div>
                    <h2>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
                    <div style="font-size:0.8rem; color:var(--success)">â— Ù…ØªØµÙ„</div>
                </div>
                <div style="display:flex; align-items:center; gap:10px; background:rgba(255,255,255,0.1); padding:5px 15px 5px 5px; border-radius:30px;">
                    <img id="dash-img" src="" style="width:35px; height:35px; border-radius:50%; object-fit:cover;">
                    <span id="dash-name" style="font-weight:bold; font-size:0.9rem;"></span>
                </div>
            </div>

            <div class="dash-card" onclick="startCall('group')">
                <div class="icon-box"><i class="fas fa-microphone-alt"></i></div>
                <div>
                    <h3 style="margin:0; font-size:1.1rem">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</h3>
                    <span style="font-size:0.8rem; color:#888">Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© Ù…ÙØªÙˆØ­Ø©</span>
                </div>
            </div>

            <div class="dash-card" onclick="addFriendModal()">
                <div class="icon-box"><i class="fas fa-user-plus"></i></div>
                <div>
                    <h3 style="margin:0; font-size:1.1rem">Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</h3>
                    <span style="font-size:0.8rem; color:#888">Ø¯Ø¹ÙˆØ© Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</span>
                </div>
            </div>

            <div id="rejoin-banner" style="display:none; padding:15px; border:1px solid var(--success); border-radius:15px; background:rgba(46, 204, 113, 0.1); text-align:center; cursor:pointer;" onclick="rejoin()">
                <span style="color:var(--success); font-weight:bold;"><i class="fas fa-sync fa-spin"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</span>
            </div>
        </div>

        <!-- ROOM -->
        <div class="view" id="v-room">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="font-family:monospace; background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:10px;" id="timer">00:00</div>
                <div style="display:flex; gap:10px;">
                    <button class="mini-btn" style="width:40px; height:40px; background:rgba(255,255,255,0.1)" onclick="showRequests()" id="btn-reqs" style="display:none"><i class="fas fa-user-clock"></i></button>
                    <button class="mini-btn" style="width:40px; height:40px; background:var(--primary)" onclick="copyLink()"><i class="fas fa-link"></i></button>
                </div>
            </div>

            <div class="room-grid" id="grid">
                <!-- Participants go here -->
            </div>

            <div class="bottom-bar">
                <button class="c-btn" id="mic-btn" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
                <button class="c-btn" onclick="openFriends()"><i class="fas fa-users"></i></button>
                <button class="c-btn danger" onclick="leaveCall()"><i class="fas fa-phone-slash"></i></button>
            </div>
        </div>

    </div>

    <!-- MODAL -->
    <div class="custom-modal" id="modal">
        <div class="modal-content">
            <i id="m-icon" style="font-size:3rem; margin-bottom:15px; display:block;"></i>
            <h3 id="m-title" style="margin-bottom:10px;"></h3>
            <p id="m-text" style="color:#aaa; margin-bottom:20px; font-size:0.9rem;"></p>
            <div id="m-btns" style="display:flex; gap:10px; justify-content:center;"></div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast">
        <div id="t-icon"></div>
        <span id="t-msg" style="font-weight:bold; font-size:0.9rem"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, push, get, child, onDisconnect } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
            authDomain: "story-97cf7.firebaseapp.com",
            databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
            projectId: "story-97cf7",
            storageBucket: "story-97cf7.firebasestorage.app",
            messagingSenderId: "742801388214",
            appId: "1:742801388214:web:32a305a8057b0582c5ec17",
            measurementId: "G-9DPPWX7CF0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- SOUND ENGINE (Synthesizer) ---
        let audioCtx;
        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        
        window.playTone = (type) => {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            
            switch(type) {
                case 'type': // Typing sound
                    osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
                    gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                    osc.start(now); osc.stop(now + 0.05);
                    break;
                case 'next': // Next Step (Swoosh)
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(600, now + 0.3);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                    break;
                case 'select': // Selection
                    osc.type = 'square'; osc.frequency.setValueAtTime(400, now);
                    gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                    break;
                case 'success': // Success chord
                    createOsc(523.25, now, 0.4); createOsc(659.25, now, 0.4); createOsc(783.99, now, 0.4); // C Major
                    break;
                case 'error': // Error buzz
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                    break;
                case 'back':
                     osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(200, now + 0.2);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                    break;
            }
        };

        function createOsc(freq, time, dur) {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.type='sine'; o.frequency.value = freq;
            g.gain.setValueAtTime(0.05, time); g.gain.exponentialRampToValueAtTime(0.001, time + dur);
            o.start(time); o.stop(time + dur);
        }

        // --- GLOBAL STATE ---
        let user = JSON.parse(localStorage.getItem('vx_user')) || { fname:'', lname:'', img:'' };
        let activeCall = localStorage.getItem('vx_call');
        let localStream;
        let peers = {};
        let isHost = false;
        let timerInt;

        // --- PARTICLES GENERATOR ---
        const pCont = document.getElementById('particles');
        for(let i=0; i<20; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random() * 100 + '%';
            p.style.width = Math.random() * 5 + 2 + 'px';
            p.style.height = p.style.width;
            p.style.animationDuration = Math.random() * 10 + 5 + 's';
            p.style.animationDelay = Math.random() * 5 + 's';
            pCont.appendChild(p);
        }

        // --- UTILS ---
        const $ = id => document.getElementById(id);
        const showView = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            $(id).classList.add('active');
            if(id === 'v-room') $('app').classList.add('wide'); else $('app').classList.remove('wide');
        };
        const toast = (msg, icon, color='var(--primary)') => {
            $('t-msg').innerText = msg;
            $('t-icon').innerHTML = `<i class="fas fa-${icon}" style="color:${color}; font-size:1.2rem;"></i>`;
            $('toast').classList.add('show');
            playTone('select');
            setTimeout(() => $('toast').classList.remove('show'), 3000);
        };
        const modal = (title, text, btns, icon, color) => {
            $('m-title').innerText = title; $('m-text').innerText = text;
            $('m-btns').innerHTML = btns; $('m-icon').className = `fas fa-${icon}`; $('m-icon').style.color = color;
            $('modal').classList.add('show');
        };
        window.closeModal = () => { $('modal').classList.remove('show'); playTone('back'); };

        // --- REGISTRATION LOGIC ---
        window.toStep2 = () => {
            if(!$('fname').value || !$('lname').value) { playTone('error'); return toast('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…', 'exclamation-triangle', 'var(--danger)'); }
            user.fname = $('fname').value; user.lname = $('lname').value;
            showView('v-avatar');
            playTone('next');
        };

        // IMAGE HANDLING (FIXED)
        window.triggerUpload = () => $('file-upl').click();
        
        $('file-upl').onchange = (e) => {
            const f = e.target.files[0];
            if(f) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = $('canvas-processor');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 150; canvas.height = 150;
                        ctx.drawImage(img, 0, 0, 150, 150);
                        user.img = canvas.toDataURL('image/jpeg', 0.8);
                        
                        // UI Update
                        $('preview-img').src = user.img;
                        $('preview-img').style.display = 'block';
                        $('avatar-box').classList.add('has-img');
                        playTone('success');
                        
                        // Deselect presets
                        document.querySelectorAll('.preset-item').forEach(el => el.classList.remove('selected'));
                    }
                    img.src = ev.target.result;
                }
                reader.readAsDataURL(f);
            }
        };

        // PRESET AVATAR LOGIC
        window.selectPreset = (emoji) => {
            playTone('select');
            // Create image from emoji via Canvas
            const canvas = $('canvas-processor');
            const ctx = canvas.getContext('2d');
            canvas.width = 150; canvas.height = 150;
            
            // Background
            ctx.fillStyle = "#2d3436"; 
            ctx.fillRect(0,0,150,150);
            
            // Emoji
            ctx.font = "100px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(emoji, 75, 80);
            
            user.img = canvas.toDataURL('image/jpeg', 0.8);

            // UI Update
            $('preview-img').src = user.img;
            $('preview-img').style.display = 'block';
            $('avatar-box').classList.add('has-img');
            
            // Highlight selection
            document.querySelectorAll('.preset-item').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
        };

        window.finishRegister = () => {
            if(!user.img || !$('terms').checked) { playTone('error'); return toast('Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø·Ù„ÙˆØ¨Ø©', 'ban', 'var(--danger)'); }
            if(!user.id) user.id = 'u_' + Date.now().toString(36);
            localStorage.setItem('vx_user', JSON.stringify(user));
            
            // Save to DB (Optional but good for presence)
            set(ref(db, `users/${user.id}`), user);

            const params = new URLSearchParams(location.search);
            if(params.get('call')) joinRoom(params.get('call'));
            else initDash();
            
            playTone('success');
        };

        // --- DASHBOARD ---
        function initDash() {
            $('dash-name').innerText = user.fname;
            $('dash-img').src = user.img;
            showView('v-dash');
            if(activeCall) {
                get(ref(db, `calls/${activeCall}`)).then(s => {
                    if(s.exists()) $('rejoin-banner').style.display = 'block';
                    else localStorage.removeItem('vx_call');
                });
            }
        }

        window.rejoin = () => joinRoom(activeCall, true);

        // --- CALL LOGIC ---
        window.startCall = () => {
            const cid = Date.now().toString(36);
            isHost = true;
            activeCall = cid;
            localStorage.setItem('vx_call', cid);
            set(ref(db, `calls/${cid}`), { host: user.id, status: 'active' });
            // Host joins immediately
            set(ref(db, `calls/${cid}/participants/${user.id}`), { info: user, status: 'joined' })
            .then(() => enterRoom());
            playTone('next');
        };

        window.joinRoom = (cid, isRejoin=false) => {
            activeCall = cid;
            localStorage.setItem('vx_call', cid);
            get(ref(db, `calls/${cid}`)).then(s => {
                if(!s.exists()) { playTone('error'); toast('Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù†ØªÙ‡Øª', 'times'); setTimeout(()=>location.href=location.pathname, 2000); return; }
                const d = s.val();
                isHost = (d.host === user.id);
                
                if(isHost || isRejoin) enterRoom();
                else {
                    // Ask Host logic would go here, skipping to join for simplicity of single file
                    set(ref(db, `calls/${cid}/participants/${user.id}`), { info: user, status: 'joined' })
                    .then(() => enterRoom());
                }
            });
        };

        async function enterRoom() {
            showView('v-room');
            startTimer();
            if(isHost) $('btn-reqs').style.display = 'block';

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                monitorAudio(user.id, localStream);
            } catch(e) { toast('Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ØºÙ„Ù‚', 'microphone-slash', 'var(--danger)'); }

            addCard(user.id, user, true);

            // Listeners
            onValue(ref(db, `calls/${activeCall}/participants`), s => {
                const parts = s.val() || {};
                
                // Remove left
                document.querySelectorAll('.participant').forEach(el => {
                    const uid = el.id.replace('p-', '');
                    if(!parts[uid] || parts[uid].status !== 'joined') {
                        el.remove();
                        if(peers[uid]) { peers[uid].close(); delete peers[uid]; }
                    }
                });

                // Add new
                Object.keys(parts).forEach(uid => {
                    const p = parts[uid];
                    if(p.status === 'joined') {
                        if(!$(`p-${uid}`)) {
                            addCard(uid, p.info, uid === user.id);
                            if(uid !== user.id) initWebRTC(uid);
                        }
                        updateMuteIcon(uid, p.muted);
                    }
                    if(uid === user.id && p.status === 'kicked') kickUserLocally();
                });
            });

            // Call Ended check
            onValue(ref(db, `calls/${activeCall}`), s => {
                if(!s.exists()) leaveCall(true);
            });
        }

        function addCard(uid, info, isMe) {
            if($(`p-${uid}`)) return;
            const grid = $('grid');
            const el = document.createElement('div');
            el.className = 'participant';
            el.id = `p-${uid}`;
            
            let controls = '';
            if(isHost && !isMe) {
                controls = `
                <div class="card-controls">
                    <button class="mini-btn mb-mute" onclick="hostMute('${uid}')"><i class="fas fa-microphone-slash"></i></button>
                    <button class="mini-btn mb-kick" onclick="hostKick('${uid}')"><i class="fas fa-ban"></i></button>
                    <button class="mini-btn" style="background:var(--primary)" onclick="addFriend('${uid}')"><i class="fas fa-user-plus"></i></button>
                </div>`;
            } else if (!isMe) {
                controls = `
                <div class="card-controls">
                    <button class="mini-btn" style="background:var(--primary)" onclick="addFriend('${uid}')"><i class="fas fa-user-plus"></i></button>
                </div>`;
            }

            el.innerHTML = `
                ${controls}
                <img src="${info.img}">
                <span>${isMe ? 'Ø£Ù†Øª' : info.fname}</span>
                <div id="m-icon-${uid}" style="position:absolute; bottom:5px; right:5px; font-size:0.7rem; color:white; background:rgba(0,0,0,0.5); padding:3px; border-radius:50%"><i class="fas fa-microphone"></i></div>
            `;
            grid.appendChild(el);
            playTone('select'); // Pop sound on join
        }

        // --- CONTROLS ---
        window.toggleMic = () => {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            const btn = $('mic-btn');
            if(track.enabled) {
                btn.classList.add('active'); btn.innerHTML = '<i class="fas fa-microphone"></i>';
            } else {
                btn.classList.remove('active'); btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            }
            update(ref(db, `calls/${activeCall}/participants/${user.id}`), { muted: !track.enabled });
            playTone('select');
        };

        function updateMuteIcon(uid, isMuted) {
            const el = $(`m-icon-${uid}`);
            if(el) el.innerHTML = isMuted ? '<i class="fas fa-microphone-slash" style="color:var(--danger)"></i>' : '<i class="fas fa-microphone"></i>';
        }

        window.leaveCall = (forced=false) => {
            if(activeCall && !forced && !isHost) remove(ref(db, `calls/${activeCall}/participants/${user.id}`));
            if(isHost && !forced) {
                // Confirm End All
                modal('Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©', 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ØŸ', 
                `<button class="btn-main" style="width:auto; padding:10px 20px" onclick="destroyCall()">Ù†Ø¹Ù… Ø¥Ù†Ù‡Ø§Ø¡</button>
                 <button class="btn-main" style="width:auto; background:#333; padding:10px 20px" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>`, 
                'power-off', 'var(--danger)');
                return;
            }
            
            if(localStream) localStream.getTracks().forEach(t=>t.stop());
            localStorage.removeItem('vx_call');
            
            if(forced) {
                modal('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©', 'Ù‚Ø§Ù… Ø§Ù„Ù…Ø¶ÙŠÙ Ø¨Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©', `<button class="btn-main" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>`, 'phone-slash', 'var(--danger)');
                playTone('error');
            } else {
                location.reload();
            }
        };

        window.destroyCall = () => {
            remove(ref(db, `calls/${activeCall}`));
            leaveCall(false);
        };

        window.hostKick = (uid) => {
            update(ref(db, `calls/${activeCall}/participants/${uid}`), { status: 'kicked' });
            playTone('error');
        };

        function kickUserLocally() {
            if(localStream) localStream.getTracks().forEach(t=>t.stop());
            localStorage.removeItem('vx_call');
            $('app').innerHTML = `<div style="text-align:center; color:white; margin-top:50%"><i class="fas fa-ban" style="font-size:4rem; color:var(--danger)"></i><h2>ØªÙ… Ø·Ø±Ø¯Ùƒ</h2><button class="btn-main" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button></div>`;
            playTone('error');
        }

        window.copyLink = () => {
            const url = `${location.origin}${location.pathname}?call=${activeCall}`;
            navigator.clipboard.writeText(url);
            toast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·', 'link');
        };

        // --- AUDIO VISUALIZER ---
        function monitorAudio(uid, stream) {
            if(!audioCtx) initAudio();
            const src = audioCtx.createMediaStreamSource(stream);
            const anlz = audioCtx.createAnalyser();
            src.connect(anlz); anlz.fftSize = 32;
            const data = new Uint8Array(anlz.frequencyBinCount);
            const loop = () => {
                const el = $(`p-${uid}`);
                if(!el) return;
                anlz.getByteFrequencyData(data);
                const avg = data.reduce((a,b)=>a+b)/data.length;
                if(avg > 30) el.classList.add('speaking');
                else el.classList.remove('speaking');
                requestAnimationFrame(loop);
            };
            loop();
        }

        // --- WebRTC (Simplified for Single File) ---
        function initWebRTC(rid) {
            if(peers[rid]) return;
            const pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
            peers[rid] = pc;
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            
            pc.onicecandidate = e => { if(e.candidate) push(ref(db, `calls/${activeCall}/signals/${rid}`), {from:user.id, type:'ice', data:JSON.stringify(e.candidate)}); };
            pc.ontrack = e => { 
                const a = new Audio(); a.srcObject = e.streams[0]; a.play(); 
                monitorAudio(rid, e.streams[0]);
            };

            if(user.id < rid) {
                pc.createOffer().then(o=>pc.setLocalDescription(o)).then(()=> {
                    push(ref(db, `calls/${activeCall}/signals/${rid}`), {from:user.id, type:'offer', data:JSON.stringify(pc.localDescription)});
                });
            }

            onValue(ref(db, `calls/${activeCall}/signals/${user.id}`), s => {
                const msgs = s.val(); if(!msgs) return;
                Object.entries(msgs).forEach(([k,m]) => {
                    if(m.from === rid) {
                        if(m.type==='offer') pc.setRemoteDescription(JSON.parse(m.data)).then(()=>pc.createAnswer()).then(a=>pc.setLocalDescription(a)).then(()=>{
                             push(ref(db, `calls/${activeCall}/signals/${rid}`), {from:user.id, type:'answer', data:JSON.stringify(pc.localDescription)});
                             remove(child(ref(db, `calls/${activeCall}/signals/${user.id}`), k));
                        });
                        if(m.type==='answer') pc.setRemoteDescription(JSON.parse(m.data)).then(()=>remove(child(ref(db, `calls/${activeCall}/signals/${user.id}`), k)));
                        if(m.type==='ice') pc.addIceCandidate(JSON.parse(m.data)).then(()=>remove(child(ref(db, `calls/${activeCall}/signals/${user.id}`), k)));
                    }
                });
            });
        }

        function startTimer() {
            let s=0; clearInterval(timerInt);
            timerInt = setInterval(() => { s++; $('timer').innerText = new Date(s*1000).toISOString().substr(14,5); }, 1000);
        }

        window.onload = () => {
            if(user.id && user.img) {
                const p = new URLSearchParams(location.search);
                if(p.get('call')) joinRoom(p.get('call'));
                else initDash();
            }
        };
    </script>
</body>
</html>
